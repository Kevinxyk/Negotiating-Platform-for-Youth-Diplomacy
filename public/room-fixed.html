<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç ”è®¨å®¤ - ç ”è®¨ç³»ç»Ÿ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body { 
      padding-top: 70px;
      min-height: 100vh;
    }
    .container { 
      margin-top: 0.5rem;
      padding-top: 0.5rem;
    }
    .navbar { 
      z-index: 1030;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      height: 56px;
    }
    #timerSection { 
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      position: relative;
      z-index: 900;
    }
    .fullscreen {
      position: fixed;
      top: 70px;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 1020;
      padding: 1rem;
      overflow-y: auto;
    }
    /* èŠå¤©æ¶ˆæ¯æ ·å¼ */
    .chat-message {
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
    }
    .chat-message.sent {
      align-items: flex-end;
    }
    .chat-message.received {
      align-items: flex-start;
    }
    .message-bubble {
      max-width: 70%;
      padding: 0.5rem 0.75rem;
      border-radius: 1rem;
      position: relative;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .sent .message-bubble {
      background-color: #007bff;
      color: white;
      border-bottom-right-radius: 0.25rem;
    }
    .received .message-bubble {
      background-color: #f1f0f0;
      color: #212529;
      border-bottom-left-radius: 0.25rem;
    }
    .message-info {
      font-size: 0.75rem;
      color: #6c757d;
      margin: 0.25rem 0;
    }
    .sent .message-info {
      text-align: right;
    }
    #chatMessages {
      padding: 1rem;
      background: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    #messageInput {
      resize: none;
      border-radius: 1.5rem;
      padding: 0.75rem 1rem;
      border: 1px solid #ced4da;
    }
    #messageInput:focus {
      border-color: #80bdff;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    /* è®®ç¨‹ç®¡ç†æ ·å¼ */
    .schedule-item {
      cursor: move;
    }
    .schedule-item.dragging {
      opacity: 0.5;
    }
    .schedule-item .input-group {
      max-width: 200px;
    }
    
    /* æ¶ˆæ¯æ°”æ³¡èœå•æ ·å¼ */
    .message-bubble {
      position: relative;
    }
    .message-actions {
      position: absolute;
      left: -30px;
      bottom: 0;
      display: none;
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 4px;
    }
    .message-bubble:hover .message-actions {
      display: flex;
      gap: 4px;
    }
    .message-actions button {
      padding: 2px 6px;
      font-size: 12px;
      border: none;
      background: none;
      color: #666;
      cursor: pointer;
    }
    .message-actions button:hover {
      color: #007bff;
    }
    .message-actions button.delete {
      color: #dc3545;
    }
    .message-actions button.delete:hover {
      color: #bd2130;
    }
    
    /* Room management button styles */
    .room-controls {
      margin-bottom: 1.5rem;
    }
    
    /* Timer display styles */
    .timer-display {
      font-size: 2rem;
      font-weight: bold;
      color: #333;
      text-align: center;
      margin-bottom: 1rem;
    }
    
    /* ç”¨æˆ·åˆ—è¡¨æ ·å¼ */
    #userList {
      max-height: 200px;
      overflow-y: auto;
    }
    
    #userList .list-group-item {
      border: 1px solid #dee2e6;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      min-width: 200px;
      transition: all 0.2s ease;
    }
    
    #userList .list-group-item:hover {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }
    
    /* è¡¨æƒ…åŒ…é¢æ¿æ ·å¼ */
    #emojiPanel {
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
    }
    
    #emojiGrid {
      max-height: 200px;
      overflow-y: auto;
    }
    
    #emojiGrid .btn {
      transition: all 0.2s ease;
    }
    
    #emojiGrid .btn:hover {
      transform: scale(1.1);
      background-color: #e9ecef;
    }
    
    /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸæ ·å¼ */
    #imageUploadArea {
      z-index: 1000;
    }
    
    #imagePreview {
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 0.5rem;
      background-color: #f8f9fa;
    }
    
    /* æ¶ˆæ¯ä¸­çš„å›¾ç‰‡æ ·å¼ */
    .message-content img {
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }
    
    .message-content img:hover {
      transform: scale(1.05);
    }
    
    /* ç”¨æˆ·çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
    .user-status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
    }
    
    .user-status-online {
      background-color: #28a745;
    }
    
    .user-status-speaking {
      background-color: #007bff;
      animation: pulse 1.5s infinite;
    }
    
    .user-status-raising-hand {
      background-color: #ffc107;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container">
      <a class="navbar-brand" href="/">ç ”è®¨ç³»ç»Ÿ</a>
      <div class="ms-auto">
        <span class="badge bg-primary" id="userRoleDisplay"></span>
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>ç ”è®¨å®¤ï¼š<span id="roomId"></span></h2>
      <div>
        <button id="roomManagementBtn" class="btn btn-primary me-2">
          <i class="bi bi-gear"></i> ç®¡ç†æˆ¿é—´
        </button>
        <button id="deleteRoomBtn" class="btn btn-danger">
          <i class="bi bi-trash"></i> åˆ é™¤æˆ¿é—´
        </button>
      </div>
    </div>
    <!-- å€’è®¡æ—¶åŠŸèƒ½ -->
    <div id="timerSection" class="mb-3">
      <div class="timer-display" id="timerDisplay">--:--</div>
      <div id="timerControls" class="d-flex flex-wrap justify-content-center gap-2">
        <!-- è‡ªå®šä¹‰æ—¶é—´è¾“å…¥ -->
        <div class="d-flex align-items-center mb-2">
          <input type="number" id="timerHours" min="0" placeholder="æ—¶" class="form-control form-control-sm" style="width:60px; margin-right:5px;">
          <span>:</span>
          <input type="number" id="timerMinutes" min="0" max="59" placeholder="åˆ†" class="form-control form-control-sm" style="width:60px; margin-left:5px; margin-right:5px;">
          <span>:</span>
          <input type="number" id="timerSeconds" min="0" max="59" placeholder="ç§’" class="form-control form-control-sm" style="width:60px; margin-left:5px; margin-right:10px;">
        </div>
        <div class="d-flex mb-2">
        <button id="startTimerBtn" class="btn btn-success btn-sm" style="margin-right:5px;">å¼€å§‹</button>
        <button id="pauseTimerBtn" class="btn btn-warning btn-sm" style="margin-right:5px;">æš‚åœ</button>
        <button id="resumeTimerBtn" class="btn btn-primary btn-sm" style="margin-right:5px;">ç»§ç»­</button>
        <button id="resetTimerBtn" class="btn btn-secondary btn-sm">é‡ç½®</button>
        </div>
      </div>
    </div>
    <!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
    <div id="userListContainer" class="mb-3">
      <h5>åœ¨çº¿ç”¨æˆ·</h5>
      <ul id="userList" class="list-group list-group-horizontal flex-wrap"></ul>
    </div>
    <!-- æ–‡æœ¬èŠå¤© -->
    <div id="chatContainer" class="mb-3">
      <h5>ç¾¤èŠ</h5>
      <div id="chatMessages" class="border p-2" style="height:300px; overflow-y:auto;"></div>
      <div class="input-group mt-2">
        <button class="btn btn-outline-secondary" type="button" id="emojiBtn" title="è¡¨æƒ…åŒ…">
          <i class="bi bi-emoji-smile"></i>
        </button>
        <button class="btn btn-outline-secondary" type="button" id="imageBtn" title="æ’å…¥å›¾ç‰‡">
          <i class="bi bi-image"></i>
        </button>
        <textarea id="messageInput" class="form-control" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="3"></textarea>
        <button id="sendBtn" class="btn btn-primary">å‘é€</button>
      </div>
      <!-- è¡¨æƒ…åŒ…é¢æ¿ -->
      <div id="emojiPanel" class="mt-2 p-2 border rounded" style="display: none; background: white;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <small class="text-muted">é€‰æ‹©è¡¨æƒ…åŒ…</small>
          <button type="button" class="btn-close btn-close-sm" id="closeEmojiPanel"></button>
        </div>
        <div id="emojiGrid" class="d-flex flex-wrap gap-1">
          <!-- è¡¨æƒ…åŒ…å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
      </div>
      <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
      <div id="imageUploadArea" class="mt-2 p-2 border rounded" style="display: none; background: white;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <small class="text-muted">æ’å…¥å›¾ç‰‡</small>
          <button type="button" class="btn-close btn-close-sm" id="closeImagePanel"></button>
        </div>
        <div class="mb-2">
          <input type="file" id="imageInput" accept="image/*" class="form-control form-control-sm">
        </div>
        <div id="imagePreview" class="text-center" style="display: none;">
          <img id="previewImg" class="img-fluid rounded" style="max-height: 200px;">
        </div>
        <div class="d-flex gap-2 mt-2">
          <button type="button" class="btn btn-primary btn-sm" id="insertImageBtn">æ’å…¥å›¾ç‰‡</button>
          <button type="button" class="btn btn-secondary btn-sm" id="cancelImageBtn">å–æ¶ˆ</button>
        </div>
      </div>
      <div class="mt-2">
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="sendMode" id="sendModeEnter" value="enter" checked>
          <label class="form-check-label" for="sendModeEnter">Enter å‘é€</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="sendMode" id="sendModeCtrlEnter" value="ctrlEnter">
          <label class="form-check-label" for="sendModeCtrlEnter">Ctrl+Enter å‘é€</label>
        </div>
      </div>
    </div>
    <!-- ä¸¾æ‰‹åŠŸèƒ½ -->
    <div class="mb-3">
      <button id="raiseHandBtn" class="btn btn-warning">ä¸¾æ‰‹</button>
    </div>
    <!-- ä¸¾æ‰‹é€šçŸ¥ -->
    <div id="raiseNotifications" class="mt-3"></div>
    <!-- è¯­éŸ³èŠå¤© -->
    <div id="audioChatContainer" class="mb-3">
      <h5>è¯­éŸ³èŠå¤©</h5>
      <div class="mb-2">
        <button id="startAudioBtn" class="btn btn-success me-2">å¼€å§‹è¯­éŸ³</button>
        <button id="stopAudioBtn" class="btn btn-danger" style="display:none;">åœæ­¢è¯­éŸ³</button>
      </div>
      <div id="audioParticipants" class="list-group"></div>
    </div>
  </div>

  <!-- æ¶ˆæ¯æ¨¡æ¿ -->
  <template id="messageTemplate">
    <div class="chat-message">
      <div class="message-bubble">
        <div class="message-content"></div>
        <div class="message-info">
          <span class="message-sender"></span>
          <span class="message-time"></span>
        </div>
      </div>
    </div>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    // å£°æ˜å…¨å±€WebSocketå˜é‡
    let ws;
    
    (async function() {
      // æ£€æŸ¥è®¤è¯çŠ¶æ€
      if (!window.auth.checkAuth()) {
        return;
      }

      // æå– roomId
      const parts = window.location.pathname.split('/');
      const roomId = parts[2] || '';
      const titleEl = document.getElementById('roomId');
      const container = document.querySelector('.container');
      
      // è·å–ç”¨æˆ·ä¿¡æ¯
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      // æ˜¾ç¤ºç”¨æˆ·è§’è‰²
      const roleDisplay = document.getElementById('userRoleDisplay');
      const roleMap = {
        'host': 'ä¸»æŒäºº',
        'admin': 'ç®¡ç†å‘˜',
        'sys': 'ç³»ç»Ÿç®¡ç†å‘˜',
        'delegate': 'ä»£è¡¨',
        'observer': 'è§‚å¯Ÿè€…'
      };
      roleDisplay.textContent = roleMap[user.role] || user.role;

      // è¯·æ±‚æˆ¿é—´ä¿¡æ¯
      try {
        const res = await fetch(`/api/rooms/${encodeURIComponent(roomId)}`, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          }
        });

        if (res.status === 404) {
          document.title = 'ç ”è®¨å®¤ä¸å­˜åœ¨';
          container.innerHTML = `
            <div class="alert alert-danger mt-4">
              <h4>ç ”è®¨å®¤ä¸å­˜åœ¨</h4>
              <p>æ‚¨è®¿é—®çš„ç ”è®¨å®¤ (ID: ${roomId}) ä¸å­˜åœ¨ã€‚</p>
              <div class="mt-3">
                ${window.auth.checkRole(['host', 'admin', 'sys']) ? 
                  '<a href="/rooms/create" class="btn btn-success me-2">åˆ›å»ºæ–°ç ”è®¨å®¤</a>' : ''}
                <a href="/rooms" class="btn btn-secondary">è¿”å›æˆ‘çš„ç ”è®¨å®¤</a>
              </div>
            </div>
          `;
          return;
        }

        const room = await res.json();
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯æˆ¿é—´å‚ä¸è€…
        if (!room.participants.some(p => p.userId === user.userId)) {
          container.innerHTML = `
            <div class="alert alert-warning mt-4">
              <h4>æœªåŠ å…¥ç ”è®¨å®¤</h4>
              <p>æ‚¨éœ€è¦å…ˆåŠ å…¥æ­¤ç ”è®¨å®¤æ‰èƒ½è®¿é—®ã€‚</p>
              <button class="btn btn-primary" onclick="joinRoom('${roomId}')">åŠ å…¥ç ”è®¨å®¤</button>
            </div>
          `;
          return;
        }

        // æ˜¾ç¤ºæˆ¿é—´è¯¦æƒ…
        document.title = `ç ”è®¨å®¤ - ${room.name}`;
        titleEl.textContent = `${room.name} (${room.id})`;
        
        // æ ¹æ®ç”¨æˆ·è§’è‰²æ›´æ–°UI
        window.auth.updateUIByRole();
        
        // åˆå§‹åŒ– WebSocket è¿æ¥
        ws = new WebSocket((location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host);
        ws.binaryType = 'arraybuffer';
        ws.addEventListener('open', () => {
          ws.send(JSON.stringify({
            type: 'join',
            token: localStorage.getItem('token'),
            room: roomId,
            name: user.username,
            role: user.role,
            country: user.country || ''
          }));
        });
        
        // å¤„ç† WebSocket æ¶ˆæ¯
        ws.addEventListener('message', event => {
          try {
            // æ£€æŸ¥æ˜¯å¦æ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼ˆéŸ³é¢‘ï¼‰
            if (event.data instanceof ArrayBuffer) {
              // å¤„ç†éŸ³é¢‘æ•°æ®
              handleAudioData(event.data);
              return;
            }
            
            // å°è¯•è§£æJSONæ•°æ®
            const data = JSON.parse(event.data);
            
            console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', data);
            
            switch (data.type) {
              case 'timer':
                updateTimerDisplay(data.time);
                break;
              case 'userList':
                updateUserList(data.users);
                break;
              case 'chat':
                addChatMessage(data.fromName, data.content, data.timestamp, data.id);
                break;
              case 'system':
                addSystemMessage(data.message);
                break;
              case 'raiseHand':
                handleRaiseHand(data.from, data.timestamp);
                break;
            }
          } catch (e) {
            console.error('å¤„ç†WebSocketæ¶ˆæ¯é”™è¯¯:', e);
          }
        });
        
        // å‘é€èŠå¤©æ¶ˆæ¯
        document.getElementById('sendBtn').addEventListener('click', () => {
          sendChatMessage();
        });
        
        document.getElementById('messageInput').addEventListener('keydown', e => {
          const sendMode = document.querySelector('input[name="sendMode"]:checked').value;
          if ((sendMode === 'enter' && e.key === 'Enter' && !e.shiftKey) ||
              (sendMode === 'ctrlEnter' && e.key === 'Enter' && e.ctrlKey)) {
            e.preventDefault();
            sendChatMessage();
          }
        });
        
        let editingMessage = null;

        // æ·»åŠ å‘é€æ¶ˆæ¯å‡½æ•°
        function sendChatMessage() {
          const messageInput = document.getElementById('messageInput');
          const message = messageInput.value.trim();

          if (!message) return;

          console.log('å‘é€æ¶ˆæ¯:', message);
          
          // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
          ws.send(JSON.stringify({
            type: 'chat',
            content: message
          }));

          // æ¸…ç©ºè¾“å…¥æ¡†
          messageInput.value = '';
        }
        
        // æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°ç•Œé¢
        function addChatMessage(sender, content, timestamp, messageId) {
          const messagesContainer = document.getElementById('chatMessages');
          const msgTemplate = document.getElementById('messageTemplate');
          
          if (!messagesContainer || !msgTemplate) {
            console.error('æ‰¾ä¸åˆ°èŠå¤©å®¹å™¨æˆ–æ¶ˆæ¯æ¨¡æ¿');
            return;
          }
          
          const msgNode = document.importNode(msgTemplate.content, true);
          const msgElement = msgNode.querySelector('.chat-message');
          const messageContent = msgElement.querySelector('.message-content');
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡æ¶ˆæ¯
          if (content.includes('[å›¾ç‰‡](') && content.includes(')')) {
            // æå–å›¾ç‰‡URL
            const imageUrlMatch = content.match(/\[å›¾ç‰‡\]\((.*?)\)/);
            if (imageUrlMatch) {
              const imageUrl = imageUrlMatch[1];
              messageContent.innerHTML = `<img src="${imageUrl}" class="img-fluid rounded" style="max-width: 300px; max-height: 200px;" alt="å›¾ç‰‡">`;
            } else {
              messageContent.textContent = content;
            }
          } else {
            // æ™®é€šæ–‡æœ¬æ¶ˆæ¯
            messageContent.textContent = content;
          }
          
          msgElement.querySelector('.message-sender').textContent = sender;
          msgElement.querySelector('.message-time').textContent = formatTime(new Date(timestamp));
          
          // è®¾ç½®æ¶ˆæ¯æ ·å¼ï¼ˆå‘é€æ–¹/æ¥æ”¶æ–¹ï¼‰
          const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
          if (sender === currentUser.username) {
            msgElement.classList.add('sent');
          } else {
            msgElement.classList.add('received');
          }
          
          // æ·»åŠ æ¶ˆæ¯ID
          if (messageId) {
            msgElement.dataset.messageId = messageId;
          }
          
          // æ·»åŠ åˆ°èŠå¤©çª—å£
          messagesContainer.appendChild(msgNode);
          
          // æ»šåŠ¨åˆ°åº•éƒ¨
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(message) {
          const messagesContainer = document.getElementById('chatMessages');
          
          const systemMsg = document.createElement('div');
          systemMsg.className = 'text-center my-2';
          
          const alert = document.createElement('div');
          alert.className = 'alert alert-secondary d-inline-block py-1 px-2';
          alert.style.fontSize = '0.85rem';
          alert.textContent = message;
          
          systemMsg.appendChild(alert);
          messagesContainer.appendChild(systemMsg);
          
          // æ»šåŠ¨åˆ°åº•éƒ¨
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
          return date.toLocaleTimeString('zh-CN', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });
        }
        
        // å¤„ç†ä¸¾æ‰‹
        function handleRaiseHand(from, timestamp) {
          const notifications = document.getElementById('raiseNotifications');
          const notification = document.createElement('div');
          notification.className = 'alert alert-warning alert-dismissible fade show';
          notification.innerHTML = `
            <strong>${from}</strong> ä¸¾æ‰‹äº†
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          notifications.appendChild(notification);
          
          // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 5000);
        }
        
        // ä¸¾æ‰‹æŒ‰é’®äº‹ä»¶
        document.getElementById('raiseHandBtn').addEventListener('click', () => {
          ws.send(JSON.stringify({ type: 'raiseHand' }));
        });
        
        // è¡¨æƒ…åŒ…åŠŸèƒ½
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const emojiGrid = document.getElementById('emojiGrid');
        const closeEmojiPanel = document.getElementById('closeEmojiPanel');
        const messageInput = document.getElementById('messageInput');
        
        // è¡¨æƒ…åŒ…åˆ—è¡¨
        const emojis = ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 
                       'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š',
                       'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©',
                       'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£',
                       'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬',
                       'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—',
                       'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§',
                       'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤', 'ğŸ¥´', 'ğŸ¤¢',
                       'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ’©', 'ğŸ‘»', 'ğŸ’€',
                       'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½',
                       'ğŸ™€', 'ğŸ˜¿', 'ğŸ˜¾', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ‘¶', 'ğŸ‘§', 'ğŸ§’', 'ğŸ‘¦',
                       'ğŸ‘©', 'ğŸ§‘', 'ğŸ‘¨', 'ğŸ‘µ', 'ğŸ§“', 'ğŸ‘´', 'ğŸ‘®â€â™€ï¸', 'ğŸ‘®', 'ğŸ‘®â€â™‚ï¸', 'ğŸ•µï¸â€â™€ï¸',
                       'ğŸ•µï¸', 'ğŸ•µï¸â€â™‚ï¸', 'ğŸ’‚â€â™€ï¸', 'ğŸ’‚', 'ğŸ’‚â€â™‚ï¸', 'ğŸ‘·â€â™€ï¸', 'ğŸ‘·', 'ğŸ‘·â€â™‚ï¸', 'ğŸ¤´', 'ğŸ‘¸',
                       'ğŸ‘³â€â™€ï¸', 'ğŸ‘³', 'ğŸ‘³â€â™‚ï¸', 'ğŸ‘²', 'ğŸ§•', 'ğŸ¤µ', 'ğŸ‘°', 'ğŸ¤°', 'ğŸ¤±', 'ğŸ‘¼',
                       'ğŸ…', 'ğŸ¤¶', 'ğŸ§™â€â™€ï¸', 'ğŸ§™', 'ğŸ§™â€â™‚ï¸', 'ğŸ§â€â™€ï¸', 'ğŸ§', 'ğŸ§â€â™‚ï¸', 'ğŸ§›â€â™€ï¸', 'ğŸ§›',
                       'ğŸ§›â€â™‚ï¸', 'ğŸ§Ÿâ€â™€ï¸', 'ğŸ§Ÿ', 'ğŸ§Ÿâ€â™‚ï¸', 'ğŸ§â€â™€ï¸', 'ğŸ§', 'ğŸ§â€â™‚ï¸', 'ğŸ§œâ€â™€ï¸', 'ğŸ§œ', 'ğŸ§œâ€â™‚ï¸',
                       'ğŸ§šâ€â™€ï¸', 'ğŸ§š', 'ğŸ§šâ€â™‚ï¸', 'ğŸ‘¼', 'ğŸ¤°', 'ğŸ¤±', 'ğŸ‘¼', 'ğŸ…', 'ğŸ¤¶', 'ğŸ§™â€â™€ï¸', 'ğŸ§™'];
        
        // åˆå§‹åŒ–è¡¨æƒ…åŒ…é¢æ¿
        function initEmojiPanel() {
          emojiGrid.innerHTML = '';
          emojis.forEach(emoji => {
            const emojiBtn = document.createElement('button');
            emojiBtn.className = 'btn btn-outline-secondary btn-sm';
            emojiBtn.style.fontSize = '1.2rem';
            emojiBtn.style.padding = '0.25rem 0.5rem';
            emojiBtn.textContent = emoji;
            emojiBtn.title = emoji;
            
            emojiBtn.addEventListener('click', () => {
              const cursorPos = messageInput.selectionStart;
              const textBefore = messageInput.value.substring(0, cursorPos);
              const textAfter = messageInput.value.substring(cursorPos);
              messageInput.value = textBefore + emoji + textAfter;
              messageInput.focus();
              messageInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
            });
            
            emojiGrid.appendChild(emojiBtn);
          });
        }

        // è¡¨æƒ…åŒ…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        emojiBtn.addEventListener('click', () => {
          if (emojiPanel.style.display === 'none') {
            emojiPanel.style.display = 'block';
            imageUploadArea.style.display = 'none';
            initEmojiPanel();
          } else {
            emojiPanel.style.display = 'none';
          }
        });

        // å…³é—­è¡¨æƒ…åŒ…é¢æ¿
        closeEmojiPanel.addEventListener('click', () => {
          emojiPanel.style.display = 'none';
        });

        // å›¾ç‰‡æ’å…¥åŠŸèƒ½
        const imageBtn = document.getElementById('imageBtn');
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const insertImageBtn = document.getElementById('insertImageBtn');
        const cancelImageBtn = document.getElementById('cancelImageBtn');
        const closeImagePanel = document.getElementById('closeImagePanel');

        let selectedImageFile = null;

        // å›¾ç‰‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        imageBtn.addEventListener('click', () => {
          if (imageUploadArea.style.display === 'none') {
            imageUploadArea.style.display = 'block';
            emojiPanel.style.display = 'none';
          } else {
            imageUploadArea.style.display = 'none';
          }
        });

        // å…³é—­å›¾ç‰‡é¢æ¿
        closeImagePanel.addEventListener('click', () => {
          imageUploadArea.style.display = 'none';
        });

        // å›¾ç‰‡æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        imageInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file && file.type.startsWith('image/')) {
            selectedImageFile = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              previewImg.src = e.target.result;
              imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
          }
        });

        // æ’å…¥å›¾ç‰‡æŒ‰é’®äº‹ä»¶
        insertImageBtn.addEventListener('click', async () => {
          if (!selectedImageFile) {
            alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
            return;
          }

          try {
            const formData = new FormData();
            formData.append('image', selectedImageFile);
            formData.append('roomId', roomId);

            const response = await fetch('/api/images/upload', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
              },
              body: formData
            });

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.error || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
            }

            const result = await response.json();
            
            // å‘é€å›¾ç‰‡æ¶ˆæ¯
            ws.send(JSON.stringify({
              type: 'chat',
              content: `[å›¾ç‰‡](${result.imageUrl})`,
              imageUrl: result.imageUrl
            }));

            // é‡ç½®å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ
            imageInput.value = '';
            imagePreview.style.display = 'none';
            selectedImageFile = null;
            imageUploadArea.style.display = 'none';

          } catch (error) {
            alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message);
          }
        });

        // å–æ¶ˆå›¾ç‰‡æŒ‰é’®äº‹ä»¶
        cancelImageBtn.addEventListener('click', () => {
          imageInput.value = '';
          imagePreview.style.display = 'none';
          selectedImageFile = null;
          imageUploadArea.style.display = 'none';
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­é¢æ¿
        document.addEventListener('click', (e) => {
          if (!emojiBtn.contains(e.target) && !emojiPanel.contains(e.target)) {
            emojiPanel.style.display = 'none';
          }
          if (!imageBtn.contains(e.target) && !imageUploadArea.contains(e.target)) {
            imageUploadArea.style.display = 'none';
          }
        });

        // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
        function updateUserList(users) {
          const userList = document.getElementById('userList');
          if (!userList) return;
          
          userList.innerHTML = '';
          
          users.forEach(user => {
            const userItem = document.createElement('li');
            userItem.className = 'list-group-item d-flex align-items-center';
            
            // ç”¨æˆ·çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusIndicator = document.createElement('span');
            statusIndicator.className = 'user-status-indicator user-status-online';
            
            // ç”¨æˆ·ä¿¡æ¯
            const userInfo = document.createElement('div');
            userInfo.className = 'flex-grow-1 ms-2';
            
            const userName = document.createElement('strong');
            userName.textContent = user.name;
            
            const userDetails = document.createElement('small');
            userDetails.className = 'text-muted d-block';
            userDetails.textContent = `${user.role} | ${user.country || 'æœªçŸ¥'}`;
            
            userInfo.appendChild(userName);
            userInfo.appendChild(userDetails);
            
            // ä¸¾æ‰‹çŠ¶æ€
            if (user.isRaisingHand) {
              const raiseHandIcon = document.createElement('i');
              raiseHandIcon.className = 'bi bi-hand-index text-warning ms-2';
              raiseHandIcon.title = 'æ­£åœ¨ä¸¾æ‰‹';
              userItem.appendChild(raiseHandIcon);
            }
            
            // å‘è¨€çŠ¶æ€
            if (user.isSpeaking) {
              const speakingIcon = document.createElement('i');
              speakingIcon.className = 'bi bi-mic-fill text-primary ms-2';
              speakingIcon.title = 'æ­£åœ¨å‘è¨€';
              userItem.appendChild(speakingIcon);
            }
            
            userItem.appendChild(statusIndicator);
            userItem.appendChild(userInfo);
            userList.appendChild(userItem);
          });
        }

        // å€’è®¡æ—¶åŠŸèƒ½
        let timerInterval = null;
        let timerRunning = false;
        let remainingTime = 0;

        // å¼€å§‹å€’è®¡æ—¶
        document.getElementById('startTimerBtn').addEventListener('click', () => {
          const hours = parseInt(document.getElementById('timerHours').value) || 0;
          const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
          const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
          
          const totalSeconds = hours * 3600 + minutes * 60 + seconds;
          if (totalSeconds <= 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´');
            return;
          }
          
          remainingTime = totalSeconds;
          timerRunning = true;
          updateTimerDisplay(remainingTime);
          
          timerInterval = setInterval(() => {
            remainingTime--;
            updateTimerDisplay(remainingTime);
            
            if (remainingTime <= 0) {
              clearInterval(timerInterval);
              timerRunning = false;
              alert('æ—¶é—´åˆ°ï¼');
            }
          }, 1000);
          
          // å‘é€åˆ°æœåŠ¡å™¨
          ws.send(JSON.stringify({ type: 'timer', action: 'start', time: totalSeconds }));
        });

        // æš‚åœå€’è®¡æ—¶
        document.getElementById('pauseTimerBtn').addEventListener('click', () => {
          if (timerRunning) {
            clearInterval(timerInterval);
            timerRunning = false;
            ws.send(JSON.stringify({ type: 'timer', action: 'pause' }));
          }
        });

        // ç»§ç»­å€’è®¡æ—¶
        document.getElementById('resumeTimerBtn').addEventListener('click', () => {
          if (!timerRunning && remainingTime > 0) {
            timerRunning = true;
            timerInterval = setInterval(() => {
              remainingTime--;
              updateTimerDisplay(remainingTime);
              
              if (remainingTime <= 0) {
                clearInterval(timerInterval);
                timerRunning = false;
                alert('æ—¶é—´åˆ°ï¼');
              }
            }, 1000);
            ws.send(JSON.stringify({ type: 'timer', action: 'resume' }));
          }
        });

        // é‡ç½®å€’è®¡æ—¶
        document.getElementById('resetTimerBtn').addEventListener('click', () => {
          clearInterval(timerInterval);
          timerRunning = false;
          remainingTime = 0;
          updateTimerDisplay(0);
          ws.send(JSON.stringify({ type: 'timer', action: 'reset' }));
        });

        // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
        function updateTimerDisplay(seconds) {
          const hours = Math.floor(seconds / 3600);
          const minutes = Math.floor((seconds % 3600) / 60);
          const secs = seconds % 60;
          
          const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
          document.getElementById('timerDisplay').textContent = display;
        }

        // éŸ³é¢‘å¤„ç†å‡½æ•°
        function handleAudioData(audioData) {
          // å¤„ç†éŸ³é¢‘æ•°æ®çš„é€»è¾‘
          console.log('æ”¶åˆ°éŸ³é¢‘æ•°æ®:', audioData.byteLength, 'bytes');
        }

        // è¯­éŸ³èŠå¤©åŠŸèƒ½
        let mediaRecorder = null;
        let audioChunks = [];

        document.getElementById('startAudioBtn').addEventListener('click', async () => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = (event) => {
              audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = () => {
              const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
              // å‘é€éŸ³é¢‘æ•°æ®åˆ°æœåŠ¡å™¨
              ws.send(audioBlob);
              audioChunks = [];
            };
            
            mediaRecorder.start();
            document.getElementById('startAudioBtn').style.display = 'none';
            document.getElementById('stopAudioBtn').style.display = 'inline-block';
            
          } catch (error) {
            console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
            alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
          }
        });

        document.getElementById('stopAudioBtn').addEventListener('click', () => {
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            document.getElementById('startAudioBtn').style.display = 'inline-block';
            document.getElementById('stopAudioBtn').style.display = 'none';
          }
        });

      } catch (error) {
        console.error('åˆå§‹åŒ–é”™è¯¯:', error);
        alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
      }
    })();
  </script>
</body>
</html>