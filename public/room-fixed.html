<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>研讨室 - 研讨系统</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body { 
      padding-top: 70px;
      min-height: 100vh;
    }
    .container { 
      margin-top: 0.5rem;
      padding-top: 0.5rem;
    }
    .navbar { 
      z-index: 1030;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      height: 56px;
    }
    #timerSection { 
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      position: relative;
      z-index: 900;
    }
    .fullscreen {
      position: fixed;
      top: 70px;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 1020;
      padding: 1rem;
      overflow-y: auto;
    }
    /* 聊天消息样式 */
    .chat-message {
      margin-bottom: 0.5rem;
      display: flex;
      flex-direction: column;
    }
    .chat-message.sent {
      align-items: flex-end;
    }
    .chat-message.received {
      align-items: flex-start;
    }
    .message-bubble {
      max-width: 70%;
      padding: 0.5rem 0.75rem;
      border-radius: 1rem;
      position: relative;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .sent .message-bubble {
      background-color: #007bff;
      color: white;
      border-bottom-right-radius: 0.25rem;
    }
    .received .message-bubble {
      background-color: #f1f0f0;
      color: #212529;
      border-bottom-left-radius: 0.25rem;
    }
    .message-info {
      font-size: 0.75rem;
      color: #6c757d;
      margin: 0.25rem 0;
    }
    .sent .message-info {
      text-align: right;
    }
    #chatMessages {
      padding: 1rem;
      background: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    #messageInput {
      resize: none;
      border-radius: 1.5rem;
      padding: 0.75rem 1rem;
      border: 1px solid #ced4da;
    }
    #messageInput:focus {
      border-color: #80bdff;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    /* 议程管理样式 */
    .schedule-item {
      cursor: move;
    }
    .schedule-item.dragging {
      opacity: 0.5;
    }
    .schedule-item .input-group {
      max-width: 200px;
    }
    
    /* 消息气泡菜单样式 */
    .message-bubble {
      position: relative;
    }
    .message-actions {
      position: absolute;
      left: -30px;
      bottom: 0;
      display: none;
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 4px;
    }
    .message-bubble:hover .message-actions {
      display: flex;
      gap: 4px;
    }
    .message-actions button {
      padding: 2px 6px;
      font-size: 12px;
      border: none;
      background: none;
      color: #666;
      cursor: pointer;
    }
    .message-actions button:hover {
      color: #007bff;
    }
    .message-actions button.delete {
      color: #dc3545;
    }
    .message-actions button.delete:hover {
      color: #bd2130;
    }
    
    /* Room management button styles */
    .room-controls {
      margin-bottom: 1.5rem;
    }
    
    /* Timer display styles */
    .timer-display {
      font-size: 2rem;
      font-weight: bold;
      color: #333;
      text-align: center;
      margin-bottom: 1rem;
    }
    
    /* 用户列表样式 */
    #userList {
      max-height: 200px;
      overflow-y: auto;
    }
    
    #userList .list-group-item {
      border: 1px solid #dee2e6;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      min-width: 200px;
      transition: all 0.2s ease;
    }
    
    #userList .list-group-item:hover {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transform: translateY(-1px);
    }
    
    /* 表情包面板样式 */
    #emojiPanel {
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
    }
    
    #emojiGrid {
      max-height: 200px;
      overflow-y: auto;
    }
    
    #emojiGrid .btn {
      transition: all 0.2s ease;
    }
    
    #emojiGrid .btn:hover {
      transform: scale(1.1);
      background-color: #e9ecef;
    }
    
    /* 图片上传区域样式 */
    #imageUploadArea {
      z-index: 1000;
    }
    
    #imagePreview {
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 0.5rem;
      background-color: #f8f9fa;
    }
    
    /* 消息中的图片样式 */
    .message-content img {
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }
    
    .message-content img:hover {
      transform: scale(1.05);
    }
    
    /* 用户状态指示器样式 */
    .user-status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
    }
    
    .user-status-online {
      background-color: #28a745;
    }
    
    .user-status-speaking {
      background-color: #007bff;
      animation: pulse 1.5s infinite;
    }
    
    .user-status-raising-hand {
      background-color: #ffc107;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container">
      <a class="navbar-brand" href="/">研讨系统</a>
      <div class="ms-auto">
        <span class="badge bg-primary" id="userRoleDisplay"></span>
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>研讨室：<span id="roomId"></span></h2>
      <div>
        <button id="roomManagementBtn" class="btn btn-primary me-2">
          <i class="bi bi-gear"></i> 管理房间
        </button>
        <button id="deleteRoomBtn" class="btn btn-danger">
          <i class="bi bi-trash"></i> 删除房间
        </button>
      </div>
    </div>
    <!-- 倒计时功能 -->
    <div id="timerSection" class="mb-3">
      <div class="timer-display" id="timerDisplay">--:--</div>
      <div id="timerControls" class="d-flex flex-wrap justify-content-center gap-2">
        <!-- 自定义时间输入 -->
        <div class="d-flex align-items-center mb-2">
          <input type="number" id="timerHours" min="0" placeholder="时" class="form-control form-control-sm" style="width:60px; margin-right:5px;">
          <span>:</span>
          <input type="number" id="timerMinutes" min="0" max="59" placeholder="分" class="form-control form-control-sm" style="width:60px; margin-left:5px; margin-right:5px;">
          <span>:</span>
          <input type="number" id="timerSeconds" min="0" max="59" placeholder="秒" class="form-control form-control-sm" style="width:60px; margin-left:5px; margin-right:10px;">
        </div>
        <div class="d-flex mb-2">
        <button id="startTimerBtn" class="btn btn-success btn-sm" style="margin-right:5px;">开始</button>
        <button id="pauseTimerBtn" class="btn btn-warning btn-sm" style="margin-right:5px;">暂停</button>
        <button id="resumeTimerBtn" class="btn btn-primary btn-sm" style="margin-right:5px;">继续</button>
        <button id="resetTimerBtn" class="btn btn-secondary btn-sm">重置</button>
        </div>
      </div>
    </div>
    <!-- 在线用户列表 -->
    <div id="userListContainer" class="mb-3">
      <h5>在线用户</h5>
      <ul id="userList" class="list-group list-group-horizontal flex-wrap"></ul>
    </div>
    <!-- 文本聊天 -->
    <div id="chatContainer" class="mb-3">
      <h5>群聊</h5>
      <div id="chatMessages" class="border p-2" style="height:300px; overflow-y:auto;"></div>
      <div class="input-group mt-2">
        <button class="btn btn-outline-secondary" type="button" id="emojiBtn" title="表情包">
          <i class="bi bi-emoji-smile"></i>
        </button>
        <button class="btn btn-outline-secondary" type="button" id="imageBtn" title="插入图片">
          <i class="bi bi-image"></i>
        </button>
        <textarea id="messageInput" class="form-control" placeholder="输入消息..." rows="3"></textarea>
        <button id="sendBtn" class="btn btn-primary">发送</button>
      </div>
      <!-- 表情包面板 -->
      <div id="emojiPanel" class="mt-2 p-2 border rounded" style="display: none; background: white;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <small class="text-muted">选择表情包</small>
          <button type="button" class="btn-close btn-close-sm" id="closeEmojiPanel"></button>
        </div>
        <div id="emojiGrid" class="d-flex flex-wrap gap-1">
          <!-- 表情包将在这里动态加载 -->
        </div>
      </div>
      <!-- 图片上传区域 -->
      <div id="imageUploadArea" class="mt-2 p-2 border rounded" style="display: none; background: white;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <small class="text-muted">插入图片</small>
          <button type="button" class="btn-close btn-close-sm" id="closeImagePanel"></button>
        </div>
        <div class="mb-2">
          <input type="file" id="imageInput" accept="image/*" class="form-control form-control-sm">
        </div>
        <div id="imagePreview" class="text-center" style="display: none;">
          <img id="previewImg" class="img-fluid rounded" style="max-height: 200px;">
        </div>
        <div class="d-flex gap-2 mt-2">
          <button type="button" class="btn btn-primary btn-sm" id="insertImageBtn">插入图片</button>
          <button type="button" class="btn btn-secondary btn-sm" id="cancelImageBtn">取消</button>
        </div>
      </div>
      <div class="mt-2">
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="sendMode" id="sendModeEnter" value="enter" checked>
          <label class="form-check-label" for="sendModeEnter">Enter 发送</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="sendMode" id="sendModeCtrlEnter" value="ctrlEnter">
          <label class="form-check-label" for="sendModeCtrlEnter">Ctrl+Enter 发送</label>
        </div>
      </div>
    </div>
    <!-- 举手功能 -->
    <div class="mb-3">
      <button id="raiseHandBtn" class="btn btn-warning">举手</button>
    </div>
    <!-- 举手通知 -->
    <div id="raiseNotifications" class="mt-3"></div>
    <!-- 语音聊天 -->
    <div id="audioChatContainer" class="mb-3">
      <h5>语音聊天</h5>
      <div class="mb-2">
        <button id="startAudioBtn" class="btn btn-success me-2">开始语音</button>
        <button id="stopAudioBtn" class="btn btn-danger" style="display:none;">停止语音</button>
      </div>
      <div id="audioParticipants" class="list-group"></div>
    </div>
  </div>

  <!-- 消息模板 -->
  <template id="messageTemplate">
    <div class="chat-message">
      <div class="message-bubble">
        <div class="message-content"></div>
        <div class="message-info">
          <span class="message-sender"></span>
          <span class="message-time"></span>
        </div>
      </div>
    </div>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    // 声明全局WebSocket变量
    let ws;
    
    (async function() {
      // 检查认证状态
      if (!window.auth.checkAuth()) {
        return;
      }

      // 提取 roomId
      const parts = window.location.pathname.split('/');
      const roomId = parts[2] || '';
      const titleEl = document.getElementById('roomId');
      const container = document.querySelector('.container');
      
      // 获取用户信息
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      // 显示用户角色
      const roleDisplay = document.getElementById('userRoleDisplay');
      const roleMap = {
        'host': '主持人',
        'admin': '管理员',
        'sys': '系统管理员',
        'delegate': '代表',
        'observer': '观察者'
      };
      roleDisplay.textContent = roleMap[user.role] || user.role;

      // 请求房间信息
      try {
        const res = await fetch(`/api/rooms/${encodeURIComponent(roomId)}`, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          }
        });

        if (res.status === 404) {
          document.title = '研讨室不存在';
          container.innerHTML = `
            <div class="alert alert-danger mt-4">
              <h4>研讨室不存在</h4>
              <p>您访问的研讨室 (ID: ${roomId}) 不存在。</p>
              <div class="mt-3">
                ${window.auth.checkRole(['host', 'admin', 'sys']) ? 
                  '<a href="/rooms/create" class="btn btn-success me-2">创建新研讨室</a>' : ''}
                <a href="/rooms" class="btn btn-secondary">返回我的研讨室</a>
              </div>
            </div>
          `;
          return;
        }

        const room = await res.json();
        
        // 检查用户是否是房间参与者
        if (!room.participants.some(p => p.userId === user.userId)) {
          container.innerHTML = `
            <div class="alert alert-warning mt-4">
              <h4>未加入研讨室</h4>
              <p>您需要先加入此研讨室才能访问。</p>
              <button class="btn btn-primary" onclick="joinRoom('${roomId}')">加入研讨室</button>
            </div>
          `;
          return;
        }

        // 显示房间详情
        document.title = `研讨室 - ${room.name}`;
        titleEl.textContent = `${room.name} (${room.id})`;
        
        // 根据用户角色更新UI
        window.auth.updateUIByRole();
        
        // 初始化 WebSocket 连接
        ws = new WebSocket((location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host);
        ws.binaryType = 'arraybuffer';
        ws.addEventListener('open', () => {
          ws.send(JSON.stringify({
            type: 'join',
            token: localStorage.getItem('token'),
            room: roomId,
            name: user.username,
            role: user.role,
            country: user.country || ''
          }));
        });
        
        // 处理 WebSocket 消息
        ws.addEventListener('message', event => {
          try {
            // 检查是否是二进制数据（音频）
            if (event.data instanceof ArrayBuffer) {
              // 处理音频数据
              handleAudioData(event.data);
              return;
            }
            
            // 尝试解析JSON数据
            const data = JSON.parse(event.data);
            
            console.log('收到WebSocket消息:', data);
            
            switch (data.type) {
              case 'timer':
                updateTimerDisplay(data.time);
                break;
              case 'userList':
                updateUserList(data.users);
                break;
              case 'chat':
                addChatMessage(data.fromName, data.content, data.timestamp, data.id);
                break;
              case 'system':
                addSystemMessage(data.message);
                break;
              case 'raiseHand':
                handleRaiseHand(data.from, data.timestamp);
                break;
            }
          } catch (e) {
            console.error('处理WebSocket消息错误:', e);
          }
        });
        
        // 发送聊天消息
        document.getElementById('sendBtn').addEventListener('click', () => {
          sendChatMessage();
        });
        
        document.getElementById('messageInput').addEventListener('keydown', e => {
          const sendMode = document.querySelector('input[name="sendMode"]:checked').value;
          if ((sendMode === 'enter' && e.key === 'Enter' && !e.shiftKey) ||
              (sendMode === 'ctrlEnter' && e.key === 'Enter' && e.ctrlKey)) {
            e.preventDefault();
            sendChatMessage();
          }
        });
        
        let editingMessage = null;

        // 添加发送消息函数
        function sendChatMessage() {
          const messageInput = document.getElementById('messageInput');
          const message = messageInput.value.trim();

          if (!message) return;

          console.log('发送消息:', message);
          
          // 发送消息到服务器
          ws.send(JSON.stringify({
            type: 'chat',
            content: message
          }));

          // 清空输入框
          messageInput.value = '';
        }
        
        // 添加聊天消息到界面
        function addChatMessage(sender, content, timestamp, messageId) {
          const messagesContainer = document.getElementById('chatMessages');
          const msgTemplate = document.getElementById('messageTemplate');
          
          if (!messagesContainer || !msgTemplate) {
            console.error('找不到聊天容器或消息模板');
            return;
          }
          
          const msgNode = document.importNode(msgTemplate.content, true);
          const msgElement = msgNode.querySelector('.chat-message');
          const messageContent = msgElement.querySelector('.message-content');
          
          // 检查是否是图片消息
          if (content.includes('[图片](') && content.includes(')')) {
            // 提取图片URL
            const imageUrlMatch = content.match(/\[图片\]\((.*?)\)/);
            if (imageUrlMatch) {
              const imageUrl = imageUrlMatch[1];
              messageContent.innerHTML = `<img src="${imageUrl}" class="img-fluid rounded" style="max-width: 300px; max-height: 200px;" alt="图片">`;
            } else {
              messageContent.textContent = content;
            }
          } else {
            // 普通文本消息
            messageContent.textContent = content;
          }
          
          msgElement.querySelector('.message-sender').textContent = sender;
          msgElement.querySelector('.message-time').textContent = formatTime(new Date(timestamp));
          
          // 设置消息样式（发送方/接收方）
          const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
          if (sender === currentUser.username) {
            msgElement.classList.add('sent');
          } else {
            msgElement.classList.add('received');
          }
          
          // 添加消息ID
          if (messageId) {
            msgElement.dataset.messageId = messageId;
          }
          
          // 添加到聊天窗口
          messagesContainer.appendChild(msgNode);
          
          // 滚动到底部
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // 添加系统消息
        function addSystemMessage(message) {
          const messagesContainer = document.getElementById('chatMessages');
          
          const systemMsg = document.createElement('div');
          systemMsg.className = 'text-center my-2';
          
          const alert = document.createElement('div');
          alert.className = 'alert alert-secondary d-inline-block py-1 px-2';
          alert.style.fontSize = '0.85rem';
          alert.textContent = message;
          
          systemMsg.appendChild(alert);
          messagesContainer.appendChild(systemMsg);
          
          // 滚动到底部
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // 格式化时间
        function formatTime(date) {
          return date.toLocaleTimeString('zh-CN', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });
        }
        
        // 处理举手
        function handleRaiseHand(from, timestamp) {
          const notifications = document.getElementById('raiseNotifications');
          const notification = document.createElement('div');
          notification.className = 'alert alert-warning alert-dismissible fade show';
          notification.innerHTML = `
            <strong>${from}</strong> 举手了
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          notifications.appendChild(notification);
          
          // 5秒后自动消失
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 5000);
        }
        
        // 举手按钮事件
        document.getElementById('raiseHandBtn').addEventListener('click', () => {
          ws.send(JSON.stringify({ type: 'raiseHand' }));
        });
        
        // 表情包功能
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const emojiGrid = document.getElementById('emojiGrid');
        const closeEmojiPanel = document.getElementById('closeEmojiPanel');
        const messageInput = document.getElementById('messageInput');
        
        // 表情包列表
        const emojis = ['😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇', 
                       '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚',
                       '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩',
                       '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣',
                       '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬',
                       '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗',
                       '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😯', '😦', '😧',
                       '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐', '🥴', '🤢',
                       '🤮', '🤧', '😷', '🤒', '🤕', '🤑', '🤠', '💩', '👻', '💀',
                       '☠️', '👽', '👾', '🤖', '😺', '😸', '😹', '😻', '😼', '😽',
                       '🙀', '😿', '😾', '🙈', '🙉', '🙊', '👶', '👧', '🧒', '👦',
                       '👩', '🧑', '👨', '👵', '🧓', '👴', '👮‍♀️', '👮', '👮‍♂️', '🕵️‍♀️',
                       '🕵️', '🕵️‍♂️', '💂‍♀️', '💂', '💂‍♂️', '👷‍♀️', '👷', '👷‍♂️', '🤴', '👸',
                       '👳‍♀️', '👳', '👳‍♂️', '👲', '🧕', '🤵', '👰', '🤰', '🤱', '👼',
                       '🎅', '🤶', '🧙‍♀️', '🧙', '🧙‍♂️', '🧝‍♀️', '🧝', '🧝‍♂️', '🧛‍♀️', '🧛',
                       '🧛‍♂️', '🧟‍♀️', '🧟', '🧟‍♂️', '🧞‍♀️', '🧞', '🧞‍♂️', '🧜‍♀️', '🧜', '🧜‍♂️',
                       '🧚‍♀️', '🧚', '🧚‍♂️', '👼', '🤰', '🤱', '👼', '🎅', '🤶', '🧙‍♀️', '🧙'];
        
        // 初始化表情包面板
        function initEmojiPanel() {
          emojiGrid.innerHTML = '';
          emojis.forEach(emoji => {
            const emojiBtn = document.createElement('button');
            emojiBtn.className = 'btn btn-outline-secondary btn-sm';
            emojiBtn.style.fontSize = '1.2rem';
            emojiBtn.style.padding = '0.25rem 0.5rem';
            emojiBtn.textContent = emoji;
            emojiBtn.title = emoji;
            
            emojiBtn.addEventListener('click', () => {
              const cursorPos = messageInput.selectionStart;
              const textBefore = messageInput.value.substring(0, cursorPos);
              const textAfter = messageInput.value.substring(cursorPos);
              messageInput.value = textBefore + emoji + textAfter;
              messageInput.focus();
              messageInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
            });
            
            emojiGrid.appendChild(emojiBtn);
          });
        }

        // 表情包按钮点击事件
        emojiBtn.addEventListener('click', () => {
          if (emojiPanel.style.display === 'none') {
            emojiPanel.style.display = 'block';
            imageUploadArea.style.display = 'none';
            initEmojiPanel();
          } else {
            emojiPanel.style.display = 'none';
          }
        });

        // 关闭表情包面板
        closeEmojiPanel.addEventListener('click', () => {
          emojiPanel.style.display = 'none';
        });

        // 图片插入功能
        const imageBtn = document.getElementById('imageBtn');
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const insertImageBtn = document.getElementById('insertImageBtn');
        const cancelImageBtn = document.getElementById('cancelImageBtn');
        const closeImagePanel = document.getElementById('closeImagePanel');

        let selectedImageFile = null;

        // 图片按钮点击事件
        imageBtn.addEventListener('click', () => {
          if (imageUploadArea.style.display === 'none') {
            imageUploadArea.style.display = 'block';
            emojiPanel.style.display = 'none';
          } else {
            imageUploadArea.style.display = 'none';
          }
        });

        // 关闭图片面板
        closeImagePanel.addEventListener('click', () => {
          imageUploadArea.style.display = 'none';
        });

        // 图片文件选择事件
        imageInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file && file.type.startsWith('image/')) {
            selectedImageFile = file;
            
            const reader = new FileReader();
            reader.onload = (e) => {
              previewImg.src = e.target.result;
              imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
          }
        });

        // 插入图片按钮事件
        insertImageBtn.addEventListener('click', async () => {
          if (!selectedImageFile) {
            alert('请先选择图片');
            return;
          }

          try {
            const formData = new FormData();
            formData.append('image', selectedImageFile);
            formData.append('roomId', roomId);

            const response = await fetch('/api/images/upload', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
              },
              body: formData
            });

            if (!response.ok) {
              const error = await response.json();
              throw new Error(error.error || '图片上传失败');
            }

            const result = await response.json();
            
            // 发送图片消息
            ws.send(JSON.stringify({
              type: 'chat',
              content: `[图片](${result.imageUrl})`,
              imageUrl: result.imageUrl
            }));

            // 重置图片上传区域
            imageInput.value = '';
            imagePreview.style.display = 'none';
            selectedImageFile = null;
            imageUploadArea.style.display = 'none';

          } catch (error) {
            alert('图片上传失败: ' + error.message);
          }
        });

        // 取消图片按钮事件
        cancelImageBtn.addEventListener('click', () => {
          imageInput.value = '';
          imagePreview.style.display = 'none';
          selectedImageFile = null;
          imageUploadArea.style.display = 'none';
        });

        // 点击外部关闭面板
        document.addEventListener('click', (e) => {
          if (!emojiBtn.contains(e.target) && !emojiPanel.contains(e.target)) {
            emojiPanel.style.display = 'none';
          }
          if (!imageBtn.contains(e.target) && !imageUploadArea.contains(e.target)) {
            imageUploadArea.style.display = 'none';
          }
        });

        // 更新用户列表
        function updateUserList(users) {
          const userList = document.getElementById('userList');
          if (!userList) return;
          
          userList.innerHTML = '';
          
          users.forEach(user => {
            const userItem = document.createElement('li');
            userItem.className = 'list-group-item d-flex align-items-center';
            
            // 用户状态指示器
            const statusIndicator = document.createElement('span');
            statusIndicator.className = 'user-status-indicator user-status-online';
            
            // 用户信息
            const userInfo = document.createElement('div');
            userInfo.className = 'flex-grow-1 ms-2';
            
            const userName = document.createElement('strong');
            userName.textContent = user.name;
            
            const userDetails = document.createElement('small');
            userDetails.className = 'text-muted d-block';
            userDetails.textContent = `${user.role} | ${user.country || '未知'}`;
            
            userInfo.appendChild(userName);
            userInfo.appendChild(userDetails);
            
            // 举手状态
            if (user.isRaisingHand) {
              const raiseHandIcon = document.createElement('i');
              raiseHandIcon.className = 'bi bi-hand-index text-warning ms-2';
              raiseHandIcon.title = '正在举手';
              userItem.appendChild(raiseHandIcon);
            }
            
            // 发言状态
            if (user.isSpeaking) {
              const speakingIcon = document.createElement('i');
              speakingIcon.className = 'bi bi-mic-fill text-primary ms-2';
              speakingIcon.title = '正在发言';
              userItem.appendChild(speakingIcon);
            }
            
            userItem.appendChild(statusIndicator);
            userItem.appendChild(userInfo);
            userList.appendChild(userItem);
          });
        }

        // 倒计时功能
        let timerInterval = null;
        let timerRunning = false;
        let remainingTime = 0;

        // 开始倒计时
        document.getElementById('startTimerBtn').addEventListener('click', () => {
          const hours = parseInt(document.getElementById('timerHours').value) || 0;
          const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
          const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
          
          const totalSeconds = hours * 3600 + minutes * 60 + seconds;
          if (totalSeconds <= 0) {
            alert('请输入有效的时间');
            return;
          }
          
          remainingTime = totalSeconds;
          timerRunning = true;
          updateTimerDisplay(remainingTime);
          
          timerInterval = setInterval(() => {
            remainingTime--;
            updateTimerDisplay(remainingTime);
            
            if (remainingTime <= 0) {
              clearInterval(timerInterval);
              timerRunning = false;
              alert('时间到！');
            }
          }, 1000);
          
          // 发送到服务器
          ws.send(JSON.stringify({ type: 'timer', action: 'start', time: totalSeconds }));
        });

        // 暂停倒计时
        document.getElementById('pauseTimerBtn').addEventListener('click', () => {
          if (timerRunning) {
            clearInterval(timerInterval);
            timerRunning = false;
            ws.send(JSON.stringify({ type: 'timer', action: 'pause' }));
          }
        });

        // 继续倒计时
        document.getElementById('resumeTimerBtn').addEventListener('click', () => {
          if (!timerRunning && remainingTime > 0) {
            timerRunning = true;
            timerInterval = setInterval(() => {
              remainingTime--;
              updateTimerDisplay(remainingTime);
              
              if (remainingTime <= 0) {
                clearInterval(timerInterval);
                timerRunning = false;
                alert('时间到！');
              }
            }, 1000);
            ws.send(JSON.stringify({ type: 'timer', action: 'resume' }));
          }
        });

        // 重置倒计时
        document.getElementById('resetTimerBtn').addEventListener('click', () => {
          clearInterval(timerInterval);
          timerRunning = false;
          remainingTime = 0;
          updateTimerDisplay(0);
          ws.send(JSON.stringify({ type: 'timer', action: 'reset' }));
        });

        // 更新倒计时显示
        function updateTimerDisplay(seconds) {
          const hours = Math.floor(seconds / 3600);
          const minutes = Math.floor((seconds % 3600) / 60);
          const secs = seconds % 60;
          
          const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
          document.getElementById('timerDisplay').textContent = display;
        }

        // 音频处理函数
        function handleAudioData(audioData) {
          // 处理音频数据的逻辑
          console.log('收到音频数据:', audioData.byteLength, 'bytes');
        }

        // 语音聊天功能
        let mediaRecorder = null;
        let audioChunks = [];

        document.getElementById('startAudioBtn').addEventListener('click', async () => {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = (event) => {
              audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = () => {
              const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
              // 发送音频数据到服务器
              ws.send(audioBlob);
              audioChunks = [];
            };
            
            mediaRecorder.start();
            document.getElementById('startAudioBtn').style.display = 'none';
            document.getElementById('stopAudioBtn').style.display = 'inline-block';
            
          } catch (error) {
            console.error('无法访问麦克风:', error);
            alert('无法访问麦克风，请检查权限设置');
          }
        });

        document.getElementById('stopAudioBtn').addEventListener('click', () => {
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            document.getElementById('startAudioBtn').style.display = 'inline-block';
            document.getElementById('stopAudioBtn').style.display = 'none';
          }
        });

      } catch (error) {
        console.error('初始化错误:', error);
        alert('初始化失败: ' + error.message);
      }
    })();
  </script>
</body>
</html>