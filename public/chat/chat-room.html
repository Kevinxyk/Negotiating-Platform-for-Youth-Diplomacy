<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©å®¤</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            overflow-x: hidden;
        }
        .chat-container {
            display: flex;
            height: 100vh;
            background: #f8f9fa;
        }
        .chat-main { flex: 1; display: flex; flex-direction: column; }
        .chat-header { background: white; padding: 20px; border-bottom: 1px solid #e1e5e9; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 12px; background: #f8f9fa; }
        .message-item { display: flex; align-items: flex-start; margin-bottom: 10px; }
        .message-item.own { flex-direction: row-reverse; }
        .message-item.own .message-content { margin-left: 0; margin-right: 12px; align-items: flex-end; }
        .message-item.own .message-bubble { background-color: #0084ff; color: white; }
        .message-item.own .message-bubble.own { background-color: #0084ff; color: white; }
        .message-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; }
        .message-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: fit-content;
            max-width: 33vw;
            margin-left: 12px;
        }
        .message-header { display: flex; align-items: center; margin-bottom: 2px; }
        .message-name { font-weight: bold; color: #1a1a1a; margin-right: 8px; }
        .message-role { font-size: 12px; padding: 2px 6px; border-radius: 10px; color: white; }
        .message-country { font-size: 12px; color: #666; margin-left: 8px; }
        .message-time { font-size: 12px; color: #999; margin-left: auto; }
        .message-bubble {
            background: white;
            padding: 4px 10px;
            border-radius: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
            word-break: break-word;
            white-space: pre-wrap;
            max-width: 100%;
            display: inline-block;
            margin: 1px 0;
            line-height: 1.5;
            font-size: 15px;
        }
        .message-bubble.own {
            background: #0084ff;
            color: #fff;
        }
        .message-bubble.revoked { background: #f1f3f4; color: #666; font-style: italic; }
        .chat-input { background: white; padding: 20px; border-top: 1px solid #e1e5e9; }
        .input-container { display: flex; gap: 10px; }
        .message-input { 
            flex: 1; 
            padding: 8px 12px; 
            border: 1px solid #ddd; 
            border-radius: 20px; 
            outline: none; 
            font-size: 14px; 
            resize: none;
            min-height: 20px;
            max-height: 100px;
            overflow-y: auto;
            line-height: 1.4;
        }
        .send-btn { padding: 12px 24px; background: #0084ff; color: white; border: none; border-radius: 20px; cursor: pointer; }
        .send-btn:hover { background: #0073e6; }
        .user-sidebar { width: 300px; background: white; border-left: 1px solid #e1e5e9; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #e1e5e9; background: #f8f9fa; }
        .user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 5px; }
        .user-item:hover { background: #f8f9fa; }
        .user-item.speaking { background: #e3f2fd; }
        .user-item.raising-hand { background: #fff3e0; }
        .user-item.muted { background: #ffebee; }
        .user-avatar-small { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; }
        .user-info-small { flex: 1; }
        .user-name-small { font-weight: bold; font-size: 14px; }
        .user-role-small { font-size: 12px; color: #666; }
        .user-status-small { width: 8px; height: 8px; border-radius: 50%; margin-left: 8px; }
        .status-online { background: #4caf50; }
        .status-speaking { background: #2196f3; }
        .status-raising-hand { background: #ff9800; }
        .status-muted { background: #f44336; }
        .emoji-picker {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            width: auto;

        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
        }
        .emoji-item { cursor: pointer; padding: 5px; text-align: center; border-radius: 4px; }
        .emoji-item:hover { background: #f0f0f0; }
        .system-message { text-align: center; color: #666; font-style: italic; margin: 10px 0; }
        .raise-hand-btn { padding: 8px 16px; background: #ff9800; color: white; border: none; border-radius: 16px; cursor: pointer; margin-right: 10px; }
        .raise-hand-btn:hover { background: #f57c00; }
        .raise-hand-btn.active { background: #e65100; }
        .date-divider { text-align: center; color: #888; margin: 16px 0 8px 0; font-size: 14px; }
        .quote-block { background: #f5f5f5; border-left: 3px solid #0084ff; padding: 6px 12px; margin-bottom: 4px; color: #555; font-size: 13px; }
        .time-banner { text-align: center; color: #aaa; font-size: 12px; margin: 4px 0 2px 0; }
        .image-error {
            text-align: center;
            color: #999;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .image-message-container,
        .image-wrapper {
            display: inline-block;
            padding: 0;
            margin: 0;
            background: none;
            border: none;
            box-shadow: none;
            max-width: 160px;
            max-height: 160px;
        }
        .image-overlay {
            display: none;
        }
        .image-icon {
            color: white;
            font-size: 24px;
        }
        .message-image {
            max-width: 160px;
            max-height: 160px;
            width: auto;
            height: auto;
            border-radius: 6px;
            cursor: pointer;
            object-fit: contain;
            display: block;
        }
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
        }
        .image-modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .image-modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        .image-modal-close:hover {
            color: #bbb;
        }
        .message-item.simple-mode.own { flex-direction: row-reverse; }
        .message-item.simple-mode.own .message-bubble { background-color: #0084ff; color: white; margin-left: auto; margin-right: 0; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-main">
            <div class="chat-header">
                <h2>å¤–äº¤è°ˆåˆ¤å¹³å°</h2>
                <p>æˆ¿é—´: <span id="roomName">test-room</span> | åœ¨çº¿: <span id="onlineCount">0</span>äºº</p>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="chat-input">
                <div class="input-container">
                    <button class="raise-hand-btn" id="raiseHandBtn" onclick="raiseHand()">ä¸¾æ‰‹</button>
                    <button class="send-btn" id="emojiBtn" type="button" style="margin-right: 8px;">ğŸ˜€</button>
                    <button class="send-btn" id="imageBtn" type="button" style="margin-right: 8px;">ğŸ–¼ï¸</button>
                    <input type="file" id="imageInput" accept="image/*" style="display:none">
                    <textarea class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleKeyPress(event)"></textarea>
                    <button class="send-btn" onclick="sendMessage()">å‘é€</button>
                </div>
                <!-- è¡¨æƒ…é¢æ¿ -->
                <div id="emojiPanel" class="emoji-picker" style="display:none;position:absolute;z-index:1001;"></div>
                <!-- å¼•ç”¨æ¡ -->
                <div id="quoteBar" style="display:none;background:#f5f5f5;border-left:3px solid #0084ff;padding:6px 12px;margin-bottom:4px;color:#555;font-size:13px;">
                    <div style="display:flex;align-items:center;">
                        <span style="flex:1;"><b id="quoteFromName"></b><span id="quoteContent"></span></span>
                        <button id="cancelQuoteBtn" style="margin-left:12px;background:none;border:none;color:#888;cursor:pointer;">å–æ¶ˆå¼•ç”¨</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="user-sidebar">
            <div class="sidebar-header">
                <h3>åœ¨çº¿ç”¨æˆ·</h3>
                <p>å…± <span id="userCount">0</span> äºº</p>
            </div>
            <div class="user-list" id="userList">
                <!-- ç”¨æˆ·åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æ¨¡æ€æ¡† -->
    <div id="imageModal" class="image-modal">
        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
        <img class="image-modal-content" id="modalImage">
    </div>

    <script>
        let ws = null;
        let currentUser = null;
        let users = [];
        let messages = [];
        let revokedCache = {};
        let isRaisingHand = false;
        let currentQuote = null;

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initWebSocket() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = '/login';
                return;
            }

            ws = new WebSocket(`ws://${window.location.host}`);
            
            ws.onopen = function() {
                console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                ws.send(JSON.stringify({
                    type: 'join',
                    token: token,
                    room: 'test-room',
                    country: 'ä¸­å›½'
                }));
            };

            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', message);
                    
                    switch (message.type) {
                        case 'chat':
                        case 'image':
                            console.log('å¤„ç†èŠå¤©/å›¾ç‰‡æ¶ˆæ¯:', message);
                            addMessage(message);
                            break;
                        case 'history':
                            console.log('æ”¶åˆ°å†å²æ¶ˆæ¯:', message.messages.length, 'æ¡');
                            message.messages.forEach(msg => {
                                // å¤„ç†å†å²æ¶ˆæ¯ï¼Œç¡®ä¿å›¾ç‰‡æ¶ˆæ¯æœ‰æ­£ç¡®çš„ç±»å‹
                                if (msg.content && typeof msg.content === 'string' && msg.content.startsWith('/uploads/images/')) {
                                    // è¿™æ˜¯å†å²å›¾ç‰‡æ¶ˆæ¯ï¼Œéœ€è¦è½¬æ¢ä¸ºæ­£ç¡®çš„æ ¼å¼
                                    msg.type = 'image';
                                    msg.content = {
                                        url: msg.content,
                                        alt: msg.text || 'å›¾ç‰‡',
                                        imageId: msg.id
                                    };
                                }
                                
                                // æ ¹æ®ç”¨æˆ·ååŒ¹é…ç”¨æˆ·ä¿¡æ¯
                                if (msg.username) {
                                    const matchedUser = users.find(u => u.username === msg.username);
                                    if (matchedUser) {
                                        msg.userId = matchedUser.userId;
                                        msg.fromName = matchedUser.username;
                                        msg.role = matchedUser.role;
                                        msg.country = matchedUser.country;
                                        msg.avatarUrl = matchedUser.avatarUrl;
                                    } else {
                                        // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„ç”¨æˆ·ï¼Œä½¿ç”¨é»˜è®¤å€¼
                                        msg.fromName = msg.username;
                                        msg.role = msg.role || 'observer';
                                        msg.country = msg.country || 'ä¸­å›½';
                                        // ç”Ÿæˆé»˜è®¤å¤´åƒ
                                        const avatarService = window.AvatarService || {
                                            generateRoleBasedAvatar: (username, role) => {
                                                const colors = {
                                                    'admin': '#ff4757', 'host': '#2ed573', 'sys': '#1e90ff',
                                                    'student': '#ffa502', 'observer': '#747d8c', 'judge': '#ff6348', 'delegate': '#5352ed'
                                                };
                                                const color = colors[role] || '#747d8c';
                                                const initials = username.substring(0, 2).toUpperCase();
                                                return `data:image/svg+xml;base64,${btoa(`
                                                    <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                                                        <circle cx="20" cy="20" r="20" fill="${color}"/>
                                                        <text x="20" y="25" font-family="Arial" font-size="14" fill="white" text-anchor="middle">${initials}</text>
                                                    </svg>
                                                `)}`;
                                            }
                                        };
                                        msg.avatarUrl = avatarService.generateRoleBasedAvatar(msg.username, msg.role);
                                    }
                                }
                                
                                messages.push(msg);
                                renderMessage(msg);
                            });
                            scrollToBottom();
                            break;
                        case 'userList':
                            console.log('æ”¶åˆ°ç”¨æˆ·åˆ—è¡¨æ›´æ–°:', message.users.length, 'ä¸ªç”¨æˆ·');
                            users = message.users;
                            renderUserList();
                            updateOnlineCount();
                            
                            // è°ƒè¯•è¾“å‡º
                            console.log('userList:', message.users);
                            console.log('userInfo:', localStorage.getItem('userInfo'));
                            console.log('token:', localStorage.getItem('token'));
                            // è‡ªåŠ¨è®¾ç½®currentUser
                            let myUser = null;
                            const userInfo = localStorage.getItem('userInfo');
                            if (userInfo) {
                                const parsed = JSON.parse(userInfo);
                                // æ‰“å°æ‰€æœ‰userIdå’Œusername
                                message.users.forEach(u => console.log('user:', u.userId, u.username, u));
                                // å¤šå­—æ®µå°è¯•åŒ¹é…
                                myUser = message.users.find(u =>
                                    u.userId === parsed.id ||
                                    u.userId === parsed.userId ||
                                    u.username === parsed.username ||
                                    u.username === parsed.name
                                );
                            }
                            if (!myUser) {
                                // é€€è€Œæ±‚å…¶æ¬¡ç”¨tokenè§£ç userId
                                const token = localStorage.getItem('token');
                                if (token) {
                                    try {
                                        const payload = JSON.parse(atob(token.split('.')[1]));
                                        message.users.forEach(u => console.log('user:', u.userId, u.username, u));
                                        myUser = message.users.find(u =>
                                            u.userId === payload.userId ||
                                            u.username === payload.username
                                        );
                                    } catch(e) {console.log('tokenè§£æå¤±è´¥', e);}
                                }
                            }
                            if (myUser) {
                                currentUser = myUser;
                                console.log('currentUseråŒ¹é…æˆåŠŸ', currentUser);
                            } else {
                                console.warn('currentUserä¾æ—§ä¸ºnullï¼Œæ£€æŸ¥userListå’ŒuserInfoç»“æ„');
                            }
                            break;
                        case 'error':
                            console.error('æœåŠ¡å™¨é”™è¯¯:', message.message);
                            alert('é”™è¯¯: ' + message.message);
                            break;
                        case 'system':
                            addSystemMessage(message.message);
                            break;
                        case 'revokeMessage':
                            // è‡ªå·±æ’¤å›åæ”¶åˆ°ï¼Œä¿å­˜å†…å®¹ä¾›é‡æ–°ç¼–è¾‘
                            revokedCache[message.messageId] = message.content;
                            handleMessageRevoked(message.messageId, message.revokedBy, true);
                            break;
                        case 'messageRevoked':
                            handleMessageRevoked(message.messageId, message.revokedBy, false);
                            break;
                        case 'raiseHand':
                            handleRaiseHand(message);
                            break;
                        default:
                            console.log('æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹:', message.type);
                    }
                } catch (error) {
                    console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
            };

            ws.onclose = function() {
                console.log('WebSocketè¿æ¥å·²å…³é—­');
            };
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(message) {
            messages.push(message);
            renderMessage(message);
            scrollToBottom();
        }

        // æ¸²æŸ“å•æ¡æ¶ˆæ¯ï¼ˆæ”¯æŒæ—¥æœŸåˆ†éš”æ¡å’Œå¼•ç”¨æŒ‰é’®ï¼‰
        function renderMessage(message) {
            console.log('currentUser:', currentUser, 'message.userId:', message.userId, 'message:', message);
            const chatMessages = document.getElementById('chatMessages');
            // ä¿®å¤è‡ªå·±æ¶ˆæ¯çš„åˆ¤æ–­é€»è¾‘
            const isOwnMessage = message.userId && currentUser && (
                message.userId === currentUser.userId || 
                message.userId === currentUser.id ||
                message.from === currentUser.userId ||
                message.from === currentUser.id
            );

            // æ—¥æœŸåˆ†éš”æ¡é€»è¾‘
            if (!renderMessage.lastDate) renderMessage.lastDate = null;
            const msgDate = message.timestamp ? message.timestamp.slice(0, 10) : null;
            if (msgDate && msgDate !== renderMessage.lastDate) {
                // æ’å…¥æ—¥æœŸåˆ†éš”æ¡
                const week = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                const d = new Date(msgDate);
                const weekStr = 'æ˜ŸæœŸ' + week[d.getDay()];
                const dividerHtml = `<div class=\"date-divider\" style=\"text-align:center;color:#888;margin:16px 0 8px 0;font-size:14px;\">${msgDate} ${weekStr}</div>`;
                chatMessages.insertAdjacentHTML('beforeend', dividerHtml);
                renderMessage.lastDate = msgDate;
            }

            // å¼•ç”¨å†…å®¹æ¸²æŸ“
            let quoteHtml = '';
            if (message.quote) {
                const quoteContent = message.quote.content.length > 50 ? 
                    message.quote.content.substring(0, 50) + '...' : 
                    message.quote.content;
                quoteHtml = `<div class="quote-block" onclick="scrollToMessage('${message.quote.id}')" style="background:#f5f5f5;border-left:3px solid #0084ff;padding:6px 12px;margin-bottom:4px;color:#555;font-size:13px;cursor:pointer;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                    <div style="font-weight:bold;color:#0084ff;margin-bottom:2px;">${message.quote.fromName}</div>
                    <div style="color:#666;">${quoteContent}</div>
                </div>`;
            }

            // æ ¹æ®æ¶ˆæ¯ç±»å‹æ¸²æŸ“ä¸åŒçš„å†…å®¹
            let messageContent = '';
            switch (message.type) {
                case 'image':
                    messageContent = renderImageContent(message);
                    break;
                case 'audio':
                    messageContent = renderAudioContent(message);
                    break;
                case 'video':
                    messageContent = renderVideoContent(message);
                    break;
                case 'file':
                    messageContent = renderFileContent(message);
                    break;
                default:
                    // æ–‡æœ¬æ¶ˆæ¯æˆ–å…¶ä»–ç±»å‹
                    messageContent = message.revoked ? 'æ­¤æ¶ˆæ¯å·²è¢«æ’¤å›' : message.content;
            }

            // åˆ¤æ–­æ˜¯å¦ç®€æ´æ¨¡å¼
            const chatMessagesDiv = document.getElementById('chatMessages');
            const isSimpleMode = chatMessagesDiv.classList.contains('simple-mode');
            let messageHtml = '';
            if (isSimpleMode) {
                messageHtml = `
                <div class="message-item simple-mode ${isOwnMessage ? 'own' : ''}" data-from="${message.userId || ''}" id="msg-${message.id}">
                    <div class="message-sender" style="font-weight:bold;color:#333;margin-bottom:2px;">${message.fromName}</div>
                    ${quoteHtml}
                    <div class="message-bubble ${message.revoked ? 'revoked' : ''} ${isOwnMessage ? 'own' : ''}">
                        ${messageContent}
                    </div>
                </div>
                `;
            } else {
                // æ­£å¸¸æ¨¡å¼ï¼šæ—¶é—´æ¨ªå¹…åœ¨æ¶ˆæ¯ä¸Šæ–¹
                const timeBanner = `<div class=\"time-banner\" style=\"text-align:center;color:#aaa;font-size:12px;margin:4px 0 2px 0;\">${formatTime(message.timestamp)}</div>`;
                messageHtml = `
                ${timeBanner}
                <div class="message-item${isOwnMessage ? ' own' : ''}" data-from="${message.userId || ''}" id="msg-${message.id}">
                    <img src="${getAvatarUrl(message.fromName, message.avatarUrl)}" alt="å¤´åƒ" class="message-avatar">
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-name">${message.fromName}</span>
                            <span class="message-role role-${message.role}">${getRoleName(message.role)}</span>
                            <span class="message-country">${message.country}</span>
                            <button class="quote-btn" data-msgid="${message.id}" data-from="${message.userId || ''}" style="margin-left:8px;font-size:12px;color:#0084ff;background:none;border:none;cursor:pointer;">å¼•ç”¨</button>
                            ${isOwnMessage ? `<button class="edit-btn" data-msgid="${message.id}" style="margin-left:6px;font-size:12px;color:#28a745;background:none;border:none;cursor:pointer;">ç¼–è¾‘</button><button class="revoke-btn" data-msgid="${message.id}" style="margin-left:6px;font-size:12px;color:#dc3545;background:none;border:none;cursor:pointer;">æ’¤å›</button>` : ''}
                        </div>
                        ${quoteHtml}
                        <div class="message-bubble${message.revoked ? ' revoked' : ''}${isOwnMessage ? ' own' : ''}">
                            ${messageContent}
                        </div>
                    </div>
                </div>
                `;
            }
            chatMessages.insertAdjacentHTML('beforeend', messageHtml);
        }

        // æ¸²æŸ“å›¾ç‰‡å†…å®¹
        function renderImageContent(message) {
            if (!message.content || !message.content.url) {
                return '<div class="image-error"><span>ğŸ“· å›¾ç‰‡åŠ è½½å¤±è´¥</span></div>';
            }
            
            // åˆ›å»ºå›¾ç‰‡å®¹å™¨ï¼Œæ”¯æŒç‚¹å‡»æ”¾å¤§
            return `
                <div class="image-message-container">
                    <div class="image-wrapper">
                        <img src='${message.content.url}' 
                             alt='${message.content.alt || 'å›¾ç‰‡'}' 
                             class="message-image"
                             onclick='openImageModal(this.src, "${message.content.alt || 'å›¾ç‰‡'}")'
                             onerror='this.parentElement.innerHTML="<div class=\\"image-error\\"><span>ğŸ“· å›¾ç‰‡åŠ è½½å¤±è´¥</span></div>"'>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“éŸ³é¢‘å†…å®¹
        function renderAudioContent(message) {
            if (!message.content || !message.content.url) {
                return '<span style="color:#999;">[éŸ³é¢‘åŠ è½½å¤±è´¥]</span>';
            }
            return `<audio controls style="max-width:200px;"><source src="${message.content.url}" type="audio/mpeg">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾</audio>`;
        }

        // æ¸²æŸ“è§†é¢‘å†…å®¹
        function renderVideoContent(message) {
            if (!message.content || !message.content.url) {
                return '<span style="color:#999;">[è§†é¢‘åŠ è½½å¤±è´¥]</span>';
            }
            return `<video controls style="max-width:200px;max-height:200px;"><source src="${message.content.url}" type="video/mp4">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾</video>`;
        }

        // æ¸²æŸ“æ–‡ä»¶å†…å®¹
        function renderFileContent(message) {
            if (!message.content || !message.content.filename) {
                return '<span style="color:#999;">[æ–‡ä»¶åŠ è½½å¤±è´¥]</span>';
            }
            return `<div style="display:flex;align-items:center;padding:8px;background:#f5f5f5;border-radius:4px;">
                <span style="margin-right:8px;">ğŸ“</span>
                <span style="flex:1;">${message.content.filename}</span>
                <a href="${message.content.url}" download style="color:#0084ff;text-decoration:none;">ä¸‹è½½</a>
            </div>`;
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(text) {
            const chatMessages = document.getElementById('chatMessages');
            const systemHtml = `<div class="system-message">${text}</div>`;
            chatMessages.insertAdjacentHTML('beforeend', systemHtml);
            scrollToBottom();
        }

        // å¤„ç†æ¶ˆæ¯æ’¤å›
        function handleMessageRevoked(messageId, by, isSelf) {
            const messageElement = document.getElementById('msg-' + messageId);
            if (messageElement) {
                const bubble = messageElement.querySelector('.message-bubble');
                if (bubble && !bubble.classList.contains('revoked')) {
                    bubble.classList.add('revoked');
                    bubble.textContent = 'æ­¤æ¶ˆæ¯å·²è¢«æ’¤å›';
                }
            }

            let tip = `${by} æ’¤å›äº†ä¸€æ¡æ¶ˆæ¯`;
            if (isSelf) {
                tip += `ï¼Œ<span class="re-edit" data-id="${messageId}">é‡æ–°ç¼–è¾‘</span>`;
            }
            addSystemMessage(tip);
        }

        // å¤„ç†ä¸¾æ‰‹
        function handleRaiseHand(message) {
            if (message.isRaisingHand) {
                addSystemMessage(`${message.from} ä¸¾æ‰‹äº† <span style='font-size:18px;'>ğŸ–ï¸</span>`);
            } else {
                addSystemMessage(`${message.from} æ”¾ä¸‹äº†æ‰‹ <span style='font-size:18px;'>âœ‹</span>`);
            }
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content && !currentQuote) return;
            if (!ws) {
                alert('è¿æ¥å·²æ–­å¼€ï¼Œè¯·åˆ·æ–°é¡µé¢');
                return;
            }
            ws.send(JSON.stringify({
                type: 'chat',
                content: content,
                quote: currentQuote
            }));
            input.value = '';
            currentQuote = null;
            hideQuoteBar();
        }

        // ä¸¾æ‰‹åŠŸèƒ½
        function raiseHand() {
            if (!ws) return;
            isRaisingHand = !isRaisingHand;
            const btn = document.getElementById('raiseHandBtn');
            ws.send(JSON.stringify({ type: 'raiseHand', isRaising: isRaisingHand }));
            if (isRaisingHand) {
                btn.classList.add('active');
                btn.textContent = 'å–æ¶ˆä¸¾æ‰‹';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'ä¸¾æ‰‹';
            }
        }

        // å¤„ç†æŒ‰é”®äº‹ä»¶
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    // Shift+Enter: æ’å…¥æ¢è¡Œ
                    return;
                } else {
                    // Enter: å‘é€æ¶ˆæ¯
                    event.preventDefault();
                    sendMessage();
                }
            }
        }

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        function adjustTextareaHeight() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // ç›‘å¬è¾“å…¥æ¡†è¾“å…¥äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('messageInput');
            textarea.addEventListener('input', adjustTextareaHeight);
        });

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUserList() {
            const userList = document.getElementById('userList');
            userList.innerHTML = users.map(user => `
                <div class="user-item ${user.isSpeaking ? 'speaking' : ''} ${user.isRaisingHand ? 'raising-hand' : ''} ${!user.canSpeak ? 'muted' : ''}">
                    <img src="${getAvatarUrl(user.username, user.avatarUrl)}" alt="å¤´åƒ" class="user-avatar-small">
                    <div class="user-info-small">
                        <div class="user-name-small">${user.username}
                          ${user.isRaisingHand ? '<span title="ä¸¾æ‰‹" style="margin-left:6px;font-size:18px;vertical-align:middle;">ğŸ–ï¸</span>' : ''}
                        </div>
                        <div class="user-role-small">${getRoleName(user.role)} â€¢ ${user.country}</div>
                    </div>
                    <div class="user-status-small ${getStatusClass(user)}"></div>
                </div>
            `).join('');
        }

        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(user) {
            if (!user.canSpeak) return 'status-muted';
            if (user.isSpeaking) return 'status-speaking';
            if (user.isRaisingHand) return 'status-raising-hand';
            return 'status-online';
        }

        // æ›´æ–°åœ¨çº¿äººæ•°
        function updateOnlineCount() {
            document.getElementById('onlineCount').textContent = users.length;
            document.getElementById('userCount').textContent = users.length;
        }

        // è·å–å¤´åƒURL
        function getAvatarUrl(username, avatarUrl) {
            // å¦‚æœæä¾›äº†avatarUrlï¼Œç›´æ¥ä½¿ç”¨
            if (avatarUrl) {
                return avatarUrl;
            }
            
            // å¦åˆ™æ ¹æ®ç”¨æˆ·åç”Ÿæˆé»˜è®¤å¤´åƒ
            const colors = {
                'admin': '#ff4757', 'host': '#2ed573', 'sys': '#1e90ff',
                'student': '#ffa502', 'observer': '#747d8c', 'judge': '#ff6348', 'delegate': '#5352ed'
            };
            
            // å°è¯•ä»åœ¨çº¿ç”¨æˆ·ä¸­æ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·
            const user = users.find(u => u.username === username);
            const role = user ? user.role : 'observer';
            const color = colors[role] || '#747d8c';
            const initials = username.substring(0, 2).toUpperCase();
            
            return `data:image/svg+xml;base64,${btoa(`
                <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="20" fill="${color}"/>
                    <text x="20" y="25" font-family="Arial" font-size="14" fill="white" text-anchor="middle">${initials}</text>
                </svg>
            `)}`;
        }

        // è·å–è§’è‰²åç§°
        function getRoleName(role) {
            const roleNames = {
                sys: 'ç³»ç»Ÿç®¡ç†å‘˜',
                admin: 'ç®¡ç†å‘˜',
                host: 'ä¸»æŒäºº',
                judge: 'è¯„å§”',
                observer: 'è§‚å¯Ÿå‘˜',
                delegate: 'ä»£è¡¨',
                student: 'å­¦ç”Ÿ'
            };
            return roleNames[role] || role;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timeString) {
            const date = new Date(timeString);
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥å…ƒç´ çŠ¶æ€...');
            
            // æ£€æŸ¥å›¾ç‰‡æ¨¡æ€æ¡†çŠ¶æ€
            const imageModal = document.getElementById('imageModal');
            console.log('å›¾ç‰‡æ¨¡æ€æ¡†æ˜¾ç¤ºçŠ¶æ€:', imageModal.style.display);
            console.log('å›¾ç‰‡æ¨¡æ€æ¡†å¯è§æ€§:', imageModal.style.visibility);
            
            // ç¡®ä¿å›¾ç‰‡æ¨¡æ€æ¡†éšè—
            imageModal.style.display = 'none';
            imageModal.style.visibility = 'hidden';
            
            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    closeImageModal();
                }
            });
            
            // æ£€æŸ¥é¡µé¢åº•éƒ¨å…ƒç´ 
            console.log('æ£€æŸ¥é¡µé¢åº•éƒ¨å…ƒç´ ...');
            const allElements = document.querySelectorAll('*');
            allElements.forEach(el => {
                const rect = el.getBoundingClientRect();
                if (rect.bottom > window.innerHeight - 50 && rect.height > 10) {
                    console.log('åº•éƒ¨å…ƒç´ :', el.tagName, el.className, el.id, el.style.backgroundColor);
                }
            });
            
            initWebSocket();
            
            // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            const userInfo = localStorage.getItem('userInfo');
            if (userInfo) {
                currentUser = JSON.parse(userInfo);
            }
        });

        // ========== è¡¨æƒ…å’Œå›¾ç‰‡æŒ‰é’®åŠŸèƒ½ ==========
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const messageInput = document.getElementById('messageInput');
        const emojis = [
            'ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜‡','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ˜—','ğŸ˜™','ğŸ˜š','ğŸ˜‹','ğŸ˜›','ğŸ˜','ğŸ˜œ','ğŸ¤ª','ğŸ¤¨','ğŸ§','ğŸ¤“','ğŸ˜','ğŸ¤©','ğŸ¥³','ğŸ˜','ğŸ˜’','ğŸ˜','ğŸ˜”','ğŸ˜Ÿ','ğŸ˜•','ğŸ™','â˜¹ï¸','ğŸ˜£','ğŸ˜–','ğŸ˜«','ğŸ˜©','ğŸ¥º','ğŸ˜¢','ğŸ˜­','ğŸ˜¤','ğŸ˜ ','ğŸ˜¡','ğŸ¤¬','ğŸ¤¯','ğŸ˜³','ğŸ¥µ','ğŸ¥¶','ğŸ˜±','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜“','ğŸ¤—','ğŸ¤”','ğŸ¤­','ğŸ¤«','ğŸ¤¥','ğŸ˜¶','ğŸ˜','ğŸ˜‘','ğŸ˜¯','ğŸ˜¦','ğŸ˜§','ğŸ˜®','ğŸ˜²','ğŸ¥±','ğŸ˜´','ğŸ¤¤','ğŸ˜ª','ğŸ˜µ','ğŸ¤','ğŸ¥´','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤‘','ğŸ¤ ','ğŸ‘»','ğŸ‘½','ğŸ¤–','ğŸ’©','ğŸ˜ˆ','ğŸ‘¿','ğŸ‘¹','ğŸ‘º','ğŸ¤¡','ğŸ‘»','ğŸ’€','â˜ ï¸','ğŸ‘½'
        ];
        
emojiBtn.addEventListener('click', e => {
  e.stopPropagation();
  // æ¸²æŸ“è¡¨æƒ…é¢æ¿ï¼ˆä»…é¦–æ¬¡ï¼‰
  if (!emojiPanel.dataset.inited) {
    emojiPanel.innerHTML = '<div class="emoji-grid">' +
      emojis.map(em => `<span class="emoji-item">${em}</span>`).join('') +
      '</div>';
    emojiPanel.dataset.inited = '1';
  }
  // åˆ‡æ¢æ˜¾ç¤º/éšè—
  if (emojiPanel.style.display === 'block') {
    emojiPanel.style.display = 'none';
    return;
  }
  // æ˜¾ç¤ºå‰éšå¼éšè—ã€è®¾ç½®å®šä½
  emojiPanel.style.display = 'block';
  emojiPanel.style.position = 'absolute';
  emojiPanel.style.visibility = 'hidden';
  emojiPanel.style.zIndex = '1001';

  // ä¸‹ä¸€å¸§æµ‹å°ºå¯¸å¹¶å®šä½
  requestAnimationFrame(() => {
    const rect = emojiBtn.getBoundingClientRect();
    const { scrollTop, scrollLeft } = document.documentElement;
    const gap = 6;
    const panelW = emojiPanel.offsetWidth;
    const panelH = emojiPanel.offsetHeight;
    // åŸºæœ¬æ”¾åœ¨æŒ‰é’®æ­£ä¸Šæ–¹æ°´å¹³å±…ä¸­
    let left = scrollLeft + rect.left + (rect.width - panelW) / 2;
    let top  = scrollTop + rect.top - panelH - gap;
    // å¦‚æœä¸Šæ–¹ç©ºé—´ä¸è¶³ï¼Œæ”¾åˆ°æŒ‰é’®ä¸‹æ–¹
    if (top < scrollTop) {
      top = scrollTop + rect.bottom + gap;
    }
    emojiPanel.style.left = left + 'px';
    emojiPanel.style.top  = top  + 'px';
    emojiPanel.style.visibility = 'visible';
  });
});
emojiPanel.addEventListener('click', function(e) {
            if (e.target.classList.contains('emoji-item')) {
                const emoji = e.target.textContent;
                const cursorPos = messageInput.selectionStart;
                const textBefore = messageInput.value.substring(0, cursorPos);
                const textAfter = messageInput.value.substring(cursorPos);
                messageInput.value = textBefore + emoji + textAfter;
                messageInput.focus();
                messageInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
                emojiPanel.style.display = 'none';
            }
        });
        document.addEventListener('click', function(e) {
            if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
                emojiPanel.style.display = 'none';
            }
        });
        // ========== å›¾ç‰‡æŒ‰é’®åŠŸèƒ½ ==========
        const imageBtn = document.getElementById('imageBtn');
        const imageInput = document.getElementById('imageInput');
        let selectedImageFile = null;
        imageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            imageInput.value = '';
            imageInput.click();
        });
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedImageFile = file;
                // ç›´æ¥ä¸Šä¼ å›¾ç‰‡
                sendImageFile(selectedImageFile);
            }
        });
        async function sendImageFile(file) {
            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('roomId', 'test-room');
                const response = await fetch('/api/images/upload', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
                    body: formData
                });
                if (!response.ok) throw new Error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
                const result = await response.json();
                // å‘é€å›¾ç‰‡æ¶ˆæ¯
                ws.send(JSON.stringify({
                    type: 'image',
                    content: {
                        url: result.imageUrl,
                        imageId: result.image.id,
                        alt: result.image.originalname || 'å›¾ç‰‡'
                    }
                }));
                selectedImageFile = null;
                imageInput.value = '';
            } catch (err) {
                alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + err.message);
            }
        }
        document.addEventListener('click', function(e) {
            if (!imagePreviewPanel.contains(e.target) && e.target !== imageBtn) {
                imagePreviewPanel.style.display = 'none';
            }
        });

        // ========== å¼•ç”¨å¯¹è¯åŠŸèƒ½ ==========
        // ç›‘å¬å¼•ç”¨æŒ‰é’®ç‚¹å‡»
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('quote-btn')) {
                const msgId = e.target.getAttribute('data-msgid');
                const msg = messages.find(m => m.id === msgId);
                if (msg) {
                    currentQuote = {
                        id: msg.id,
                        fromName: msg.fromName,
                        content: (msg.content && typeof msg.content === 'string') ? msg.content : '[å›¾ç‰‡]' // ç®€åŒ–å›¾ç‰‡å¼•ç”¨
                    };
                    showQuoteBar();
                }
            }
            if (e.target.id === 'cancelQuoteBtn') {
                currentQuote = null;
                hideQuoteBar();
            }
            if (e.target.classList.contains('revoke-btn')) {
                const id = e.target.getAttribute('data-msgid');
                if (confirm('ç¡®å®šæ’¤å›æ­¤æ¶ˆæ¯?')) {
                    sendRevoke(id);
                }
            }
            if (e.target.classList.contains('edit-btn')) {
                const id = e.target.getAttribute('data-msgid');
                const msg = messages.find(m => m.id === id);
                if (msg) {
                    const newText = prompt('ä¿®æ”¹æ¶ˆæ¯å†…å®¹', typeof msg.content === 'string' ? msg.content : '');
                    if (newText !== null) {
                        sendEdit(id, newText);
                    }
                }
            }
            if (e.target.classList.contains('re-edit')) {
                const id = e.target.getAttribute('data-id');
                const content = revokedCache[id] || '';
                const input = document.getElementById('messageInput');
                input.value = content;
                input.focus();
            }
        });
        // æ˜¾ç¤ºå¼•ç”¨æ¡
        function showQuoteBar() {
            let bar = document.getElementById('quoteBar');
            if (!bar) {
                bar = document.createElement('div');
                bar.id = 'quoteBar';
                bar.style = 'background:#f5f5f5;border-left:3px solid #0084ff;padding:6px 12px;margin-bottom:4px;color:#555;font-size:13px;display:flex;align-items:center;';
                document.querySelector('.chat-input .input-container').insertAdjacentElement('beforebegin', bar);
            }
            
            if (currentQuote) {
                document.getElementById('quoteFromName').textContent = currentQuote.fromName + 'ï¼š';
                document.getElementById('quoteContent').textContent = currentQuote.content;
                bar.style.display = 'flex';
            } else {
                bar.style.display = 'none';
            }
        }
        function hideQuoteBar() {
            const bar = document.getElementById('quoteBar');
            if (bar) {
                bar.style.display = 'none';
                document.getElementById('quoteFromName').textContent = '';
                document.getElementById('quoteContent').textContent = '';
            }
        }

        // å›¾ç‰‡æ¨¡æ€æ¡†åŠŸèƒ½
        function openImageModal(src, alt) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = "block";
            modalImg.src = src;
            modalImg.alt = alt;
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = "none";
        }

        // å‘é€æ’¤å›æ¶ˆæ¯
        function sendRevoke(id) {
            if (ws) {
                ws.send(JSON.stringify({ type: 'revokeMessage', messageId: id }));
            }
        }

        // ç¼–è¾‘æ¶ˆæ¯
        async function sendEdit(id, newText) {
            try {
                const res = await fetch('/api/messages/' + id, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({ content: newText })
                });
                await handleApiResponse(res);
                if (res.ok) {
                    const msg = messages.find(m => m.id === id);
                    if (msg) {
                        msg.content = newText;
                        msg.edited = true;
                    }
                    const bubble = document.querySelector('#msg-' + id + ' .message-bubble');
                    if (bubble) bubble.textContent = newText + ' (å·²ç¼–è¾‘)';
                } else {
                    const err = await res.json();
                    alert(err.error || 'ç¼–è¾‘å¤±è´¥');
                }
            } catch (err) {
                alert('ç¼–è¾‘å¤±è´¥: ' + err.message);
            }
        }

        // æ»šåŠ¨åˆ°æŒ‡å®šæ¶ˆæ¯
        function scrollToMessage(messageId) {
            const messageElement = document.getElementById(`msg-${messageId}`);
            if (messageElement) {
                messageElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // æ·»åŠ é«˜äº®æ•ˆæœ
                messageElement.style.backgroundColor = '#fff3cd';
                messageElement.style.border = '2px solid #ffc107';
                messageElement.style.borderRadius = '8px';
                messageElement.style.transition = 'all 0.3s ease';
                
                // 3ç§’åç§»é™¤é«˜äº®
                setTimeout(() => {
                    messageElement.style.backgroundColor = '';
                    messageElement.style.border = '';
                    messageElement.style.borderRadius = '';
                }, 3000);
            }
        }

        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });

        // å…¨å±€fetch/axiosæ‹¦æˆª401ï¼Œç›´æ¥è·³è½¬åˆ°/login
        function handleApiResponse(res) {
            if (res.status === 401) {
                window.location.href = '/login';
                return Promise.reject('æœªç™»å½•');
            }
            return res;
        }
    </script>
</body>
</html> 