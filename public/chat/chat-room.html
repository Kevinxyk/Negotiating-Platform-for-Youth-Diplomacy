<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÅäÂ§©ÂÆ§</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            overflow-x: hidden;
        }
        .chat-container {
            display: flex;
            height: 100vh;
            background: #f8f9fa;
        }
        .chat-main { flex: 1; display: flex; flex-direction: column; }
        .chat-header { background: white; padding: 20px; border-bottom: 1px solid #e1e5e9; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 12px; background: #f8f9fa; }
        .message-item { display: flex; align-items: flex-start; margin-bottom: 10px; }
        .message-item.own { flex-direction: row-reverse; }
        .message-item.own .message-content { margin-left: 0; margin-right: 12px; align-items: flex-end; }
        .message-item.own .message-bubble { background-color: #0084ff; color: white; }
        .message-item.own .message-bubble.own { background-color: #0084ff; color: white; }
        .message-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; flex-shrink: 0; }
        .message-content {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: fit-content;
            max-width: 33vw;
            margin-left: 12px;
        }
        .message-header { display: flex; align-items: center; margin-bottom: 2px; }
        .message-name { font-weight: bold; color: #1a1a1a; margin-right: 8px; }
        .message-role { font-size: 12px; padding: 2px 6px; border-radius: 10px; color: white; }
        .message-country { font-size: 12px; color: #666; margin-left: 8px; }
        .message-time { font-size: 12px; color: #999; margin-left: auto; }
        .message-bubble {
            background: white;
            padding: 4px 10px;
            border-radius: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
            word-break: break-word;
            white-space: pre-wrap;
            max-width: 100%;
            display: inline-block;
            margin: 1px 0;
            line-height: 1.5;
            font-size: 15px;
        }
        .message-bubble.own {
            background: #0084ff;
            color: #fff;
        }
        .message-bubble.revoked { background: #f1f3f4; color: #666; font-style: italic; }
        .chat-input { background: white; padding: 20px; border-top: 1px solid #e1e5e9; }
        .input-container { display: flex; gap: 10px; }
        .message-input { 
            flex: 1; 
            padding: 8px 12px; 
            border: 1px solid #ddd; 
            border-radius: 20px; 
            outline: none; 
            font-size: 14px; 
            resize: none;
            min-height: 20px;
            max-height: 100px;
            overflow-y: auto;
            line-height: 1.4;
        }
        .send-btn { padding: 12px 24px; background: #0084ff; color: white; border: none; border-radius: 20px; cursor: pointer; }
        .send-btn:hover { background: #0073e6; }
        .user-sidebar { width: 300px; background: white; border-left: 1px solid #e1e5e9; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #e1e5e9; background: #f8f9fa; }
        .user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-item { display: flex; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 5px; }
        .user-item:hover { background: #f8f9fa; }
        .user-item.speaking { background: #e3f2fd; }
        .user-item.raising-hand { background: #fff3e0; }
        .user-item.muted { background: #ffebee; }
        .user-avatar-small { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; }
        .user-info-small { flex: 1; }
        .user-name-small { font-weight: bold; font-size: 14px; }
        .user-role-small { font-size: 12px; color: #666; }
        .user-status-small { width: 8px; height: 8px; border-radius: 50%; margin-left: 8px; }
        .status-online { background: #4caf50; }
        .status-speaking { background: #2196f3; }
        .status-raising-hand { background: #ff9800; }
        .status-muted { background: #f44336; }
        .emoji-picker {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            width: auto;

        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
        }
        .emoji-item { cursor: pointer; padding: 5px; text-align: center; border-radius: 4px; }
        .emoji-item:hover { background: #f0f0f0; }
        .system-message { text-align: center; color: #666; font-style: italic; margin: 10px 0; }
        .raise-hand-btn { padding: 8px 16px; background: #ff9800; color: white; border: none; border-radius: 16px; cursor: pointer; margin-right: 10px; }
        .raise-hand-btn:hover { background: #f57c00; }
        .raise-hand-btn.active { background: #e65100; }
        .date-divider { text-align: center; color: #888; margin: 16px 0 8px 0; font-size: 14px; }
        .quote-block { background: #f5f5f5; border-left: 3px solid #0084ff; padding: 6px 12px; margin-bottom: 4px; color: #555; font-size: 13px; }
        .time-banner { text-align: center; color: #aaa; font-size: 12px; margin: 4px 0 2px 0; }
        .image-error {
            text-align: center;
            color: #999;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .image-message-container,
        .image-wrapper {
            display: inline-block;
            padding: 0;
            margin: 0;
            background: none;
            border: none;
            box-shadow: none;
            max-width: 160px;
            max-height: 160px;
        }
        .image-overlay {
            display: none;
        }
        .image-icon {
            color: white;
            font-size: 24px;
        }
        .message-image {
            max-width: 160px;
            max-height: 160px;
            width: auto;
            height: auto;
            border-radius: 6px;
            cursor: pointer;
            object-fit: contain;
            display: block;
        }
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
        }
        .image-modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .image-modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        .image-modal-close:hover {
            color: #bbb;
        }
        .message-item.simple-mode.own { flex-direction: row-reverse; }
        .message-item.simple-mode.own .message-bubble { background-color: #0084ff; color: white; margin-left: auto; margin-right: 0; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-main">
            <div class="chat-header">
                <h2>Â§ñ‰∫§Ë∞àÂà§Âπ≥Âè∞</h2>
                <p>ÊàøÈó¥: <span id="roomName">test-room</span> | Âú®Á∫ø: <span id="onlineCount">0</span>‰∫∫</p>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <!-- Ê∂àÊÅØÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
            
            <div class="chat-input">
                <div class="input-container">
                    <button class="raise-hand-btn" id="raiseHandBtn" onclick="raiseHand()">‰∏æÊâã</button>
                    <button class="send-btn" id="emojiBtn" type="button" style="margin-right: 8px;">üòÄ</button>
                    <button class="send-btn" id="imageBtn" type="button" style="margin-right: 8px;">üñºÔ∏è</button>
                    <input type="file" id="imageInput" accept="image/*" style="display:none">
                    <textarea class="message-input" id="messageInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." onkeypress="handleKeyPress(event)"></textarea>
                    <button class="send-btn" onclick="sendMessage()">ÂèëÈÄÅ</button>
                </div>
                <!-- Ë°®ÊÉÖÈù¢Êùø -->
                <div id="emojiPanel" class="emoji-picker" style="display:none;position:absolute;z-index:1001;"></div>
                <!-- ÂºïÁî®Êù° -->
                <div id="quoteBar" style="display:none;background:#f5f5f5;border-left:3px solid #0084ff;padding:6px 12px;margin-bottom:4px;color:#555;font-size:13px;">
                    <div style="display:flex;align-items:center;">
                        <span style="flex:1;"><b id="quoteFromName"></b><span id="quoteContent"></span></span>
                        <button id="cancelQuoteBtn" style="margin-left:12px;background:none;border:none;color:#888;cursor:pointer;">ÂèñÊ∂àÂºïÁî®</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="user-sidebar">
            <div class="sidebar-header">
                <h3>Âú®Á∫øÁî®Êà∑</h3>
                <p>ÂÖ± <span id="userCount">0</span> ‰∫∫</p>
            </div>
            <div class="user-list" id="userList">
                <!-- Áî®Êà∑ÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>

    <!-- ÂõæÁâáÊ®°ÊÄÅÊ°Ü -->
    <div id="imageModal" class="image-modal">
        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
        <img class="image-modal-content" id="modalImage">
    </div>

    <script>
        let ws = null;
        let currentUser = null;
        let users = [];
        let messages = [];
        let revokedCache = {};
        let isRaisingHand = false;
        let currentQuote = null;

        // ÂàùÂßãÂåñWebSocketËøûÊé•
        function initWebSocket() {
            const token = localStorage.getItem('token');
            if (!token) {
                alert('ËØ∑ÂÖàÁôªÂΩï');
                window.location.href = '/login';
                return;
            }

            ws = new WebSocket(`ws://${window.location.host}`);
            
            ws.onopen = function() {
                console.log('WebSocketËøûÊé•Â∑≤Âª∫Á´ã');
                ws.send(JSON.stringify({
                    type: 'join',
                    token: token,
                    room: 'test-room',
                    country: '‰∏≠ÂõΩ'
                }));
            };

            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    console.log('Êî∂Âà∞WebSocketÊ∂àÊÅØ:', message);
                    
                    switch (message.type) {
                        case 'chat':
                        case 'image':
                            console.log('Â§ÑÁêÜËÅäÂ§©/ÂõæÁâáÊ∂àÊÅØ:', message);
                            addMessage(message);
                            break;
                        case 'history':
                            console.log('Êî∂Âà∞ÂéÜÂè≤Ê∂àÊÅØ:', message.messages.length, 'Êù°');
                            message.messages.forEach(msg => {
                                // Â§ÑÁêÜÂéÜÂè≤Ê∂àÊÅØÔºåÁ°Æ‰øùÂõæÁâáÊ∂àÊÅØÊúâÊ≠£Á°ÆÁöÑÁ±ªÂûã
                                if (msg.content && typeof msg.content === 'string' && msg.content.startsWith('/uploads/images/')) {
                                    // ËøôÊòØÂéÜÂè≤ÂõæÁâáÊ∂àÊÅØÔºåÈúÄË¶ÅËΩ¨Êç¢‰∏∫Ê≠£Á°ÆÁöÑÊ†ºÂºè
                                    msg.type = 'image';
                                    msg.content = {
                                        url: msg.content,
                                        alt: msg.text || 'ÂõæÁâá',
                                        imageId: msg.id
                                    };
                                }
                                
                                // Ê†πÊçÆÁî®Êà∑ÂêçÂåπÈÖçÁî®Êà∑‰ø°ÊÅØ
                                if (msg.username) {
                                    const matchedUser = users.find(u => u.username === msg.username);
                                    if (matchedUser) {
                                        msg.userId = matchedUser.userId;
                                        msg.fromName = matchedUser.username;
                                        msg.role = matchedUser.role;
                                        msg.country = matchedUser.country;
                                        msg.avatarUrl = matchedUser.avatarUrl;
                                    } else {
                                        // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂåπÈÖçÁöÑÁî®Êà∑Ôºå‰ΩøÁî®ÈªòËÆ§ÂÄº
                                        msg.fromName = msg.username;
                                        msg.role = msg.role || 'observer';
                                        msg.country = msg.country || '‰∏≠ÂõΩ';
                                        // ÁîüÊàêÈªòËÆ§Â§¥ÂÉè
                                        const avatarService = window.AvatarService || {
                                            generateRoleBasedAvatar: (username, role) => {
                                                const colors = {
                                                    'admin': '#ff4757', 'host': '#2ed573', 'sys': '#1e90ff',
                                                    'student': '#ffa502', 'observer': '#747d8c', 'judge': '#ff6348', 'delegate': '#5352ed'
                                                };
                                                const color = colors[role] || '#747d8c';
                                                const initials = username.substring(0, 2).toUpperCase();
                                                return `data:image/svg+xml;base64,${btoa(`
                                                    <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                                                        <circle cx="20" cy="20" r="20" fill="${color}"/>
                                                        <text x="20" y="25" font-family="Arial" font-size="14" fill="white" text-anchor="middle">${initials}</text>
                                                    </svg>
                                                `)}`;
                                            }
                                        };
                                        msg.avatarUrl = avatarService.generateRoleBasedAvatar(msg.username, msg.role);
                                    }
                                }
                                
                                messages.push(msg);
                                renderMessage(msg);
                            });
                            scrollToBottom();
                            break;
                        case 'userList':
                            console.log('Êî∂Âà∞Áî®Êà∑ÂàóË°®Êõ¥Êñ∞:', message.users.length, '‰∏™Áî®Êà∑');
                            users = message.users;
                            renderUserList();
                            updateOnlineCount();
                            
                            // Ë∞ÉËØïËæìÂá∫
                            console.log('userList:', message.users);
                            console.log('userInfo:', localStorage.getItem('userInfo'));
                            console.log('token:', localStorage.getItem('token'));
                            // Ëá™Âä®ËÆæÁΩÆcurrentUser
                            let myUser = null;
                            const userInfo = localStorage.getItem('userInfo');
                            if (userInfo) {
                                const parsed = JSON.parse(userInfo);
                                // ÊâìÂç∞ÊâÄÊúâuserIdÂíåusername
                                message.users.forEach(u => console.log('user:', u.userId, u.username, u));
                                // Â§öÂ≠óÊÆµÂ∞ùËØïÂåπÈÖç
                                myUser = message.users.find(u =>
                                    u.userId === parsed.id ||
                                    u.userId === parsed.userId ||
                                    u.username === parsed.username ||
                                    u.username === parsed.name
                                );
                            }
                            if (!myUser) {
                                // ÈÄÄËÄåÊ±ÇÂÖ∂Ê¨°Áî®tokenËß£Á†ÅuserId
                                const token = localStorage.getItem('token');
                                if (token) {
                                    try {
                                        const payload = JSON.parse(atob(token.split('.')[1]));
                                        message.users.forEach(u => console.log('user:', u.userId, u.username, u));
                                        myUser = message.users.find(u =>
                                            u.userId === payload.userId ||
                                            u.username === payload.username
                                        );
                                    } catch(e) {console.log('tokenËß£ÊûêÂ§±Ë¥•', e);}
                                }
                            }
                            if (myUser) {
                                currentUser = myUser;
                                console.log('currentUserÂåπÈÖçÊàêÂäü', currentUser);
                            } else {
                                console.warn('currentUser‰æùÊóß‰∏∫nullÔºåÊ£ÄÊü•userListÂíåuserInfoÁªìÊûÑ');
                            }
                            break;
                        case 'error':
                            console.error('ÊúçÂä°Âô®ÈîôËØØ:', message.message);
                            alert('ÈîôËØØ: ' + message.message);
                            break;
                        case 'system':
                            addSystemMessage(message.message);
                            break;
                        case 'revokeMessage':
                            // Ëá™Â∑±Êí§ÂõûÂêéÊî∂Âà∞Ôºå‰øùÂ≠òÂÜÖÂÆπ‰æõÈáçÊñ∞ÁºñËæë
                            revokedCache[message.messageId] = message.content;
                            handleMessageRevoked(message.messageId, message.revokedBy, true);
                            break;
                        case 'messageRevoked':
                            handleMessageRevoked(message.messageId, message.revokedBy, false);
                            break;
                        case 'raiseHand':
                            handleRaiseHand(message);
                            break;
                        default:
                            console.log('Êú™Â§ÑÁêÜÁöÑÊ∂àÊÅØÁ±ªÂûã:', message.type);
                    }
                } catch (error) {
                    console.error('Ëß£ÊûêWebSocketÊ∂àÊÅØÂ§±Ë¥•:', error);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocketÈîôËØØ:', error);
            };

            ws.onclose = function() {
                console.log('WebSocketËøûÊé•Â∑≤ÂÖ≥Èó≠');
            };
        }

        // Ê∑ªÂä†Ê∂àÊÅØÂà∞ËÅäÂ§©ÁïåÈù¢
        function addMessage(message) {
            messages.push(message);
            renderMessage(message);
            scrollToBottom();
        }

        // Ê∏≤ÊüìÂçïÊù°Ê∂àÊÅØÔºàÊîØÊåÅÊó•ÊúüÂàÜÈöîÊù°ÂíåÂºïÁî®ÊåâÈíÆÔºâ
        function renderMessage(message) {
            console.log('currentUser:', currentUser, 'message.userId:', message.userId, 'message:', message);
            const chatMessages = document.getElementById('chatMessages');
            // ‰øÆÂ§çËá™Â∑±Ê∂àÊÅØÁöÑÂà§Êñ≠ÈÄªËæë
            const isOwnMessage = message.userId && currentUser && (
                message.userId === currentUser.userId || 
                message.userId === currentUser.id ||
                message.from === currentUser.userId ||
                message.from === currentUser.id
            );

            // Êó•ÊúüÂàÜÈöîÊù°ÈÄªËæë
            if (!renderMessage.lastDate) renderMessage.lastDate = null;
            const msgDate = message.timestamp ? message.timestamp.slice(0, 10) : null;
            if (msgDate && msgDate !== renderMessage.lastDate) {
                // ÊèíÂÖ•Êó•ÊúüÂàÜÈöîÊù°
                const week = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'];
                const d = new Date(msgDate);
                const weekStr = 'ÊòüÊúü' + week[d.getDay()];
                const dividerHtml = `<div class=\"date-divider\" style=\"text-align:center;color:#888;margin:16px 0 8px 0;font-size:14px;\">${msgDate} ${weekStr}</div>`;
                chatMessages.insertAdjacentHTML('beforeend', dividerHtml);
                renderMessage.lastDate = msgDate;
            }

            // ÂºïÁî®ÂÜÖÂÆπÊ∏≤Êüì
            let quoteHtml = '';
            if (message.quote) {
                const quoteContent = message.quote.content.length > 50 ? 
                    message.quote.content.substring(0, 50) + '...' : 
                    message.quote.content;
                quoteHtml = `<div class="quote-block" onclick="scrollToMessage('${message.quote.id}')" style="background:#f5f5f5;border-left:3px solid #0084ff;padding:6px 12px;margin-bottom:4px;color:#555;font-size:13px;cursor:pointer;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                    <div style="font-weight:bold;color:#0084ff;margin-bottom:2px;">${message.quote.fromName}</div>
                    <div style="color:#666;">${quoteContent}</div>
                </div>`;
            }

            // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãÊ∏≤Êüì‰∏çÂêåÁöÑÂÜÖÂÆπ
            let messageContent = '';
            switch (message.type) {
                case 'image':
                    messageContent = renderImageContent(message);
                    break;
                case 'audio':
                    messageContent = renderAudioContent(message);
                    break;
                case 'video':
                    messageContent = renderVideoContent(message);
                    break;
                case 'file':
                    messageContent = renderFileContent(message);
                    break;
                default:
                    // ÊñáÊú¨Ê∂àÊÅØÊàñÂÖ∂‰ªñÁ±ªÂûã
                    messageContent = message.revoked ? 'Ê≠§Ê∂àÊÅØÂ∑≤Ë¢´Êí§Âõû' : message.content;
            }

            // Âà§Êñ≠ÊòØÂê¶ÁÆÄÊ¥ÅÊ®°Âºè
            const chatMessagesDiv = document.getElementById('chatMessages');
            const isSimpleMode = chatMessagesDiv.classList.contains('simple-mode');
            let messageHtml = '';
            if (isSimpleMode) {
                messageHtml = `
                <div class="message-item simple-mode ${isOwnMessage ? 'own' : ''}" data-from="${message.userId || ''}" id="msg-${message.id}">
                    <div class="message-sender" style="font-weight:bold;color:#333;margin-bottom:2px;">${message.fromName}</div>
                    ${quoteHtml}
                    <div class="message-bubble ${message.revoked ? 'revoked' : ''} ${isOwnMessage ? 'own' : ''}">
                        ${messageContent}
                    </div>
                </div>
                `;
            } else {
                // Ê≠£Â∏∏Ê®°ÂºèÔºöÊó∂Èó¥Ê®™ÂπÖÂú®Ê∂àÊÅØ‰∏äÊñπ
                const timeBanner = `<div class=\"time-banner\" style=\"text-align:center;color:#aaa;font-size:12px;margin:4px 0 2px 0;\">${formatTime(message.timestamp)}</div>`;
                messageHtml = `
                ${timeBanner}
                <div class="message-item${isOwnMessage ? ' own' : ''}" data-from="${message.userId || ''}" id="msg-${message.id}">
                    <img src="${getAvatarUrl(message.fromName, message.avatarUrl)}" alt="Â§¥ÂÉè" class="message-avatar">
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-name">${message.fromName}</span>
                            <span class="message-role role-${message.role}">${getRoleName(message.role)}</span>
                            <span class="message-country">${message.country}</span>
                            <button class="quote-btn" data-msgid="${message.id}" data-from="${message.userId || ''}" style="margin-left:8px;font-size:12px;color:#0084ff;background:none;border:none;cursor:pointer;">ÂºïÁî®</button>
                            ${isOwnMessage ? `<button class="edit-btn" data-msgid="${message.id}" style="margin-left:6px;font-size:12px;color:#28a745;background:none;border:none;cursor:pointer;">ÁºñËæë</button><button class="revoke-btn" data-msgid="${message.id}" style="margin-left:6px;font-size:12px;color:#dc3545;background:none;border:none;cursor:pointer;">Êí§Âõû</button>` : ''}
                        </div>
                        ${quoteHtml}
                        <div class="message-bubble${message.revoked ? ' revoked' : ''}${isOwnMessage ? ' own' : ''}">
                            ${messageContent}
                        </div>
                    </div>
                </div>
                `;
            }
            chatMessages.insertAdjacentHTML('beforeend', messageHtml);
        }

        // Ê∏≤ÊüìÂõæÁâáÂÜÖÂÆπ
        function renderImageContent(message) {
            if (!message.content || !message.content.url) {
                return '<div class="image-error"><span>üì∑ ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•</span></div>';
            }
            
            // ÂàõÂª∫ÂõæÁâáÂÆπÂô®ÔºåÊîØÊåÅÁÇπÂáªÊîæÂ§ß
            return `
                <div class="image-message-container">
                    <div class="image-wrapper">
                        <img src='${message.content.url}' 
                             alt='${message.content.alt || 'ÂõæÁâá'}' 
                             class="message-image"
                             onclick='openImageModal(this.src, "${message.content.alt || 'ÂõæÁâá'}")'
                             onerror='this.parentElement.innerHTML="<div class=\\"image-error\\"><span>üì∑ ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•</span></div>"'>
                    </div>
                </div>
            `;
        }

        // Ê∏≤ÊüìÈü≥È¢ëÂÜÖÂÆπ
        function renderAudioContent(message) {
            if (!message.content || !message.content.url) {
                return '<span style="color:#999;">[Èü≥È¢ëÂä†ËΩΩÂ§±Ë¥•]</span>';
            }
            return `<audio controls style="max-width:200px;"><source src="${message.content.url}" type="audio/mpeg">ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ</audio>`;
        }

        // Ê∏≤ÊüìËßÜÈ¢ëÂÜÖÂÆπ
        function renderVideoContent(message) {
            if (!message.content || !message.content.url) {
                return '<span style="color:#999;">[ËßÜÈ¢ëÂä†ËΩΩÂ§±Ë¥•]</span>';
            }
            return `<video controls style="max-width:200px;max-height:200px;"><source src="${message.content.url}" type="video/mp4">ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËßÜÈ¢ëÊí≠Êîæ</video>`;
        }

        // Ê∏≤ÊüìÊñá‰ª∂ÂÜÖÂÆπ
        function renderFileContent(message) {
            if (!message.content || !message.content.filename) {
                return '<span style="color:#999;">[Êñá‰ª∂Âä†ËΩΩÂ§±Ë¥•]</span>';
            }
            return `<div style="display:flex;align-items:center;padding:8px;background:#f5f5f5;border-radius:4px;">
                <span style="margin-right:8px;">üìé</span>
                <span style="flex:1;">${message.content.filename}</span>
                <a href="${message.content.url}" download style="color:#0084ff;text-decoration:none;">‰∏ãËΩΩ</a>
            </div>`;
        }

        // Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ
        function addSystemMessage(text) {
            const chatMessages = document.getElementById('chatMessages');
            const systemHtml = `<div class="system-message">${text}</div>`;
            chatMessages.insertAdjacentHTML('beforeend', systemHtml);
            scrollToBottom();
        }

        // Â§ÑÁêÜÊ∂àÊÅØÊí§Âõû
        function handleMessageRevoked(messageId, by, isSelf) {
            const messageElement = document.getElementById('msg-' + messageId);
            if (messageElement) {
                const bubble = messageElement.querySelector('.message-bubble');
                if (bubble && !bubble.classList.contains('revoked')) {
                    bubble.classList.add('revoked');
                    bubble.textContent = 'Ê≠§Ê∂àÊÅØÂ∑≤Ë¢´Êí§Âõû';
                }
            }

            let tip = `${by} Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ`;
            if (isSelf) {
                tip += `Ôºå<span class="re-edit" data-id="${messageId}">ÈáçÊñ∞ÁºñËæë</span>`;
            }
            addSystemMessage(tip);
        }

        // Â§ÑÁêÜ‰∏æÊâã
        function handleRaiseHand(message) {
            if (message.isRaisingHand) {
                addSystemMessage(`${message.from} ‰∏æÊâã‰∫Ü <span style='font-size:18px;'>üñêÔ∏è</span>`);
            } else {
                addSystemMessage(`${message.from} Êîæ‰∏ã‰∫ÜÊâã <span style='font-size:18px;'>‚úã</span>`);
            }
        }

        // ÂèëÈÄÅÊ∂àÊÅØ
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content && !currentQuote) return;
            if (!ws) {
                alert('ËøûÊé•Â∑≤Êñ≠ÂºÄÔºåËØ∑Âà∑Êñ∞È°µÈù¢');
                return;
            }
            ws.send(JSON.stringify({
                type: 'chat',
                content: content,
                quote: currentQuote
            }));
            input.value = '';
            currentQuote = null;
            hideQuoteBar();
        }

        // ‰∏æÊâãÂäüËÉΩ
        function raiseHand() {
            if (!ws) return;
            isRaisingHand = !isRaisingHand;
            const btn = document.getElementById('raiseHandBtn');
            ws.send(JSON.stringify({ type: 'raiseHand', isRaising: isRaisingHand }));
            if (isRaisingHand) {
                btn.classList.add('active');
                btn.textContent = 'ÂèñÊ∂à‰∏æÊâã';
            } else {
                btn.classList.remove('active');
                btn.textContent = '‰∏æÊâã';
            }
        }

        // Â§ÑÁêÜÊåâÈîÆ‰∫ã‰ª∂
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    // Shift+Enter: ÊèíÂÖ•Êç¢Ë°å
                    return;
                } else {
                    // Enter: ÂèëÈÄÅÊ∂àÊÅØ
                    event.preventDefault();
                    sendMessage();
                }
            }
        }

        // Ëá™Âä®Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈ´òÂ∫¶
        function adjustTextareaHeight() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        // ÁõëÂê¨ËæìÂÖ•Ê°ÜËæìÂÖ•‰∫ã‰ª∂
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('messageInput');
            textarea.addEventListener('input', adjustTextareaHeight);
        });

        // Ê∏≤ÊüìÁî®Êà∑ÂàóË°®
        function renderUserList() {
            const userList = document.getElementById('userList');
            userList.innerHTML = users.map(user => `
                <div class="user-item ${user.isSpeaking ? 'speaking' : ''} ${user.isRaisingHand ? 'raising-hand' : ''} ${!user.canSpeak ? 'muted' : ''}">
                    <img src="${getAvatarUrl(user.username, user.avatarUrl)}" alt="Â§¥ÂÉè" class="user-avatar-small">
                    <div class="user-info-small">
                        <div class="user-name-small">${user.username}
                          ${user.isRaisingHand ? '<span title="‰∏æÊâã" style="margin-left:6px;font-size:18px;vertical-align:middle;">üñêÔ∏è</span>' : ''}
                        </div>
                        <div class="user-role-small">${getRoleName(user.role)} ‚Ä¢ ${user.country}</div>
                    </div>
                    <div class="user-status-small ${getStatusClass(user)}"></div>
                </div>
            `).join('');
        }

        // Ëé∑ÂèñÁä∂ÊÄÅÊ†∑ÂºèÁ±ª
        function getStatusClass(user) {
            if (!user.canSpeak) return 'status-muted';
            if (user.isSpeaking) return 'status-speaking';
            if (user.isRaisingHand) return 'status-raising-hand';
            return 'status-online';
        }

        // Êõ¥Êñ∞Âú®Á∫ø‰∫∫Êï∞
        function updateOnlineCount() {
            document.getElementById('onlineCount').textContent = users.length;
            document.getElementById('userCount').textContent = users.length;
        }

        // Ëé∑ÂèñÂ§¥ÂÉèURL
        function getAvatarUrl(username, avatarUrl) {
            // Â¶ÇÊûúÊèê‰æõ‰∫ÜavatarUrlÔºåÁõ¥Êé•‰ΩøÁî®
            if (avatarUrl) {
                return avatarUrl;
            }
            
            // Âê¶ÂàôÊ†πÊçÆÁî®Êà∑ÂêçÁîüÊàêÈªòËÆ§Â§¥ÂÉè
            const colors = {
                'admin': '#ff4757', 'host': '#2ed573', 'sys': '#1e90ff',
                'student': '#ffa502', 'observer': '#747d8c', 'judge': '#ff6348', 'delegate': '#5352ed'
            };
            
            // Â∞ùËØï‰ªéÂú®Á∫øÁî®Êà∑‰∏≠ÊâæÂà∞ÂåπÈÖçÁöÑÁî®Êà∑
            const user = users.find(u => u.username === username);
            const role = user ? user.role : 'observer';
            const color = colors[role] || '#747d8c';
            const initials = username.substring(0, 2).toUpperCase();
            
            return `data:image/svg+xml;base64,${btoa(`
                <svg width="40" height="40" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="20" r="20" fill="${color}"/>
                    <text x="20" y="25" font-family="Arial" font-size="14" fill="white" text-anchor="middle">${initials}</text>
                </svg>
            `)}`;
        }

        // Ëé∑ÂèñËßíËâ≤ÂêçÁß∞
        function getRoleName(role) {
            const roleNames = {
                sys: 'Á≥ªÁªüÁÆ°ÁêÜÂëò',
                admin: 'ÁÆ°ÁêÜÂëò',
                host: '‰∏ªÊåÅ‰∫∫',
                judge: 'ËØÑÂßî',
                observer: 'ËßÇÂØüÂëò',
                delegate: '‰ª£Ë°®',
                student: 'Â≠¶Áîü'
            };
            return roleNames[role] || role;
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(timeString) {
            const date = new Date(timeString);
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }

        // ÊªöÂä®Âà∞Â∫ïÈÉ®
        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÊ£ÄÊü•ÂÖÉÁ¥†Áä∂ÊÄÅ...');
            
            // Ê£ÄÊü•ÂõæÁâáÊ®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
            const imageModal = document.getElementById('imageModal');
            console.log('ÂõæÁâáÊ®°ÊÄÅÊ°ÜÊòæÁ§∫Áä∂ÊÄÅ:', imageModal.style.display);
            console.log('ÂõæÁâáÊ®°ÊÄÅÊ°ÜÂèØËßÅÊÄß:', imageModal.style.visibility);
            
            // Á°Æ‰øùÂõæÁâáÊ®°ÊÄÅÊ°ÜÈöêËóè
            imageModal.style.display = 'none';
            imageModal.style.visibility = 'hidden';
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    closeImageModal();
                }
            });
            
            // Ê£ÄÊü•È°µÈù¢Â∫ïÈÉ®ÂÖÉÁ¥†
            console.log('Ê£ÄÊü•È°µÈù¢Â∫ïÈÉ®ÂÖÉÁ¥†...');
            const allElements = document.querySelectorAll('*');
            allElements.forEach(el => {
                const rect = el.getBoundingClientRect();
                if (rect.bottom > window.innerHeight - 50 && rect.height > 10) {
                    console.log('Â∫ïÈÉ®ÂÖÉÁ¥†:', el.tagName, el.className, el.id, el.style.backgroundColor);
                }
            });
            
            initWebSocket();
            
            // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
            const userInfo = localStorage.getItem('userInfo');
            if (userInfo) {
                currentUser = JSON.parse(userInfo);
            }
        });

        // ========== Ë°®ÊÉÖÂíåÂõæÁâáÊåâÈíÆÂäüËÉΩ ==========
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const messageInput = document.getElementById('messageInput');
        const emojis = [
            'üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†','üëª','üëΩ','ü§ñ','üí©','üòà','üëø','üëπ','üë∫','ü§°','üëª','üíÄ','‚ò†Ô∏è','üëΩ'
        ];
        
emojiBtn.addEventListener('click', e => {
  e.stopPropagation();
  // Ê∏≤ÊüìË°®ÊÉÖÈù¢ÊùøÔºà‰ªÖÈ¶ñÊ¨°Ôºâ
  if (!emojiPanel.dataset.inited) {
    emojiPanel.innerHTML = '<div class="emoji-grid">' +
      emojis.map(em => `<span class="emoji-item">${em}</span>`).join('') +
      '</div>';
    emojiPanel.dataset.inited = '1';
  }
  // ÂàáÊç¢ÊòæÁ§∫/ÈöêËóè
  if (emojiPanel.style.display === 'block') {
    emojiPanel.style.display = 'none';
    return;
  }
  // ÊòæÁ§∫ÂâçÈöêÂºèÈöêËóè„ÄÅËÆæÁΩÆÂÆö‰Ωç
  emojiPanel.style.display = 'block';
  emojiPanel.style.position = 'absolute';
  emojiPanel.style.visibility = 'hidden';
  emojiPanel.style.zIndex = '1001';

  // ‰∏ã‰∏ÄÂ∏ßÊµãÂ∞∫ÂØ∏Âπ∂ÂÆö‰Ωç
  requestAnimationFrame(() => {
    const rect = emojiBtn.getBoundingClientRect();
    const { scrollTop, scrollLeft } = document.documentElement;
    const gap = 6;
    const panelW = emojiPanel.offsetWidth;
    const panelH = emojiPanel.offsetHeight;
    // Âü∫Êú¨ÊîæÂú®ÊåâÈíÆÊ≠£‰∏äÊñπÊ∞¥Âπ≥Â±Ö‰∏≠
    let left = scrollLeft + rect.left + (rect.width - panelW) / 2;
    let top  = scrollTop + rect.top - panelH - gap;
    // Â¶ÇÊûú‰∏äÊñπÁ©∫Èó¥‰∏çË∂≥ÔºåÊîæÂà∞ÊåâÈíÆ‰∏ãÊñπ
    if (top < scrollTop) {
      top = scrollTop + rect.bottom + gap;
    }
    emojiPanel.style.left = left + 'px';
    emojiPanel.style.top  = top  + 'px';
    emojiPanel.style.visibility = 'visible';
  });
});
emojiPanel.addEventListener('click', function(e) {
            if (e.target.classList.contains('emoji-item')) {
                const emoji = e.target.textContent;
                const cursorPos = messageInput.selectionStart;
                const textBefore = messageInput.value.substring(0, cursorPos);
                const textAfter = messageInput.value.substring(cursorPos);
                messageInput.value = textBefore + emoji + textAfter;
                messageInput.focus();
                messageInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
                emojiPanel.style.display = 'none';
            }
        });
        document.addEventListener('click', function(e) {
            if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
                emojiPanel.style.display = 'none';
            }
        });
        // ========== ÂõæÁâáÊåâÈíÆÂäüËÉΩ ==========
        const imageBtn = document.getElementById('imageBtn');
        const imageInput = document.getElementById('imageInput');
        let selectedImageFile = null;
        imageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            imageInput.value = '';
            imageInput.click();
        });
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedImageFile = file;
                // Áõ¥Êé•‰∏ä‰º†ÂõæÁâá
                sendImageFile(selectedImageFile);
            }
        });
        async function sendImageFile(file) {
            try {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('roomId', 'test-room');
                const response = await fetch('/api/images/upload', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
                    body: formData
                });
                if (!response.ok) throw new Error('ÂõæÁâá‰∏ä‰º†Â§±Ë¥•');
                const result = await response.json();
                // ÂèëÈÄÅÂõæÁâáÊ∂àÊÅØ
                ws.send(JSON.stringify({
                    type: 'image',
                    content: {
                        url: result.imageUrl,
                        imageId: result.image.id,
                        alt: result.image.originalname || 'ÂõæÁâá'
                    }
                }));
                selectedImageFile = null;
                imageInput.value = '';
            } catch (err) {
                alert('ÂõæÁâá‰∏ä‰º†Â§±Ë¥•: ' + err.message);
            }
        }
        document.addEventListener('click', function(e) {
            if (!imagePreviewPanel.contains(e.target) && e.target !== imageBtn) {
                imagePreviewPanel.style.display = 'none';
            }
        });

        // ========== ÂºïÁî®ÂØπËØùÂäüËÉΩ ==========
        // ÁõëÂê¨ÂºïÁî®ÊåâÈíÆÁÇπÂáª
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('quote-btn')) {
                const msgId = e.target.getAttribute('data-msgid');
                const msg = messages.find(m => m.id === msgId);
                if (msg) {
                    currentQuote = {
                        id: msg.id,
                        fromName: msg.fromName,
                        content: (msg.content && typeof msg.content === 'string') ? msg.content : '[ÂõæÁâá]' // ÁÆÄÂåñÂõæÁâáÂºïÁî®
                    };
                    showQuoteBar();
                }
            }
            if (e.target.id === 'cancelQuoteBtn') {
                currentQuote = null;
                hideQuoteBar();
            }
            if (e.target.classList.contains('revoke-btn')) {
                const id = e.target.getAttribute('data-msgid');
                if (confirm('Á°ÆÂÆöÊí§ÂõûÊ≠§Ê∂àÊÅØ?')) {
                    sendRevoke(id);
                }
            }
            if (e.target.classList.contains('edit-btn')) {
                const id = e.target.getAttribute('data-msgid');
                const msg = messages.find(m => m.id === id);
                if (msg) {
                    const newText = prompt('‰øÆÊîπÊ∂àÊÅØÂÜÖÂÆπ', typeof msg.content === 'string' ? msg.content : '');
                    if (newText !== null) {
                        sendEdit(id, newText);
                    }
                }
            }
            if (e.target.classList.contains('re-edit')) {
                const id = e.target.getAttribute('data-id');
                const content = revokedCache[id] || '';
                const input = document.getElementById('messageInput');
                input.value = content;
                input.focus();
            }
        });
        // ÊòæÁ§∫ÂºïÁî®Êù°
        function showQuoteBar() {
            let bar = document.getElementById('quoteBar');
            if (!bar) {
                bar = document.createElement('div');
                bar.id = 'quoteBar';
                bar.style = 'background:#f5f5f5;border-left:3px solid #0084ff;padding:6px 12px;margin-bottom:4px;color:#555;font-size:13px;display:flex;align-items:center;';
                document.querySelector('.chat-input .input-container').insertAdjacentElement('beforebegin', bar);
            }
            
            if (currentQuote) {
                document.getElementById('quoteFromName').textContent = currentQuote.fromName + 'Ôºö';
                document.getElementById('quoteContent').textContent = currentQuote.content;
                bar.style.display = 'flex';
            } else {
                bar.style.display = 'none';
            }
        }
        function hideQuoteBar() {
            const bar = document.getElementById('quoteBar');
            if (bar) {
                bar.style.display = 'none';
                document.getElementById('quoteFromName').textContent = '';
                document.getElementById('quoteContent').textContent = '';
            }
        }

        // ÂõæÁâáÊ®°ÊÄÅÊ°ÜÂäüËÉΩ
        function openImageModal(src, alt) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = "block";
            modalImg.src = src;
            modalImg.alt = alt;
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = "none";
        }

        // ÂèëÈÄÅÊí§ÂõûÊ∂àÊÅØ
        function sendRevoke(id) {
            if (ws) {
                ws.send(JSON.stringify({ type: 'revokeMessage', messageId: id }));
            }
        }

        // ÁºñËæëÊ∂àÊÅØ
        async function sendEdit(id, newText) {
            try {
                const res = await fetch('/api/messages/' + id, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify({ content: newText })
                });
                await handleApiResponse(res);
                if (res.ok) {
                    const msg = messages.find(m => m.id === id);
                    if (msg) {
                        msg.content = newText;
                        msg.edited = true;
                    }
                    const bubble = document.querySelector('#msg-' + id + ' .message-bubble');
                    if (bubble) bubble.textContent = newText + ' (Â∑≤ÁºñËæë)';
                } else {
                    const err = await res.json();
                    alert(err.error || 'ÁºñËæëÂ§±Ë¥•');
                }
            } catch (err) {
                alert('ÁºñËæëÂ§±Ë¥•: ' + err.message);
            }
        }

        // ÊªöÂä®Âà∞ÊåáÂÆöÊ∂àÊÅØ
        function scrollToMessage(messageId) {
            const messageElement = document.getElementById(`msg-${messageId}`);
            if (messageElement) {
                messageElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Ê∑ªÂä†È´ò‰∫ÆÊïàÊûú
                messageElement.style.backgroundColor = '#fff3cd';
                messageElement.style.border = '2px solid #ffc107';
                messageElement.style.borderRadius = '8px';
                messageElement.style.transition = 'all 0.3s ease';
                
                // 3ÁßíÂêéÁßªÈô§È´ò‰∫Æ
                setTimeout(() => {
                    messageElement.style.backgroundColor = '';
                    messageElement.style.border = '';
                    messageElement.style.borderRadius = '';
                }, 3000);
            }
        }

        // ESCÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });

        // ÂÖ®Â±Äfetch/axiosÊã¶Êà™401ÔºåÁõ¥Êé•Ë∑≥ËΩ¨Âà∞/login
        function handleApiResponse(res) {
            if (res.status === 401) {
                window.location.href = '/login';
                return Promise.reject('Êú™ÁôªÂΩï');
            }
            return res;
        }
    </script>
</body>
</html> 