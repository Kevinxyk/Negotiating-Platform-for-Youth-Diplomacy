<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>研讨室 - 研讨系统</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding-top: 56px; }
    .container { margin-top: 2rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container">
      <a class="navbar-brand" href="/">研讨系统</a>
    </div>
  </nav>
  <div class="container">
    <h2>研讨室：<span id="roomId"></span></h2>
    <!-- 倒计时功能 -->
    <div id="timerSection" class="mb-3">
      <h5>倒计时：<span id="timerDisplay">--:--</span></h5>
      <div id="timerControls" style="display:none;">
        <!-- 自定义时间输入 -->
        <input type="number" id="timerHours" min="0" placeholder="时" class="form-control form-control-sm" style="width:60px; display:inline-block; margin-right:5px;">
        <input type="number" id="timerMinutes" min="0" max="59" placeholder="分" class="form-control form-control-sm" style="width:60px; display:inline-block; margin-right:5px;">
        <input type="number" id="timerSeconds" min="0" max="59" placeholder="秒" class="form-control form-control-sm" style="width:60px; display:inline-block; margin-right:5px;">
        <button id="startTimerBtn" class="btn btn-success btn-sm" style="margin-right:5px;">开始</button>
        <button id="pauseTimerBtn" class="btn btn-warning btn-sm" style="margin-right:5px;">暂停</button>
        <button id="resumeTimerBtn" class="btn btn-primary btn-sm" style="margin-right:5px;">继续</button>
        <button id="resetTimerBtn" class="btn btn-secondary btn-sm">重置</button>
      </div>
    </div>
    <!-- 在线用户列表 -->
    <div id="userListContainer" class="mb-3">
      <h5>在线用户</h5>
      <ul id="userList" class="list-group list-group-horizontal flex-wrap"></ul>
    </div>
    <!-- 文本聊天 -->
    <div id="chatContainer" class="mb-3">
      <h5>群聊</h5>
      <div id="chatMessages" class="border p-2" style="height:300px; overflow-y:auto;"></div>
      <div class="input-group mt-2">
        <input id="messageInput" type="text" class="form-control" placeholder="输入消息...">
        <button id="sendBtn" class="btn btn-primary">发送</button>
      </div>
    </div>
    <!-- 举手功能 -->
    <div class="mb-3">
      <button id="raiseHandBtn" class="btn btn-warning">举手</button>
    </div>
    <!-- 举手通知 -->
    <div id="raiseNotifications" class="mt-3"></div>
    <a href="/rooms" class="btn btn-secondary">返回我的研讨室</a>
  </div>
  <script>
    (async function() {
      // 提取 roomId
      const parts = window.location.pathname.split('/');
      const roomId = parts[2] || '';
      const titleEl = document.getElementById('roomId');
      const container = document.querySelector('.container');
      // 验证登录
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login';
        return;
      }
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      // 请求房间信息
      try {
        const res = await fetch(`/api/rooms/${encodeURIComponent(roomId)}`, {
          headers: {
            'Authorization': 'Bearer ' + token,
            'x-user-role': user.role
          }
        });
        if (res.status === 404) {
          document.title = '研讨室不存在';
          document.body.innerHTML = `
            <div style="display:flex; align-items:center; justify-content:center; height:100vh; flex-direction:column;">
              <h2>研讨室不存在</h2>
              <p>您访问的研讨室 (ID: ${roomId}) 不存在。</p>
              <div style="margin-top:1rem;">
                <a href="/rooms/create" class="btn btn-success me-2">创建新研讨室</a>
                <a href="/rooms" class="btn btn-secondary">返回我的研讨室</a>
              </div>
              <div style="margin-top:1rem; max-width:300px; width:100%;">
                <h5>加入已有研讨室</h5>
                <form id="joinForm" class="d-flex">
                  <input type="text" id="joinRoomName" class="form-control me-2" placeholder="研讨室名称" required />
                  <button type="submit" class="btn btn-primary">加入</button>
                </form>
                <div id="joinError" class="text-danger mt-2"></div>
              </div>
            </div>
          `;
          const joinForm = document.getElementById('joinForm');
          const joinError = document.getElementById('joinError');
          joinForm.addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('joinRoomName').value.trim();
            if (!name) return;
            try {
              const resJoin = await fetch('/api/rooms/join', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': 'Bearer ' + token,
                  'x-user-role': user.role
                },
                body: JSON.stringify({ name })
              });
              if (!resJoin.ok) {
                const errData = await resJoin.json();
                joinError.textContent = errData.error || '加入研讨室失败';
                return;
              }
              const data = await resJoin.json();
              window.location.href = `/rooms/${encodeURIComponent(data.id)}`;
            } catch (err) {
              joinError.textContent = err.message;
            }
          });
          return;
        }
        const room = await res.json();
        // 显示房间详情 (占位)
        document.title = `研讨室 - ${room.name}`;
        titleEl.textContent = `${room.name} (${room.id})`;
        // 可以在此渲染更多 room.settings
        
        // 初始化 WebSocket 连接
        const ws = new WebSocket((location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host);
        ws.binaryType = 'arraybuffer';
        ws.addEventListener('open', () => {
          ws.send(JSON.stringify({
            type: 'join',
            room: roomId,
            name: user.username,
            role: user.role,
            country: user.country || ''
          }));
        });
        
        // 处理 WebSocket 消息
        ws.addEventListener('message', evt => {
          try {
            const data = JSON.parse(evt.data);
            switch (data.type) {
              case 'timer':
                updateTimerDisplay(data.time);
                break;
              case 'userList':
                updateUserList(data.users);
                break;
              case 'chat':
                appendChatMessage(data.fromName, data.content, data.timestamp);
                break;
              case 'system':
                appendChatMessage('系统', data.message, data.timestamp);
                break;
              case 'raiseHand':
                appendRaiseNotification(data.from, data.timestamp);
                break;
            }
          } catch (e) {
            console.error('Invalid message', e);
          }
        });
        
        // 发送消息
        document.getElementById('sendBtn').addEventListener('click', () => {
          const input = document.getElementById('messageInput');
          const msg = input.value.trim();
          if (msg) {
            ws.send(JSON.stringify({ type: 'chat', content: msg }));
            input.value = '';
          }
        });
        document.getElementById('messageInput').addEventListener('keydown', e => {
          if (e.key === 'Enter') document.getElementById('sendBtn').click();
        });
        
        // 举手
        document.getElementById('raiseHandBtn').addEventListener('click', () => {
          ws.send(JSON.stringify({ type: 'raiseHand' }));
        });
        
        // 定时器控制：仅限主持人/管理员/系统
        if (['host','admin','sys'].includes(user.role)) {
          const controls = document.getElementById('timerControls');
          controls.style.display = 'block';
          const startBtn = document.getElementById('startTimerBtn');
          const pauseBtn = document.getElementById('pauseTimerBtn');
          const resumeBtn = document.getElementById('resumeTimerBtn');
          const resetBtn = document.getElementById('resetTimerBtn');
          // 初始状态：只显示"开始"按钮
          startBtn.style.display = 'inline-block';
          pauseBtn.style.display = 'none';
          resumeBtn.style.display = 'none';
          resetBtn.style.display = 'none';
          startBtn.addEventListener('click', () => {
            const h = parseInt(document.getElementById('timerHours').value, 10) || 0;
            const m = parseInt(document.getElementById('timerMinutes').value, 10) || 0;
            const s = parseInt(document.getElementById('timerSeconds').value, 10) || 0;
            const totalSec = h * 3600 + m * 60 + s;
            if (totalSec <= 0) { alert('请输入大于0的时间'); return; }
            ws.send(JSON.stringify({ type: 'timer', action: 'start', time: totalSec }));
            // 切换按钮
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
            resumeBtn.style.display = 'none';
            resetBtn.style.display = 'none';
          });
          pauseBtn.addEventListener('click', () => {
            ws.send(JSON.stringify({ type: 'timer', action: 'pause' }));
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'inline-block';
            resetBtn.style.display = 'inline-block';
          });
          resumeBtn.addEventListener('click', () => {
            ws.send(JSON.stringify({ type: 'timer', action: 'resume' }));
            resumeBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
            resetBtn.style.display = 'inline-block';
          });
          resetBtn.addEventListener('click', () => {
            ws.send(JSON.stringify({ type: 'timer', action: 'reset' }));
            // 重置按钮状态
            startBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'none';
            resetBtn.style.display = 'none';
          });
        }
        
        // 辅助函数
        function updateUserList(users) {
          const ul = document.getElementById('userList'); ul.innerHTML = '';
          users.forEach(u => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = `${u.name}(${u.role})`;
            ul.appendChild(li);
          });
        }
        function appendChatMessage(sender, msg, time) {
          const c = document.getElementById('chatMessages');
          const div = document.createElement('div');
          div.innerHTML = `<strong>${sender}</strong> [${new Date(time).toLocaleTimeString()}]: ${msg}`;
          c.appendChild(div);
          c.scrollTop = c.scrollHeight;
        }
        function appendRaiseNotification(from, timestamp) {
          const r = document.getElementById('raiseNotifications');
          const div = document.createElement('div');
          div.className = 'alert alert-warning';
          div.textContent = `${from} 于 ${new Date(timestamp).toLocaleTimeString()} 举手`;
          r.appendChild(div);
        }
        // 更新倒计时显示
        function updateTimerDisplay(seconds) {
          const el = document.getElementById('timerDisplay');
          if (seconds >= 3600) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            el.textContent = `${h}:${m}:${s}`;
          } else {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            el.textContent = `${m}:${s}`;
          }
        }
      } catch (err) {
        container.innerHTML = `<div class="alert alert-danger mt-4">加载失败：${err.message}</div>`;
      }
    })();
  </script>
</body>
</html> 