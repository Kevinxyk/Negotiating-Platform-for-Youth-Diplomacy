<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>研讨室 - 研讨系统</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body { 
      padding-top: 60px;
      background-color: #f0f2f5; /* 现代应用常用的背景色 */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }
    .container { 
      max-width: 1200px;
    }
    .navbar { 
      height: 56px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      background-color: #ffffff;
    }
    
    /* 卡片式设计 */
    .card-custom {
      background-color: #ffffff;
      border: none;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    /* 用户信息栏 */
    #userInfoBar {
      padding: 1rem;
      border-bottom: 1px solid #e9ecef;
    }

    /* 聊天区域 */
    #chatMessages {
      height: 400px; /* 增加聊天区域高度 */
      padding: 1.5rem;
      overflow-y: auto;
      background-color: #f8f9fa;
    }
    
    /* 聊天消息的整体容器 */
    .chat-message {
      display: flex;
      flex-direction: column; /* 垂直排列：头像/昵称 -> 气泡 */
      margin-bottom: 1.5rem;
    }

    .message-meta {
      display: flex;
      align-items: center;
      margin-bottom: 0.3rem;
      font-size: 0.8rem;
    }
    
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .message-sender {
      font-weight: 500;
      color: #555;
    }

    .message-bubble {
      max-width: 75%;
      padding: 0.6rem 1rem;
      border-radius: 1rem;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    
    .message-content {
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .message-time {
      font-size: 0.75rem;
      float: right;
      clear: both;
      margin-top: 5px;
      margin-left: 10px;
    }
    
    /* Sent messages (yours) */
    .chat-message.sent {
      align-items: flex-end; /* 整体靠右 */
    }
    .chat-message.sent .message-meta {
      flex-direction: row-reverse; /* 元信息反向：昵称 -> 头像 */
    }
    .chat-message.sent .avatar {
      margin-left: 8px; /* 头像和昵称的间距 */
      margin-right: 0;
    }
    .chat-message.sent .message-bubble {
      background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
      color: white;
      border-top-right-radius: 4px;
    }
    .chat-message.sent .message-time {
      color: rgba(255, 255, 255, 0.8);
    }

    /* Received messages (others) */
    .chat-message.received {
      align-items: flex-start; /* 整体靠左 */
    }
    .chat-message.received .message-bubble {
      background: #ffffff;
      color: #212529;
      border-top-left-radius: 4px;
    }
     .chat-message.received .message-time {
      color: #6c757d;
    }

    /* 系统消息 */
    .system-message {
      text-align: center;
      margin: 1rem 0;
      font-size: 0.8rem;
    }
    .system-message span {
      background-color: #e9ecef;
      color: #6c757d;
      padding: 4px 10px;
      border-radius: 12px;
    }

    /* 输入区域美化 */
    #chatInputContainer {
      padding: 1rem;
      border-top: 1px solid #e9ecef;
      background-color: #ffffff;
    }
    #messageInput {
      border-radius: 1.5rem;
      border: 1px solid #dee2e6;
      background-color: #f1f3f5;
    }
    #messageInput:focus {
      background-color: #ffffff;
      border-color: #8ab4f8;
      box-shadow: 0 0 0 2px rgba(78, 140, 255, 0.25);
    }
    
    /* 输入区域按钮 */
    #chatInputContainer .btn {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    
    #sendBtn {
      border-radius: 8px;
      width: auto;
      background-color: #0d6efd;
    }
    
    /* 聊天消息样式 */
    /* 
    .chat-message {
      transition: all 0.3s ease;
    }
    .chat-message.sent {
      justify-content: flex-end;
    }
    .chat-message.sent .message-bubble {
      background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
      color: white;
    }
    .chat-message.sent .message-info .message-time {
      color: rgba(255,255,255,0.7);
    }

    .chat-message.received .message-bubble {
      background: #f1f3f5;
      color: #212529;
    }
    .chat-message.received .message-info .message-time {
      color: #6c757d;
    }
    
    .message-bubble {
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      max-width: fit-content;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message-content {
      font-size: 0.95rem;
    }

    .message-info {
      font-size: 0.75rem;
    }

    .sent .message-sender {
      display: none;
    }
    
    .chat-message.sent > .flex-grow-1 {
      margin-left: auto !important;
      margin-right: 0 !important;
      max-width: 80%;
    }
    */

    /* 议程管理样式 */
    .schedule-item {
      cursor: move;
    }
    .schedule-item.dragging {
      opacity: 0.5;
    }
    .schedule-item .input-group {
      max-width: 200px;
    }
    
    /* 消息气泡菜单样式 */
    .message-bubble {
      position: relative;
    }
    .message-actions {
      position: absolute;
      left: -30px;
      bottom: 0;
      display: none;
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 4px;
    }
    .message-bubble:hover .message-actions {
      display: flex;
      gap: 4px;
    }
    .message-actions button {
      padding: 2px 6px;
      font-size: 12px;
      border: none;
      background: none;
      color: #666;
      cursor: pointer;
    }
    .message-actions button:hover {
      color: #007bff;
    }
    .message-actions button.delete {
      color: #dc3545;
    }
    .message-actions button.delete:hover {
      color: #bd2130;
    }
    
    /* Room management button styles */
    .room-controls {
      margin-bottom: 1.5rem;
    }
    
    /* Timer display styles */
    .timer-display {
      font-size: 2rem;
      font-weight: bold;
      color: #333;
      text-align: center;
      margin-bottom: 1rem;
    }
    
    /* 用户列表样式 */
    #userList {
      max-height: 200px;
      overflow-y: auto;
    }
    
    #userList .list-group-item {
      border: 1px solid #dee2e6;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      min-width: 200px;
      transition: all 0.2s ease;
      background-color: #f8f9fa;
    }
    
    #userList .list-group-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transform: translateY(-2px);
      background-color: #ffffff;
    }
    
    /* 用户信息栏样式 */
    #userInfoBar {
      border: 1px solid #dee2e6;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .user-avatar img {
      border: 2px solid #007bff;
      transition: all 0.3s ease;
    }
    
    .user-avatar img:hover {
      transform: scale(1.1);
      border-color: #0056b3;
    }
    
    /* 表情包面板样式 */
    #emojiPanel {
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
    }
    
    #emojiGrid {
      max-height: 200px;
      overflow-y: auto;
    }
    
    #emojiGrid .btn {
      transition: all 0.2s ease;
    }
    
    #emojiGrid .btn:hover {
      transform: scale(1.1);
      background-color: #e9ecef;
    }
    
    /* 图片上传区域样式 */
    #imageUploadArea {
      z-index: 1000;
    }
    
    #imagePreview {
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 0.5rem;
      background-color: #f8f9fa;
    }
    
    /* 消息中的图片样式 */
    .message-content img {
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }
    
    .message-content img:hover {
      transform: scale(1.05);
    }
    
    /* 用户状态指示器样式 */
    .user-status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
    }
    
    .user-status-online {
      background-color: #28a745;
    }
    
    .user-status-speaking {
      background-color: #007bff;
      animation: pulse 1.5s infinite;
    }
    
    .user-status-raising-hand {
      background-color: #ffc107;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .bi {
      font-size: 1em !important;
      display: inline-block !important;
      vertical-align: middle !important;
    }
    #chatInputContainer .bi {
      font-size: 1.1rem !important;
    }
    #userList .bi {
      font-size: 0.9em !important;
    }

    /* 简洁模式样式 */
    #chatMessages.simple-mode .chat-message {
      display: flex;
      align-items: flex-start;
      margin-bottom: 0.5rem;
      padding: 0.25rem 0;
    }
    
    #chatMessages.simple-mode .message-meta {
      display: none !important; /* 只在简洁模式下隐藏头像和发送者信息 */
    }
    
    #chatMessages.simple-mode .message-bubble {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      border-radius: 0 !important;
      max-width: 100% !important;
      color: #333 !important; /* 确保文字颜色是深色的 */
    }
    
    #chatMessages.simple-mode .message-content {
      display: inline;
      font-size: 0.9rem;
      line-height: 1.4;
      color: #333 !important; /* 确保内容文字是深色的 */
    }
    
    #chatMessages.simple-mode .message-sender {
      font-weight: 600;
      margin-right: 0.5rem;
      color: #333;
    }
    
    #chatMessages.simple-mode .message-time {
      font-size: 0.75rem;
      color: #999;
      margin-left: 0.5rem;
    }
    
    #chatMessages.simple-mode .chat-message.sent {
      justify-content: flex-end;
    }
    
    #chatMessages.simple-mode .chat-message.sent .message-sender {
      order: 2;
      margin-right: 0;
      margin-left: 0.5rem;
    }
    
    #chatMessages.simple-mode .chat-message.sent .message-time {
      order: 1;
      margin-left: 0;
      margin-right: 0.5rem;
    }

    /* 确保气泡模式下头像正常显示 */
    #chatMessages:not(.simple-mode) .message-meta {
      display: flex !important;
    }
    
    #chatMessages:not(.simple-mode) .avatar {
      display: block !important;
    }

    /* 音频消息样式 */
    .audio-message {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      background-color: #f8f9fa;
      border-radius: 0.5rem;
      border: 1px solid #e9ecef;
    }
    
    .audio-message .bi {
      color: #007bff;
      font-size: 1.2rem;
    }
    
    .audio-message audio {
      border-radius: 0.25rem;
    }
    
    .audio-message audio::-webkit-media-controls-panel {
      background-color: #ffffff;
    }
    
    .audio-message audio::-webkit-media-controls-play-button {
      background-color: #007bff;
      border-radius: 50%;
    }

    /* --- Input Area Restyling (User-provided parameters) --- */
    #chatInputContainer .input-group {
      border: 1px solid #ddd;
      border-radius: 25px;
      padding: 5px;
      background: #fff;
    }
    #messageInput.form-control {
      border: none;
      box-shadow: none !important;
      background-color: transparent !important;
      resize: none;
    }
    #chatInputContainer .btn {
      background-color: transparent;
      border: none;
      box-shadow: none;
    }
    #sendBtn {
      background-color: #006aff !important;
      border-radius: 50% !important;
      width: 36px;
      height: 36px;
      padding: 0;
    }
    #sendBtn .bi {
      color: white;
    }
  </style>
  
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container">
      <a class="navbar-brand" href="/">研讨系统</a>
      <div class="ms-auto">
        <span class="badge bg-primary" id="userRoleDisplay"></span>
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>研讨室：<span id="roomId"></span></h2>
      <div>
        <button id="roomManagementBtn" class="btn btn-primary me-2">
          <i class="bi bi-gear"></i> 管理房间
        </button>
        <button id="deleteRoomBtn" class="btn btn-danger">
          <i class="bi bi-trash"></i> 删除房间
        </button>
      </div>
    </div>
    <!-- 倒计时功能 -->
    <div id="timerSection" class="mb-3">
      <div class="timer-display" id="timerDisplay">--:--</div>
      <div id="timerControls" class="d-flex flex-wrap justify-content-center gap-2">
        <!-- 自定义时间输入 -->
        <div class="d-flex align-items-center mb-2" id="timeInputGroup">
          <input type="number" id="timerHours" min="0" placeholder="时" class="form-control form-control-sm" style="width:60px; margin-right:5px;">
          <span>:</span>
          <input type="number" id="timerMinutes" min="0" max="59" placeholder="分" class="form-control form-control-sm" style="width:60px; margin-left:5px; margin-right:5px;">
          <span>:</span>
          <input type="number" id="timerSeconds" min="0" max="59" placeholder="秒" class="form-control form-control-sm" style="width:60px; margin-left:5px; margin-right:10px;">
        </div>
        <div class="d-flex mb-2">
        <button id="startTimerBtn" class="btn btn-success btn-sm" style="margin-right:5px;">开始</button>
        <button id="pauseTimerBtn" class="btn btn-warning btn-sm" style="margin-right:5px; display:none;">暂停</button>
        <button id="resumeTimerBtn" class="btn btn-primary btn-sm" style="margin-right:5px; display:none;">继续</button>
        <button id="resetTimerBtn" class="btn btn-secondary btn-sm">重置</button>
        </div>
      </div>
    </div>
    <!-- 在线用户列表 -->
    <div id="userListContainer" class="mb-3">
      <h5>在线用户</h5>
      <ul id="userList" class="list-group list-group-horizontal flex-wrap"></ul>
    </div>
    
    <!-- 用户信息栏 -->
    <div id="userInfoBar" class="mb-3 p-3 bg-light rounded">
      <div class="d-flex align-items-center">
        <div class="user-avatar me-3">
          <img src="" class="rounded-circle" alt="用户头像" id="currentUserAvatar" style="width:40px; height:40px;">
        </div>
        <div class="user-details flex-grow-1">
          <h6 class="mb-0" id="currentUserName">加载中...</h6>
          <small class="text-muted" id="currentUserInfo">角色 | 国家</small>
        </div>
        <div class="user-status">
          <span class="badge bg-success" id="userStatusBadge">在线</span>
        </div>
      </div>
    </div>
    
    <!-- 文本聊天 -->
    <div id="chatContainer" class="card-custom">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">群聊</h5>
        <!-- 视图切换开关 -->
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="viewSwitch">
          <label class="form-check-label" for="viewSwitch" style="font-size: 0.8rem;">简洁模式</label>
        </div>
      </div>
      <div id="chatMessages" class="mb-3"></div>
      <div id="chatInputContainer">
        <div class="input-group">
          <button class="btn btn-light" type="button" id="emojiBtn" title="表情包" style="min-width: 40px;">
            <i class="bi bi-emoji-smile" style="font-size: 1.1rem;"></i>
          </button>
          <button class="btn btn-light" type="button" id="imageBtn" title="插入图片" style="min-width: 40px;">
            <i class="bi bi-image" style="font-size: 1.1rem;"></i>
          </button>
          <textarea id="messageInput" class="form-control" placeholder="输入消息..." rows="1" style="resize: none;"></textarea>
          <button id="sendBtn" class="btn btn-primary">
            <i class="bi bi-send"></i>
          </button>
        </div>
        <!-- 表情包面板 -->
        <div id="emojiPanel" class="mt-2 p-2 border rounded" style="display: none; background: white; z-index: 1050; position: absolute; bottom: 100%; width: 100%;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-muted">选择表情</small>
            <button type="button" class="btn-close btn-close-sm" id="closeEmojiPanel"></button>
          </div>
          <div id="emojiGrid" class="d-flex flex-wrap gap-1" style="max-height: 200px; overflow-y: auto;">
            <!-- Emojis will be loaded here by JavaScript -->
          </div>
        </div>
        <!-- 图片上传区域 -->
        <div id="imageUploadArea" class="mt-2 p-3 border rounded" style="display: none; background: white; z-index: 1050; position: absolute; bottom: 100%; width: 100%;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-muted">上传图片</small>
            <button type="button" class="btn-close btn-close-sm" id="closeImageUpload"></button>
          </div>
          <input class="form-control mb-2" type="file" id="imageFile" accept="image/*">
          <div id="imagePreviewContainer" class="text-center" style="display: none;">
              <img id="imagePreview" src="#" alt="Image Preview" class="img-fluid rounded" style="max-height: 150px;"/>
          </div>
          <div class="d-flex justify-content-end gap-2 mt-2">
            <button class="btn btn-secondary btn-sm" id="cancelUpload">取消</button>
            <button class="btn btn-primary btn-sm" id="confirmUpload" disabled>上传</button>
          </div>
        </div>
        <div class="mt-2">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="sendMode" id="sendModeEnter" value="enter" checked>
            <label class="form-check-label" for="sendModeEnter">Enter 发送</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="sendMode" id="sendModeCtrlEnter" value="ctrlEnter">
            <label class="form-check-label" for="sendModeCtrlEnter">Ctrl+Enter 发送</label>
          </div>
        </div>
      </div>
    </div>
    <!-- 举手功能 -->
    <div class="mb-3">
      <button id="raiseHandBtn" class="btn btn-warning">举手</button>
    </div>
    <!-- 举手通知 -->
    <div id="raiseNotifications" class="mt-3"></div>
    <!-- 语音聊天 -->
    <div id="audioChatContainer" class="mb-3">
      <h5>语音聊天</h5>
      <div class="mb-2">
        <button id="startAudioBtn" class="btn btn-success me-2">开始语音</button>
        <button id="stopAudioBtn" class="btn btn-danger" style="display:none;">停止语音</button>
      </div>
      <div id="audioParticipants" class="list-group"></div>
    </div>
  </div>
  
  <!-- 消息模板 -->
  <template id="messageTemplate">
    <div class="chat-message">
      <div class="avatar me-3">
        <img src="" alt="User Avatar" class="rounded-circle" style="width:32px; height:32px;">
      </div>
      <div class="message-content-wrapper">
        <div class="message-sender"></div>
        <div class="message-bubble">
          <div class="message-content"></div>
          <div class="message-time"></div>
        </div>
      </div>
    </div>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="/js/auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
  <script>
    // 声明全局WebSocket变量
    let ws;
    
    // 测试Bootstrap Icons是否正确加载
    document.addEventListener('DOMContentLoaded', function() {
      // 检查Bootstrap Icons是否加载
      const testIcon = document.createElement('i');
      testIcon.className = 'bi bi-emoji-smile';
      document.body.appendChild(testIcon);
      
      const computedStyle = window.getComputedStyle(testIcon, '::before');
      const content = computedStyle.content;
      
      if (content && content !== 'none') {
        console.log('Bootstrap Icons 加载成功');
      } else {
        console.warn('Bootstrap Icons 可能未正确加载');
        // 尝试重新加载
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css';
        document.head.appendChild(link);
      }
      
      document.body.removeChild(testIcon);
    });
    
    (async function() {
      // 检查认证状态
      if (!window.auth.checkAuth()) {
        return;
      }

      // 提取 roomId
      const parts = window.location.pathname.split('/');
      const roomId = parts[2] || '';
      const titleEl = document.getElementById('roomId');
      const container = document.querySelector('.container');
      
      // 获取用户信息
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      // 显示用户角色
      const roleDisplay = document.getElementById('userRoleDisplay');
      const roleMap = {
        'host': '主持人',
        'admin': '管理员',
        'sys': '系统管理员',
        'delegate': '代表',
        'observer': '观察者'
      };
      roleDisplay.textContent = roleMap[user.role] || user.role;

      // 请求房间信息
      try {
        const res = await fetch(`/api/rooms/${encodeURIComponent(roomId)}`, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          }
        });

        if (res.status === 404) {
          document.title = '研讨室不存在';
          container.innerHTML = `
            <div class="alert alert-danger mt-4">
              <h4>研讨室不存在</h4>
              <p>您访问的研讨室 (ID: ${roomId}) 不存在。</p>
              <div class="mt-3">
                ${window.auth.checkRole(['host', 'admin', 'sys']) ? 
                  '<a href="/rooms/create" class="btn btn-success me-2">创建新研讨室</a>' : ''}
                <a href="/rooms" class="btn btn-secondary">返回我的研讨室</a>
              </div>
            </div>
          `;
          return;
        }

        const room = await res.json();
        
        // 检查用户是否是房间参与者
        if (!room.participants.some(p => p.userId === user.userId)) {
          container.innerHTML = `
            <div class="alert alert-warning mt-4">
              <h4>未加入研讨室</h4>
              <p>您需要先加入此研讨室才能访问。</p>
              <button class="btn btn-primary" onclick="joinRoom('${roomId}')">加入研讨室</button>
            </div>
          `;
          return;
        }

        // 显示房间详情
        document.title = `研讨室 - ${room.name}`;
        titleEl.textContent = `${room.name} (${room.id})`;
        
        // 根据用户角色更新UI
        window.auth.updateUIByRole();
        
        // 初始化 WebSocket 连接
        ws = new WebSocket((location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host);
        ws.binaryType = 'arraybuffer';
        ws.addEventListener('open', () => {
          ws.send(JSON.stringify({
            type: 'join',
            token: localStorage.getItem('token'),
            room: roomId,
            name: user.username,
            role: user.role,
            country: user.country || ''
          }));
        });
        
        // 消息处理
        ws.onmessage = (event) => {
          // 检查是否是二进制数据（音频）
          if (event.data instanceof ArrayBuffer) {
            handleAudioData(event.data);
            return;
          }
          
          // 处理JSON消息
          try {
            const message = JSON.parse(event.data);
            console.log("Received message:", message);
            switch (message.type) {
              case 'history':
                // 处理历史消息
                const chatMessages = document.getElementById("chatMessages");
                chatMessages.innerHTML = ''; // 清空现有消息
                if (message.messages && Array.isArray(message.messages)) {
                  message.messages.forEach(msg => {
                    displayMessage(msg, true); // isHistory = true
                  });
                }
                chatMessages.scrollTop = chatMessages.scrollHeight; // 滚动到底部
                  break;
              case "chat":
              case "image":
                displayMessage(message);
                  break;
              case "userList":
                updateUserList(message.users);
                  break;
              case "system":
                displaySystemMessage(message.message);
                  break;
              case "error":
                alert(`错误: ${message.message}`);
                break;
              case "timer":
                // Assuming updateTimer function exists or will be restored
                // updateTimer(message.time);
                break;
              case "raise_hand_ack":
                // 举手确认消息
                console.log('Raise hand acknowledged');
                break;
              case "raise_hand_notification":
                // 其他用户举手通知
                const userName = message.userName || message.fromName || "未知用户";
                displaySystemMessage(`${userName} ${message.isRaising ? '举起了手' : '放下了手'}`);
                break;
              case "speaking_status":
                updateSpeakingStatus(message.userId, message.isSpeaking);
                  break;
              case "audio":
                // 处理音频消息
                handleAudioMessage(message);
                break;
              default:
                console.log('Unknown message type:', message.type);
              }
          } catch (error) {
            console.error('Failed to parse message:', error);
          }
        };
        
        ws.onclose = () => {
          console.log('WebSocket connection closed');
          // 处理连接关闭后的逻辑
        };
        
        // 发送聊天消息
        document.getElementById('sendBtn').addEventListener('click', () => {
          sendChatMessage();
        });
        
        document.getElementById('messageInput').addEventListener('keydown', e => {
          const sendMode = document.querySelector('input[name="sendMode"]:checked').value;
          if ((sendMode === 'enter' && e.key === 'Enter' && !e.shiftKey) ||
              (sendMode === 'ctrlEnter' && e.key === 'Enter' && e.ctrlKey)) {
            e.preventDefault();
            sendChatMessage();
          }
        });
        
        let editingMessage = null;

        // 视图切换功能
        const viewSwitch = document.getElementById('viewSwitch');
        const chatMessages = document.getElementById('chatMessages');
        
        // 从localStorage读取用户偏好
        const isSimpleMode = localStorage.getItem('simpleMode') === 'true';
        viewSwitch.checked = isSimpleMode;
        
        function toggleView() {
          if (viewSwitch.checked) {
            chatMessages.classList.add('simple-mode');
            localStorage.setItem('simpleMode', 'true');
          } else {
            chatMessages.classList.remove('simple-mode');
            localStorage.setItem('simpleMode', 'false');
          }
        }
        
        // 初始化视图
        toggleView();
        
        // 监听开关变化
        viewSwitch.addEventListener('change', toggleView);

        // 测试图标加载
        function testIcons() {
          console.log('测试图标加载...');
          
          // 测试表情图标
          const emojiIcon = document.querySelector('#emojiBtn .bi-emoji-smile');
          if (emojiIcon) {
            const computedStyle = window.getComputedStyle(emojiIcon, '::before');
            console.log('表情图标内容:', computedStyle.content);
          }
          
          // 测试图片图标
          const imageIcon = document.querySelector('#imageBtn .bi-image');
          if (imageIcon) {
            const computedStyle = window.getComputedStyle(imageIcon, '::before');
            console.log('图片图标内容:', computedStyle.content);
          }
          
          // 测试发送图标
          const sendIcon = document.querySelector('#sendBtn .bi-send');
          if (sendIcon) {
            const computedStyle = window.getComputedStyle(sendIcon, '::before');
            console.log('发送图标内容:', computedStyle.content);
          }
        }
        
        // 页面加载完成后测试图标
        setTimeout(testIcons, 1000);

        // 统一的头像生成函数
        function generateAvatarUrl(name, size = 40) {
          if (!name) return `https://ui-avatars.com/api/?name=U&background=007bff&color=fff&size=${size}`;
          return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=007bff&color=fff&size=${size}`;
        }

        // =================================================================

        // 添加聊天消息到界面
        function displayMessage(message, isHistory = false) {
          const chatMessages = document.getElementById("chatMessages");
          // FIX: Compare username, not userId, as that's what's stored from login
          const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
          const currentUsername = currentUser.username;
          
          const senderName = message.fromName || message.username || "未知用户";
          const messageClass = senderName === currentUsername ? "sent" : "received";
          
          const content = message.content || message.text;
          const isImage = message.type === 'image' || (typeof content === 'string' && content.startsWith('/uploads/images/'));
          const isAudio = message.type === 'audio';

          const avatarUrl = generateAvatarUrl(senderName);
          const timestamp = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          
          let processedContent;
          if (isImage) {
            processedContent = content;
          } else if (isAudio) {
            // 创建音频播放控件
            processedContent = `<div class="audio-message"><i class="bi bi-mic-fill me-2"></i><audio controls style="max-width: 200px;"><source src="${content}" type="audio/webm">您的浏览器不支持音频播放</audio></div>`;
          } else {
            processedContent = DOMPurify.sanitize(content, { USE_PROFILES: { html: true } });
          }

          // 检查是否处于简洁模式
          const isSimpleMode = chatMessages.classList.contains('simple-mode');
          
          let messageHtml;
          if (isSimpleMode) {
            // 简洁模式：显示发送者名称 + 消息内容 + 时间
            const userInfo = `${senderName} (${message.role || '未知角色'} | ${message.country || '未知国家'})`;
            messageHtml = `<div class="chat-message ${messageClass}" data-message-id="${message.id}"><span class="message-sender">${userInfo}:</span><div class="message-bubble"><div class="message-content">${isImage ? `<img src="${processedContent}" alt="Image" class="img-fluid rounded" style="max-height: 80px;">` : processedContent}</div></div><span class="message-time">${timestamp}</span></div>`;
          } else {
            // 气泡模式：原有的气泡样式
            messageHtml = `<div class="chat-message ${messageClass}" data-message-id="${message.id}"><div class="message-meta"><img src="${avatarUrl}" alt="${senderName}" class="avatar"><span class="message-sender">${senderName}</span></div><div class="message-bubble"><div class="message-content">${isImage ? `<img src="${processedContent}" alt="Image" class="img-fluid rounded">` : processedContent}<span class="message-time">${timestamp}</span></div></div></div>`;
          }
          
          const messageElement = document.createElement('div');
          messageElement.innerHTML = messageHtml.trim();
          const finalElement = messageElement.firstElementChild;

          if (isHistory) {
            finalElement.style.animation = 'none';
            finalElement.style.opacity = '1';
            chatMessages.appendChild(finalElement);
          } else {
            chatMessages.appendChild(finalElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        }
        
        // 更新系统消息样式
        function displaySystemMessage(message) {
          const chatMessages = document.getElementById('chatMessages');
          if (!chatMessages) return;
          const systemMsg = document.createElement('div');
          systemMsg.className = 'system-message';
          systemMsg.innerHTML = `<span>${DOMPurify.sanitize(message)}</span>`;
          chatMessages.appendChild(systemMsg);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 更新用户列表
        function updateUserList(users) {
          const userList = document.getElementById('userList');
          if (!userList) return;
          userList.innerHTML = '';
          for (const user of users) {
            const userItem = document.createElement('li');
            userItem.className = 'list-group-item d-flex align-items-center p-2';
            userItem.style.minWidth = '280px';
            userItem.style.marginRight = '0.5rem';
            userItem.style.marginBottom = '0.5rem';
            userItem.style.borderRadius = '0.5rem';
            
            // 用户头像
            const userAvatar = document.createElement('div');
            userAvatar.className = 'me-2';
            userAvatar.innerHTML = `
              <img src="${generateAvatarUrl(user.name)}" alt="${user.name}" class="rounded-circle" style="width:32px; height:32px;">
            `;
            
            // 用户状态指示器
            const statusIndicator = document.createElement('span');
            statusIndicator.className = 'user-status-indicator user-status-online me-2';
            statusIndicator.style.width = '8px';
            statusIndicator.style.height = '8px';
            statusIndicator.style.borderRadius = '50%';
            statusIndicator.style.backgroundColor = '#28a745';
            
            // 用户信息
            const userInfo = document.createElement('div');
            userInfo.className = 'flex-grow-1';
            
            const userName = document.createElement('div');
            userName.className = 'fw-bold';
            userName.textContent = user.name;
            userName.style.fontSize = '0.9rem';
            
            const userDetails = document.createElement('div');
            userDetails.className = 'text-muted';
            userDetails.style.fontSize = '0.75rem';
            userDetails.textContent = `${user.role} | ${user.country || '未知'}`;
            
            userInfo.appendChild(userName);
            userInfo.appendChild(userDetails);
            
            // 状态图标容器
            const statusIcons = document.createElement('div');
            statusIcons.className = 'd-flex align-items-center gap-1';
            
            // 举手状态 - 使用更好的图标
            if (user.isRaisingHand) {
              const raiseHandIcon = document.createElement('i');
              raiseHandIcon.className = 'bi bi-hand-index text-warning';
              raiseHandIcon.style.fontSize = '1.1rem';
              raiseHandIcon.title = '正在举手';
              statusIcons.appendChild(raiseHandIcon);
            }
            
            // 发言状态
            if (user.isSpeaking) {
              const speakingIcon = document.createElement('i');
              speakingIcon.className = 'bi bi-mic text-primary';
              speakingIcon.style.fontSize = '1.1rem';
              speakingIcon.title = '正在发言';
              statusIcons.appendChild(speakingIcon);
            }
            
            // 静音状态
            if (user.isMuted) {
              const mutedIcon = document.createElement('i');
              mutedIcon.className = 'bi bi-mic-mute text-danger';
              mutedIcon.style.fontSize = '1.1rem';
              mutedIcon.title = '已静音';
              statusIcons.appendChild(mutedIcon);
            }
            
            // 在线状态
            if (user.isOnline) {
              const onlineIcon = document.createElement('i');
              onlineIcon.className = 'bi bi-circle text-success';
              onlineIcon.style.fontSize = '0.8rem';
              onlineIcon.title = '在线';
              statusIcons.appendChild(onlineIcon);
            }
            
            userItem.appendChild(userAvatar);
            userItem.appendChild(statusIndicator);
            userItem.appendChild(userInfo);
            userItem.appendChild(statusIcons);
            userList.appendChild(userItem);
          }
        }

        // 倒计时功能
        let timerInterval = null;
        let timerRunning = false;
        let remainingTime = 0;

        // 更新倒计时按钮显示
        function updateTimerButtons() {
      const startBtn = document.getElementById('startTimerBtn');
      const pauseBtn = document.getElementById('pauseTimerBtn');
      const resumeBtn = document.getElementById('resumeTimerBtn');
      const resetBtn = document.getElementById('resetTimerBtn');
          const timeInputGroup = document.getElementById('timeInputGroup');
          
          if (timerRunning) {
            // 计时器运行中
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
            resumeBtn.style.display = 'none';
            timeInputGroup.style.display = 'none';
          } else if (remainingTime > 0) {
            // 计时器暂停
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'inline-block';
            timeInputGroup.style.display = 'none';
          } else {
            // 计时器未开始
            startBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'none';
            timeInputGroup.style.display = 'flex';
          }
        }

        // 开始倒计时
        document.getElementById('startTimerBtn').addEventListener('click', () => {
          const hours = parseInt(document.getElementById('timerHours').value) || 0;
          const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
          const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
          
          const totalSeconds = hours * 3600 + minutes * 60 + seconds;
          if (totalSeconds <= 0) {
            alert('请输入有效的时间');
          return;
        }
        
          remainingTime = totalSeconds;
          timerRunning = true;
          updateTimerDisplay(remainingTime);
          updateTimerButtons();
          
          timerInterval = setInterval(() => {
            remainingTime--;
            updateTimerDisplay(remainingTime);
            
            if (remainingTime <= 0) {
              clearInterval(timerInterval);
              timerRunning = false;
              updateTimerButtons();
              alert('时间到！');
            }
          }, 1000);
          
          // 发送到服务器
          ws.send(JSON.stringify({ type: 'timer', action: 'start', time: totalSeconds }));
        });

        // 暂停倒计时
        document.getElementById('pauseTimerBtn').addEventListener('click', () => {
          if (timerRunning) {
            clearInterval(timerInterval);
            timerRunning = false;
            updateTimerButtons();
            ws.send(JSON.stringify({ type: 'timer', action: 'pause' }));
          }
        });

        // 继续倒计时
        document.getElementById('resumeTimerBtn').addEventListener('click', () => {
          if (!timerRunning && remainingTime > 0) {
            timerRunning = true;
            updateTimerButtons();
            timerInterval = setInterval(() => {
              remainingTime--;
              updateTimerDisplay(remainingTime);
              
              if (remainingTime <= 0) {
                clearInterval(timerInterval);
                timerRunning = false;
                updateTimerButtons();
                alert('时间到！');
              }
            }, 1000);
            ws.send(JSON.stringify({ type: 'timer', action: 'resume' }));
          }
        });

        // 重置倒计时
        document.getElementById('resetTimerBtn').addEventListener('click', () => {
          clearInterval(timerInterval);
          timerRunning = false;
          remainingTime = 0;
          updateTimerDisplay(0);
          updateTimerButtons();
          ws.send(JSON.stringify({ type: 'timer', action: 'reset' }));
        });

        // 初始化按钮显示
        updateTimerButtons();

        // 更新倒计时显示
        function updateTimerDisplay(seconds) {
          const hours = Math.floor(seconds / 3600);
          const minutes = Math.floor((seconds % 3600) / 60);
          const secs = seconds % 60;
          
          const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
          document.getElementById('timerDisplay').textContent = display;
        }

        // 音频处理函数
        function handleAudioData(audioData) {
          // 处理音频数据的逻辑
          console.log('收到音频数据:', audioData.byteLength, 'bytes');
          
          // 创建音频元素并播放
          const audioBlob = new Blob([audioData], { type: 'audio/wav' });
          const audioUrl = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioUrl);
          
          audio.onloadedmetadata = () => {
            console.log('音频时长:', audio.duration, '秒');
          };
          
          audio.onerror = (error) => {
            console.error('音频播放错误:', error);
          };
          
          audio.play().catch(error => {
            console.error('无法播放音频:', error);
          });
          
          // 清理URL对象
          audio.onended = () => {
            URL.revokeObjectURL(audioUrl);
          };
        }

        // 处理音频消息
        function handleAudioMessage(message) {
          console.log('收到音频消息:', message);
          
          // 显示音频消息在聊天中
          const audioMessage = {
            id: message.id || Date.now(),
            type: 'audio',
            content: message.audioUrl || message.content,
            fromName: message.fromName || message.userName || '未知用户',
            timestamp: message.timestamp || new Date().toISOString(),
            role: message.role,
            country: message.country
          };
          
          displayMessage(audioMessage);
        }

        // 语音聊天功能
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        document.getElementById('startAudioBtn').addEventListener('click', async () => {
          if (isRecording) return;
          
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
              audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
              } 
            });
            
            mediaRecorder = new MediaRecorder(stream, {
              mimeType: 'audio/webm;codecs=opus'
            });
            
            mediaRecorder.ondataavailable = (event) => {
              if (event.data.size > 0) {
                audioChunks.push(event.data);
              }
            };
            
            mediaRecorder.onstop = async () => {
              try {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                console.log('录音完成，大小:', audioBlob.size, 'bytes');
                
                // 发送音频数据到服务器
                ws.send(audioBlob);
                
                // 同时发送音频消息通知
                ws.send(JSON.stringify({
                  type: 'audio_notification',
                  timestamp: new Date().toISOString(),
                  size: audioBlob.size
                }));
                
                audioChunks = [];
                isRecording = false;
                
                // 更新按钮状态
                document.getElementById('startAudioBtn').style.display = 'inline-block';
                document.getElementById('stopAudioBtn').style.display = 'none';
                
              } catch (error) {
                console.error('处理录音数据时出错:', error);
                alert('录音处理失败，请重试');
              }
            };
            
            mediaRecorder.onerror = (event) => {
              console.error('录音错误:', event.error);
              alert('录音出错: ' + event.error.message);
              isRecording = false;
            };
            
            // 开始录音
            mediaRecorder.start(1000); // 每秒收集一次数据
            isRecording = true;
            
            // 更新按钮状态
            document.getElementById('startAudioBtn').style.display = 'none';
            document.getElementById('stopAudioBtn').style.display = 'inline-block';
            
            console.log('开始录音...');
            
          } catch (error) {
            console.error('无法访问麦克风:', error);
            if (error.name === 'NotAllowedError') {
              alert('请允许访问麦克风以使用语音聊天功能');
            } else if (error.name === 'NotFoundError') {
              alert('未找到麦克风设备，请检查设备连接');
            } else {
              alert('无法访问麦克风: ' + error.message);
            }
          }
        });

        document.getElementById('stopAudioBtn').addEventListener('click', () => {
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            console.log('停止录音...');
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
          }
        });

        // 更新用户信息栏
        function updateUserInfoBar() {
          const currentUserName = document.getElementById('currentUserName');
          const currentUserInfo = document.getElementById('currentUserInfo');
          const userStatusBadge = document.getElementById('userStatusBadge');
          const currentUserAvatar = document.getElementById('currentUserAvatar');
          
          if (currentUserName) {
            currentUserName.textContent = user.username;
          }
          if (currentUserInfo) {
            currentUserInfo.textContent = `${roleMap[user.role] || user.role} | ${user.country || '未知'}`;
          }
          if (userStatusBadge) {
            userStatusBadge.textContent = '在线';
            userStatusBadge.className = 'badge bg-success';
          }
          if (currentUserAvatar) {
            currentUserAvatar.src = generateAvatarUrl(user.username, 40);
          }
        }
        
        // 初始化用户信息栏
        updateUserInfoBar();

        // 房间管理功能
        document.getElementById('roomManagementBtn').addEventListener('click', async function() {
          try {
            const response = await fetch(`/api/rooms/${encodeURIComponent(roomId)}`, {
              headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
              }
            });
            
            if (response.ok) {
              const roomData = await response.json();
              
              // 创建管理选项对话框
              const managementOptions = [
                `房间名称：${roomData.name}`,
                `房间ID：${roomData.id}`,
                `参与者数量：${roomData.participants.length}人`,
                '',
                '管理选项：',
                '1. 查看参与者列表',
                '2. 修改房间设置',
                '3. 导出聊天记录',
                '4. 清空聊天记录'
              ].join('\n');
              
              const choice = prompt(managementOptions + '\n\n请输入选项编号（1-4）：');
              
              switch(choice) {
                case '1':
                  const participantsList = roomData.participants.map(p => 
                    `${p.name} (${p.role} | ${p.country || '未知'})`
                  ).join('\n');
                  alert('参与者列表：\n' + participantsList);
                  break;
                case '2':
                  alert('房间设置功能开发中...');
                  break;
                case '3':
                  alert('导出功能开发中...');
                  break;
                case '4':
                  if (confirm('确定要清空所有聊天记录吗？此操作不可撤销。')) {
                    // 这里可以添加清空聊天记录的API调用
                    alert('清空功能开发中...');
                  }
                  break;
                default:
                  alert('无效选项');
              }
            } else {
              alert('获取房间信息失败');
            }
          } catch (error) {
            console.error('房间管理错误:', error);
            alert('房间管理功能暂时不可用');
          }
        });

        // 删除房间功能
        document.getElementById('deleteRoomBtn').addEventListener('click', async function() {
          if (!confirm('确定要删除这个研讨室吗？此操作不可撤销。')) {
            return;
          }
          
          try {
            const response = await fetch(`/api/rooms/${encodeURIComponent(roomId)}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
              }
            });
            
            if (response.ok) {
              alert('研讨室已删除');
              window.location.href = '/rooms';
            } else {
              alert('删除失败，请检查权限');
            }
          } catch (error) {
            console.error('删除房间错误:', error);
            alert('删除失败，请稍后再试');
          }
        });

        // 更新发言状态功能
        function updateSpeakingStatus(userId, isSpeaking) {
          // 更新用户列表中的发言状态
          const userItems = document.querySelectorAll('#userList .list-group-item');
          userItems.forEach(item => {
            const userName = item.querySelector('.fw-bold').textContent;
            // 这里需要根据实际数据结构来匹配用户
            // 暂时简化处理
          });
        }

        // =================================================================
        // =========== 所有功能初始化入口 =================================
        // =================================================================
        initializeRoomFeatures(roomId, user, ws);
        // =================================================================

      } catch (error) {
        console.error('初始化错误:', error);
        alert('初始化失败: ' + error.message);
      }
    })();

    /**
     * 初始化房间的所有交互功能
     * @param {string} roomId 当前房间ID
     * @param {object} user 当前用户信息
     * @param {WebSocket} ws WebSocket实例
     */
    function initializeRoomFeatures(roomId, user, ws) {
      console.log("Initializing all room features...");

      // ------------------ 发送消息逻辑 ------------------
      document.getElementById('sendBtn').addEventListener('click', sendChatMessage);
      document.getElementById('messageInput').addEventListener('keydown', e => {
        const sendMode = document.querySelector('input[name="sendMode"]:checked').value;
        if ((sendMode === 'enter' && e.key === 'Enter' && !e.shiftKey) ||
            (sendMode === 'ctrlEnter' && e.key === 'Enter' && e.ctrlKey)) {
          e.preventDefault();
          sendChatMessage();
        }
      });
      function sendChatMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        if (!message) return;
        ws.send(JSON.stringify({ type: 'chat', content: message }));
        messageInput.value = '';
      }

      // ------------------ 视图切换 ------------------
      const viewSwitch = document.getElementById('viewSwitch');
      const chatMessages = document.getElementById('chatMessages');
      const isSimpleMode = localStorage.getItem('simpleMode') === 'true';
      viewSwitch.checked = isSimpleMode;
      function toggleView() {
        chatMessages.classList.toggle('simple-mode', viewSwitch.checked);
        localStorage.setItem('simpleMode', String(viewSwitch.checked));
      }
      toggleView();
      viewSwitch.addEventListener('change', toggleView);

      // ------------------ 表情功能 ------------------
      const emojiBtn = document.getElementById('emojiBtn');
      const emojiPanel = document.getElementById('emojiPanel');
      const emojiGrid = document.getElementById('emojiGrid');
      const closeEmojiPanel = document.getElementById('closeEmojiPanel');
      const emojis = ['😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇', '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚', '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩', '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣', '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬', '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗', '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😯', '😦', '😧', '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐', '🥴', '🤢', '🤮', '🤧', '😷', '🤒', '🤕', '🤑', '🤠', '👍', '👎', '🙌', '🔥', '🎉', '✨', '⭐', '❤️', '💯'];
      
      function initEmojiPanel() {
        emojiGrid.innerHTML = '';
        emojis.forEach(emoji => {
          const btn = document.createElement('button');
          btn.className = 'btn btn-sm btn-outline-secondary border-0';
          btn.textContent = emoji;
          btn.style.fontSize = '1.2rem';
          btn.onclick = () => {
            const input = document.getElementById('messageInput');
            const cursorPos = input.selectionStart;
            input.value = input.value.substring(0, cursorPos) + emoji + input.value.substring(cursorPos);
            input.focus();
            input.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
          };
          emojiGrid.appendChild(btn);
        });
      }

      emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log("Emoji button clicked!");
        const isHidden = emojiPanel.style.display === 'none' || !emojiPanel.style.display;
        if (isHidden) {
          initEmojiPanel();
          emojiPanel.style.display = 'block';
          document.getElementById('imageUploadArea').style.display = 'none';
        } else {
          emojiPanel.style.display = 'none';
        }
      });
      closeEmojiPanel.addEventListener('click', () => emojiPanel.style.display = 'none');

      // ------------------ 图片上传功能 ------------------
      const imageBtn = document.getElementById('imageBtn');
      const imageUploadArea = document.getElementById('imageUploadArea');
      const closeImageUpload = document.getElementById('closeImageUpload');
      const imageFile = document.getElementById('imageFile');
      const imagePreviewContainer = document.getElementById('imagePreviewContainer');
      const imagePreview = document.getElementById('imagePreview');
      const cancelUpload = document.getElementById('cancelUpload');
      const confirmUpload = document.getElementById('confirmUpload');
      let selectedFile = null;

      function resetImageUpload() {
        imageUploadArea.style.display = 'none';
        imageFile.value = '';
        imagePreviewContainer.style.display = 'none';
        confirmUpload.disabled = true;
        selectedFile = null;
      }

      imageBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log("Image button clicked!");
        const isHidden = imageUploadArea.style.display === 'none' || !imageUploadArea.style.display;
        if (isHidden) {
          imageUploadArea.style.display = 'block';
          document.getElementById('emojiPanel').style.display = 'none';
        } else {
          imageUploadArea.style.display = 'none';
        }
      });
      
      closeImageUpload.addEventListener('click', resetImageUpload);
      cancelUpload.addEventListener('click', resetImageUpload);

      imageFile.addEventListener('change', () => {
        selectedFile = imageFile.files[0];
        if (selectedFile) {
          const reader = new FileReader();
          reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreviewContainer.style.display = 'block';
            confirmUpload.disabled = false;
          };
          reader.readAsDataURL(selectedFile);
        }
      });

      confirmUpload.addEventListener('click', async () => {
        if (!selectedFile) return;
        const formData = new FormData();
        formData.append('image', selectedFile);
        formData.append('roomId', roomId);
        try {
          confirmUpload.disabled = true;
          confirmUpload.textContent = '上传中...';
          const res = await fetch('/api/images/upload', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
            body: formData,
          });
          if (!res.ok) throw new Error((await res.json()).error || 'Upload failed');
          const result = await res.json();
          ws.send(JSON.stringify({
            type: 'image',
            content: result.imageUrl,
            timestamp: new Date().toISOString()
          }));
          resetImageUpload();
        } catch (error) {
          console.error('Image upload error:', error);
          alert(`图片上传失败: ${error.message}`);
        } finally {
          confirmUpload.disabled = false;
          confirmUpload.textContent = '上传';
        }
      });

      // ------------------ 举手功能 ------------------
      const raiseHandBtn = document.getElementById('raiseHandBtn');
      let isRaisingHand = false;
      raiseHandBtn.addEventListener('click', () => {
        isRaisingHand = !isRaisingHand;
        raiseHandBtn.textContent = isRaisingHand ? '放下手' : '举手';
        raiseHandBtn.classList.toggle('btn-success', isRaisingHand);
        raiseHandBtn.classList.toggle('btn-warning', !isRaisingHand);
        ws.send(JSON.stringify({ type: 'raiseHand', isRaising: isRaisingHand }));
        console.log(`举手状态发送: ${isRaisingHand}`);
      });
      
      // ... (此处可以添加其他功能的初始化代码, 如房间管理、删除等)

      // ------------------ 点击外部关闭面板 ------------------
      document.addEventListener('click', (e) => {
        if (emojiPanel && !emojiPanel.contains(e.target) && !emojiBtn.contains(e.target)) {
          emojiPanel.style.display = 'none';
        }
        if (imageUploadArea && !imageUploadArea.contains(e.target) && !imageBtn.contains(e.target)) {
          imageUploadArea.style.display = 'none';
        }
      });

      console.log("All room features initialized.");
    }
  </script>
</body>
</html> 