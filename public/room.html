<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç ”è®¨å®¤ - ç ”è®¨ç³»ç»Ÿ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body { 
      padding-top: 60px;
      background-color: #f0f2f5; /* ç°ä»£åº”ç”¨å¸¸ç”¨çš„èƒŒæ™¯è‰² */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }
    .container { 
      max-width: 1200px;
    }
    .navbar { 
      height: 56px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      background-color: #ffffff;
    }
    
    /* å¡ç‰‡å¼è®¾è®¡ */
    .card-custom {
      background-color: #ffffff;
      border: none;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    /* ç”¨æˆ·ä¿¡æ¯æ  */
    #userInfoBar {
      padding: 1rem;
      border-bottom: 1px solid #e9ecef;
    }

    /* èŠå¤©åŒºåŸŸ */
    #chatMessages {
      height: 400px; /* å¢åŠ èŠå¤©åŒºåŸŸé«˜åº¦ */
      padding: 1.5rem;
      overflow-y: auto;
      background-color: #f8f9fa;
    }
    
    /* èŠå¤©æ¶ˆæ¯çš„æ•´ä½“å®¹å™¨ */
    .chat-message {
      display: flex;
      flex-direction: column; /* å‚ç›´æ’åˆ—ï¼šå¤´åƒ/æ˜µç§° -> æ°”æ³¡ */
      margin-bottom: 1.5rem;
    }

    .message-meta {
      display: flex;
      align-items: center;
      margin-bottom: 0.3rem;
      font-size: 0.8rem;
    }
    
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .message-sender {
      font-weight: 500;
      color: #555;
    }

    .message-bubble {
      max-width: 75%;
      padding: 0.6rem 1rem;
      border-radius: 1rem;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    
    .message-content {
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .message-time {
      font-size: 0.75rem;
      float: right;
      clear: both;
      margin-top: 5px;
      margin-left: 10px;
    }
    
    /* Sent messages (yours) */
    .chat-message.sent {
      align-items: flex-end; /* æ•´ä½“é å³ */
    }
    .chat-message.sent .message-meta {
      flex-direction: row-reverse; /* å…ƒä¿¡æ¯åå‘ï¼šæ˜µç§° -> å¤´åƒ */
    }
    .chat-message.sent .avatar {
      margin-left: 8px; /* å¤´åƒå’Œæ˜µç§°çš„é—´è· */
      margin-right: 0;
    }
    .chat-message.sent .message-bubble {
      background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
      color: white;
      border-top-right-radius: 4px;
    }
    .chat-message.sent .message-time {
      color: rgba(255, 255, 255, 0.8);
    }

    /* Received messages (others) */
    .chat-message.received {
      align-items: flex-start; /* æ•´ä½“é å·¦ */
    }
    .chat-message.received .message-bubble {
      background: #ffffff;
      color: #212529;
      border-top-left-radius: 4px;
    }
     .chat-message.received .message-time {
      color: #6c757d;
    }

    /* ç³»ç»Ÿæ¶ˆæ¯ */
    .system-message {
      text-align: center;
      margin: 1rem 0;
      font-size: 0.8rem;
    }
    .system-message span {
      background-color: #e9ecef;
      color: #6c757d;
      padding: 4px 10px;
      border-radius: 12px;
    }

    /* è¾“å…¥åŒºåŸŸç¾åŒ– */
    #chatInputContainer {
      padding: 1rem;
      border-top: 1px solid #e9ecef;
      background-color: #ffffff;
    }
    #messageInput {
      border-radius: 1.5rem;
      border: 1px solid #dee2e6;
      background-color: #f1f3f5;
    }
    #messageInput:focus {
      background-color: #ffffff;
      border-color: #8ab4f8;
      box-shadow: 0 0 0 2px rgba(78, 140, 255, 0.25);
    }
    
    /* è¾“å…¥åŒºåŸŸæŒ‰é’® */
    #chatInputContainer .btn {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    
    #sendBtn {
      border-radius: 8px;
      width: auto;
      background-color: #0d6efd;
    }
    
    /* èŠå¤©æ¶ˆæ¯æ ·å¼ */
    /* 
    .chat-message {
      transition: all 0.3s ease;
    }
    .chat-message.sent {
      justify-content: flex-end;
    }
    .chat-message.sent .message-bubble {
      background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
      color: white;
    }
    .chat-message.sent .message-info .message-time {
      color: rgba(255,255,255,0.7);
    }

    .chat-message.received .message-bubble {
      background: #f1f3f5;
      color: #212529;
    }
    .chat-message.received .message-info .message-time {
      color: #6c757d;
    }
    
    .message-bubble {
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      max-width: fit-content;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message-content {
      font-size: 0.95rem;
    }

    .message-info {
      font-size: 0.75rem;
    }

    .sent .message-sender {
      display: none;
    }
    
    .chat-message.sent > .flex-grow-1 {
      margin-left: auto !important;
      margin-right: 0 !important;
      max-width: 80%;
    }
    */

    /* è®®ç¨‹ç®¡ç†æ ·å¼ */
    .schedule-item {
      cursor: move;
    }
    .schedule-item.dragging {
      opacity: 0.5;
    }
    .schedule-item .input-group {
      max-width: 200px;
    }
    
    /* æ¶ˆæ¯æ°”æ³¡èœå•æ ·å¼ */
    .message-bubble {
      position: relative;
    }
    .message-actions {
      position: absolute;
      left: -30px;
      bottom: 0;
      display: none;
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 4px;
    }
    .message-bubble:hover .message-actions {
      display: flex;
      gap: 4px;
    }
    .message-actions button {
      padding: 2px 6px;
      font-size: 12px;
      border: none;
      background: none;
      color: #666;
      cursor: pointer;
    }
    .message-actions button:hover {
      color: #007bff;
    }
    .message-actions button.delete {
      color: #dc3545;
    }
    .message-actions button.delete:hover {
      color: #bd2130;
    }
    
    /* Room management button styles */
    .room-controls {
      margin-bottom: 1.5rem;
    }
    
    /* Timer display styles */
    .timer-display {
      font-size: 2rem;
      font-weight: bold;
      color: #333;
      text-align: center;
      margin-bottom: 1rem;
    }
    
    /* ç”¨æˆ·åˆ—è¡¨æ ·å¼ */
    #userList {
      max-height: 200px;
      overflow-y: auto;
    }
    
    #userList .list-group-item {
      border: 1px solid #dee2e6;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      min-width: 200px;
      transition: all 0.2s ease;
      background-color: #f8f9fa;
    }
    
    #userList .list-group-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transform: translateY(-2px);
      background-color: #ffffff;
    }
    
    /* ç”¨æˆ·ä¿¡æ¯æ æ ·å¼ */
    #userInfoBar {
      border: 1px solid #dee2e6;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    
    .user-avatar img {
      border: 2px solid #007bff;
      transition: all 0.3s ease;
    }
    
    .user-avatar img:hover {
      transform: scale(1.1);
      border-color: #0056b3;
    }
    
    /* è¡¨æƒ…åŒ…é¢æ¿æ ·å¼ */
    #emojiPanel {
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
    }
    
    #emojiGrid {
      max-height: 200px;
      overflow-y: auto;
    }
    
    #emojiGrid .btn {
      transition: all 0.2s ease;
    }
    
    #emojiGrid .btn:hover {
      transform: scale(1.1);
      background-color: #e9ecef;
    }
    
    /* å›¾ç‰‡ä¸Šä¼ åŒºåŸŸæ ·å¼ */
    #imageUploadArea {
      z-index: 1000;
    }
    
    #imagePreview {
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 0.5rem;
      background-color: #f8f9fa;
    }
    
    /* æ¶ˆæ¯ä¸­çš„å›¾ç‰‡æ ·å¼ */
    .message-content img {
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s ease;
    }
    
    .message-content img:hover {
      transform: scale(1.05);
    }
    
    /* ç”¨æˆ·çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
    .user-status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 0.5rem;
    }
    
    .user-status-online {
      background-color: #28a745;
    }
    
    .user-status-speaking {
      background-color: #007bff;
      animation: pulse 1.5s infinite;
    }
    
    .user-status-raising-hand {
      background-color: #ffc107;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .bi {
      font-size: 1em !important;
      display: inline-block !important;
      vertical-align: middle !important;
    }
    #chatInputContainer .bi {
      font-size: 1.1rem !important;
    }
    #userList .bi {
      font-size: 0.9em !important;
    }

    /* ç®€æ´æ¨¡å¼æ ·å¼ */
    #chatMessages.simple-mode .chat-message {
      display: flex;
      align-items: flex-start;
      margin-bottom: 0.5rem;
      padding: 0.25rem 0;
    }
    
    #chatMessages.simple-mode .message-meta {
      display: none !important; /* åªåœ¨ç®€æ´æ¨¡å¼ä¸‹éšè—å¤´åƒå’Œå‘é€è€…ä¿¡æ¯ */
    }
    
    #chatMessages.simple-mode .message-bubble {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
      padding: 0 !important;
      border-radius: 0 !important;
      max-width: 100% !important;
      color: #333 !important; /* ç¡®ä¿æ–‡å­—é¢œè‰²æ˜¯æ·±è‰²çš„ */
    }
    
    #chatMessages.simple-mode .message-content {
      display: inline;
      font-size: 0.9rem;
      line-height: 1.4;
      color: #333 !important; /* ç¡®ä¿å†…å®¹æ–‡å­—æ˜¯æ·±è‰²çš„ */
    }
    
    #chatMessages.simple-mode .message-sender {
      font-weight: 600;
      margin-right: 0.5rem;
      color: #333;
    }
    
    #chatMessages.simple-mode .message-time {
      font-size: 0.75rem;
      color: #999;
      margin-left: 0.5rem;
    }
    
    #chatMessages.simple-mode .chat-message.sent {
      justify-content: flex-end;
    }
    
    #chatMessages.simple-mode .chat-message.sent .message-sender {
      order: 2;
      margin-right: 0;
      margin-left: 0.5rem;
    }
    
    #chatMessages.simple-mode .chat-message.sent .message-time {
      order: 1;
      margin-left: 0;
      margin-right: 0.5rem;
    }

    /* ç¡®ä¿æ°”æ³¡æ¨¡å¼ä¸‹å¤´åƒæ­£å¸¸æ˜¾ç¤º */
    #chatMessages:not(.simple-mode) .message-meta {
      display: flex !important;
    }
    
    #chatMessages:not(.simple-mode) .avatar {
      display: block !important;
    }

    /* éŸ³é¢‘æ¶ˆæ¯æ ·å¼ */
    .audio-message {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      background-color: #f8f9fa;
      border-radius: 0.5rem;
      border: 1px solid #e9ecef;
    }
    
    .audio-message .bi {
      color: #007bff;
      font-size: 1.2rem;
    }
    
    .audio-message audio {
      border-radius: 0.25rem;
    }
    
    .audio-message audio::-webkit-media-controls-panel {
      background-color: #ffffff;
    }
    
    .audio-message audio::-webkit-media-controls-play-button {
      background-color: #007bff;
      border-radius: 50%;
    }

    /* --- Input Area Restyling (User-provided parameters) --- */
    #chatInputContainer .input-group {
      border: 1px solid #ddd;
      border-radius: 25px;
      padding: 5px;
      background: #fff;
    }
    #messageInput.form-control {
      border: none;
      box-shadow: none !important;
      background-color: transparent !important;
      resize: none;
    }
    #chatInputContainer .btn {
      background-color: transparent;
      border: none;
      box-shadow: none;
    }
    #sendBtn {
      background-color: #006aff !important;
      border-radius: 50% !important;
      width: 36px;
      height: 36px;
      padding: 0;
    }
    #sendBtn .bi {
      color: white;
    }
  </style>
  
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container">
      <a class="navbar-brand" href="/">ç ”è®¨ç³»ç»Ÿ</a>
      <div class="ms-auto">
        <span class="badge bg-primary" id="userRoleDisplay"></span>
      </div>
    </div>
  </nav>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>ç ”è®¨å®¤ï¼š<span id="roomId"></span></h2>
      <div>
        <button id="roomManagementBtn" class="btn btn-primary me-2">
          <i class="bi bi-gear"></i> ç®¡ç†æˆ¿é—´
        </button>
        <button id="deleteRoomBtn" class="btn btn-danger">
          <i class="bi bi-trash"></i> åˆ é™¤æˆ¿é—´
        </button>
      </div>
    </div>
    <!-- å€’è®¡æ—¶åŠŸèƒ½ -->
    <div id="timerSection" class="mb-3">
      <div class="timer-display" id="timerDisplay">--:--</div>
      <div id="timerControls" class="d-flex flex-wrap justify-content-center gap-2">
        <!-- è‡ªå®šä¹‰æ—¶é—´è¾“å…¥ -->
        <div class="d-flex align-items-center mb-2" id="timeInputGroup">
          <input type="number" id="timerHours" min="0" placeholder="æ—¶" class="form-control form-control-sm" style="width:60px; margin-right:5px;">
          <span>:</span>
          <input type="number" id="timerMinutes" min="0" max="59" placeholder="åˆ†" class="form-control form-control-sm" style="width:60px; margin-left:5px; margin-right:5px;">
          <span>:</span>
          <input type="number" id="timerSeconds" min="0" max="59" placeholder="ç§’" class="form-control form-control-sm" style="width:60px; margin-left:5px; margin-right:10px;">
        </div>
        <div class="d-flex mb-2">
        <button id="startTimerBtn" class="btn btn-success btn-sm" style="margin-right:5px;">å¼€å§‹</button>
        <button id="pauseTimerBtn" class="btn btn-warning btn-sm" style="margin-right:5px; display:none;">æš‚åœ</button>
        <button id="resumeTimerBtn" class="btn btn-primary btn-sm" style="margin-right:5px; display:none;">ç»§ç»­</button>
        <button id="resetTimerBtn" class="btn btn-secondary btn-sm">é‡ç½®</button>
        </div>
      </div>
    </div>
    <!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
    <div id="userListContainer" class="mb-3">
      <h5>åœ¨çº¿ç”¨æˆ·</h5>
      <ul id="userList" class="list-group list-group-horizontal flex-wrap"></ul>
    </div>
    
    <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
    <div id="userInfoBar" class="mb-3 p-3 bg-light rounded">
      <div class="d-flex align-items-center">
        <div class="user-avatar me-3">
          <img src="" class="rounded-circle" alt="ç”¨æˆ·å¤´åƒ" id="currentUserAvatar" style="width:40px; height:40px;">
        </div>
        <div class="user-details flex-grow-1">
          <h6 class="mb-0" id="currentUserName">åŠ è½½ä¸­...</h6>
          <small class="text-muted" id="currentUserInfo">è§’è‰² | å›½å®¶</small>
        </div>
        <div class="user-status">
          <span class="badge bg-success" id="userStatusBadge">åœ¨çº¿</span>
        </div>
      </div>
    </div>
    
    <!-- æ–‡æœ¬èŠå¤© -->
    <div id="chatContainer" class="card-custom">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">ç¾¤èŠ</h5>
        <!-- è§†å›¾åˆ‡æ¢å¼€å…³ -->
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="viewSwitch">
          <label class="form-check-label" for="viewSwitch" style="font-size: 0.8rem;">ç®€æ´æ¨¡å¼</label>
        </div>
      </div>
      <div id="chatMessages" class="mb-3"></div>
      <div id="chatInputContainer">
        <div class="input-group">
          <button class="btn btn-light" type="button" id="emojiBtn" title="è¡¨æƒ…åŒ…" style="min-width: 40px;">
            <i class="bi bi-emoji-smile" style="font-size: 1.1rem;"></i>
          </button>
          <button class="btn btn-light" type="button" id="imageBtn" title="æ’å…¥å›¾ç‰‡" style="min-width: 40px;">
            <i class="bi bi-image" style="font-size: 1.1rem;"></i>
          </button>
          <textarea id="messageInput" class="form-control" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" style="resize: none;"></textarea>
          <button id="sendBtn" class="btn btn-primary">
            <i class="bi bi-send"></i>
          </button>
        </div>
        <!-- è¡¨æƒ…åŒ…é¢æ¿ -->
        <div id="emojiPanel" class="mt-2 p-2 border rounded" style="display: none; background: white; z-index: 1050; position: absolute; bottom: 100%; width: 100%;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-muted">é€‰æ‹©è¡¨æƒ…</small>
            <button type="button" class="btn-close btn-close-sm" id="closeEmojiPanel"></button>
          </div>
          <div id="emojiGrid" class="d-flex flex-wrap gap-1" style="max-height: 200px; overflow-y: auto;">
            <!-- Emojis will be loaded here by JavaScript -->
          </div>
        </div>
        <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
        <div id="imageUploadArea" class="mt-2 p-3 border rounded" style="display: none; background: white; z-index: 1050; position: absolute; bottom: 100%; width: 100%;">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small class="text-muted">ä¸Šä¼ å›¾ç‰‡</small>
            <button type="button" class="btn-close btn-close-sm" id="closeImageUpload"></button>
          </div>
          <input class="form-control mb-2" type="file" id="imageFile" accept="image/*">
          <div id="imagePreviewContainer" class="text-center" style="display: none;">
              <img id="imagePreview" src="#" alt="Image Preview" class="img-fluid rounded" style="max-height: 150px;"/>
          </div>
          <div class="d-flex justify-content-end gap-2 mt-2">
            <button class="btn btn-secondary btn-sm" id="cancelUpload">å–æ¶ˆ</button>
            <button class="btn btn-primary btn-sm" id="confirmUpload" disabled>ä¸Šä¼ </button>
          </div>
        </div>
        <div class="mt-2">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="sendMode" id="sendModeEnter" value="enter" checked>
            <label class="form-check-label" for="sendModeEnter">Enter å‘é€</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="sendMode" id="sendModeCtrlEnter" value="ctrlEnter">
            <label class="form-check-label" for="sendModeCtrlEnter">Ctrl+Enter å‘é€</label>
          </div>
        </div>
      </div>
    </div>
    <!-- ä¸¾æ‰‹åŠŸèƒ½ -->
    <div class="mb-3">
      <button id="raiseHandBtn" class="btn btn-warning">ä¸¾æ‰‹</button>
    </div>
    <!-- ä¸¾æ‰‹é€šçŸ¥ -->
    <div id="raiseNotifications" class="mt-3"></div>
    <!-- è¯­éŸ³èŠå¤© -->
    <div id="audioChatContainer" class="mb-3">
      <h5>è¯­éŸ³èŠå¤©</h5>
      <div class="mb-2">
        <button id="startAudioBtn" class="btn btn-success me-2">å¼€å§‹è¯­éŸ³</button>
        <button id="stopAudioBtn" class="btn btn-danger" style="display:none;">åœæ­¢è¯­éŸ³</button>
      </div>
      <div id="audioParticipants" class="list-group"></div>
    </div>
  </div>
  
  <!-- æ¶ˆæ¯æ¨¡æ¿ -->
  <template id="messageTemplate">
    <div class="chat-message">
      <div class="avatar me-3">
        <img src="" alt="User Avatar" class="rounded-circle" style="width:32px; height:32px;">
      </div>
      <div class="message-content-wrapper">
        <div class="message-sender"></div>
        <div class="message-bubble">
          <div class="message-content"></div>
          <div class="message-time"></div>
        </div>
      </div>
    </div>
  </template>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="/js/auth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
  <script>
    // å£°æ˜å…¨å±€WebSocketå˜é‡
    let ws;
    
    // æµ‹è¯•Bootstrap Iconsæ˜¯å¦æ­£ç¡®åŠ è½½
    document.addEventListener('DOMContentLoaded', function() {
      // æ£€æŸ¥Bootstrap Iconsæ˜¯å¦åŠ è½½
      const testIcon = document.createElement('i');
      testIcon.className = 'bi bi-emoji-smile';
      document.body.appendChild(testIcon);
      
      const computedStyle = window.getComputedStyle(testIcon, '::before');
      const content = computedStyle.content;
      
      if (content && content !== 'none') {
        console.log('Bootstrap Icons åŠ è½½æˆåŠŸ');
      } else {
        console.warn('Bootstrap Icons å¯èƒ½æœªæ­£ç¡®åŠ è½½');
        // å°è¯•é‡æ–°åŠ è½½
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css';
        document.head.appendChild(link);
      }
      
      document.body.removeChild(testIcon);
    });
    
    (async function() {
      // æ£€æŸ¥è®¤è¯çŠ¶æ€
      if (!window.auth.checkAuth()) {
        return;
      }

      // æå– roomId
      const parts = window.location.pathname.split('/');
      const roomId = parts[2] || '';
      const titleEl = document.getElementById('roomId');
      const container = document.querySelector('.container');
      
      // è·å–ç”¨æˆ·ä¿¡æ¯
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      // æ˜¾ç¤ºç”¨æˆ·è§’è‰²
      const roleDisplay = document.getElementById('userRoleDisplay');
      const roleMap = {
        'host': 'ä¸»æŒäºº',
        'admin': 'ç®¡ç†å‘˜',
        'sys': 'ç³»ç»Ÿç®¡ç†å‘˜',
        'delegate': 'ä»£è¡¨',
        'observer': 'è§‚å¯Ÿè€…'
      };
      roleDisplay.textContent = roleMap[user.role] || user.role;

      // è¯·æ±‚æˆ¿é—´ä¿¡æ¯
      try {
        const res = await fetch(`/api/rooms/${encodeURIComponent(roomId)}`, {
          headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
          }
        });

        if (res.status === 404) {
          document.title = 'ç ”è®¨å®¤ä¸å­˜åœ¨';
          container.innerHTML = `
            <div class="alert alert-danger mt-4">
              <h4>ç ”è®¨å®¤ä¸å­˜åœ¨</h4>
              <p>æ‚¨è®¿é—®çš„ç ”è®¨å®¤ (ID: ${roomId}) ä¸å­˜åœ¨ã€‚</p>
              <div class="mt-3">
                ${window.auth.checkRole(['host', 'admin', 'sys']) ? 
                  '<a href="/rooms/create" class="btn btn-success me-2">åˆ›å»ºæ–°ç ”è®¨å®¤</a>' : ''}
                <a href="/rooms" class="btn btn-secondary">è¿”å›æˆ‘çš„ç ”è®¨å®¤</a>
              </div>
            </div>
          `;
          return;
        }

        const room = await res.json();
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯æˆ¿é—´å‚ä¸è€…
        if (!room.participants.some(p => p.userId === user.userId)) {
          container.innerHTML = `
            <div class="alert alert-warning mt-4">
              <h4>æœªåŠ å…¥ç ”è®¨å®¤</h4>
              <p>æ‚¨éœ€è¦å…ˆåŠ å…¥æ­¤ç ”è®¨å®¤æ‰èƒ½è®¿é—®ã€‚</p>
              <button class="btn btn-primary" onclick="joinRoom('${roomId}')">åŠ å…¥ç ”è®¨å®¤</button>
            </div>
          `;
          return;
        }

        // æ˜¾ç¤ºæˆ¿é—´è¯¦æƒ…
        document.title = `ç ”è®¨å®¤ - ${room.name}`;
        titleEl.textContent = `${room.name} (${room.id})`;
        
        // æ ¹æ®ç”¨æˆ·è§’è‰²æ›´æ–°UI
        window.auth.updateUIByRole();
        
        // åˆå§‹åŒ– WebSocket è¿æ¥
        ws = new WebSocket((location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host);
        ws.binaryType = 'arraybuffer';
        ws.addEventListener('open', () => {
          ws.send(JSON.stringify({
            type: 'join',
            token: localStorage.getItem('token'),
            room: roomId,
            name: user.username,
            role: user.role,
            country: user.country || ''
          }));
        });
        
        // æ¶ˆæ¯å¤„ç†
        ws.onmessage = (event) => {
          // æ£€æŸ¥æ˜¯å¦æ˜¯äºŒè¿›åˆ¶æ•°æ®ï¼ˆéŸ³é¢‘ï¼‰
          if (event.data instanceof ArrayBuffer) {
            handleAudioData(event.data);
            return;
          }
          
          // å¤„ç†JSONæ¶ˆæ¯
          try {
            const message = JSON.parse(event.data);
            console.log("Received message:", message);
            switch (message.type) {
              case 'history':
                // å¤„ç†å†å²æ¶ˆæ¯
                const chatMessages = document.getElementById("chatMessages");
                chatMessages.innerHTML = ''; // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
                if (message.messages && Array.isArray(message.messages)) {
                  message.messages.forEach(msg => {
                    displayMessage(msg, true); // isHistory = true
                  });
                }
                chatMessages.scrollTop = chatMessages.scrollHeight; // æ»šåŠ¨åˆ°åº•éƒ¨
                  break;
              case "chat":
              case "image":
                displayMessage(message);
                  break;
              case "userList":
                updateUserList(message.users);
                  break;
              case "system":
                displaySystemMessage(message.message);
                  break;
              case "error":
                alert(`é”™è¯¯: ${message.message}`);
                break;
              case "timer":
                // Assuming updateTimer function exists or will be restored
                // updateTimer(message.time);
                break;
              case "raise_hand_ack":
                // ä¸¾æ‰‹ç¡®è®¤æ¶ˆæ¯
                console.log('Raise hand acknowledged');
                break;
              case "raise_hand_notification":
                // å…¶ä»–ç”¨æˆ·ä¸¾æ‰‹é€šçŸ¥
                const userName = message.userName || message.fromName || "æœªçŸ¥ç”¨æˆ·";
                displaySystemMessage(`${userName} ${message.isRaising ? 'ä¸¾èµ·äº†æ‰‹' : 'æ”¾ä¸‹äº†æ‰‹'}`);
                break;
              case "speaking_status":
                updateSpeakingStatus(message.userId, message.isSpeaking);
                  break;
              case "audio":
                // å¤„ç†éŸ³é¢‘æ¶ˆæ¯
                handleAudioMessage(message);
                break;
              default:
                console.log('Unknown message type:', message.type);
              }
          } catch (error) {
            console.error('Failed to parse message:', error);
          }
        };
        
        ws.onclose = () => {
          console.log('WebSocket connection closed');
          // å¤„ç†è¿æ¥å…³é—­åçš„é€»è¾‘
        };
        
        // å‘é€èŠå¤©æ¶ˆæ¯
        document.getElementById('sendBtn').addEventListener('click', () => {
          sendChatMessage();
        });
        
        document.getElementById('messageInput').addEventListener('keydown', e => {
          const sendMode = document.querySelector('input[name="sendMode"]:checked').value;
          if ((sendMode === 'enter' && e.key === 'Enter' && !e.shiftKey) ||
              (sendMode === 'ctrlEnter' && e.key === 'Enter' && e.ctrlKey)) {
            e.preventDefault();
            sendChatMessage();
          }
        });
        
        let editingMessage = null;

        // è§†å›¾åˆ‡æ¢åŠŸèƒ½
        const viewSwitch = document.getElementById('viewSwitch');
        const chatMessages = document.getElementById('chatMessages');
        
        // ä»localStorageè¯»å–ç”¨æˆ·åå¥½
        const isSimpleMode = localStorage.getItem('simpleMode') === 'true';
        viewSwitch.checked = isSimpleMode;
        
        function toggleView() {
          if (viewSwitch.checked) {
            chatMessages.classList.add('simple-mode');
            localStorage.setItem('simpleMode', 'true');
          } else {
            chatMessages.classList.remove('simple-mode');
            localStorage.setItem('simpleMode', 'false');
          }
        }
        
        // åˆå§‹åŒ–è§†å›¾
        toggleView();
        
        // ç›‘å¬å¼€å…³å˜åŒ–
        viewSwitch.addEventListener('change', toggleView);

        // æµ‹è¯•å›¾æ ‡åŠ è½½
        function testIcons() {
          console.log('æµ‹è¯•å›¾æ ‡åŠ è½½...');
          
          // æµ‹è¯•è¡¨æƒ…å›¾æ ‡
          const emojiIcon = document.querySelector('#emojiBtn .bi-emoji-smile');
          if (emojiIcon) {
            const computedStyle = window.getComputedStyle(emojiIcon, '::before');
            console.log('è¡¨æƒ…å›¾æ ‡å†…å®¹:', computedStyle.content);
          }
          
          // æµ‹è¯•å›¾ç‰‡å›¾æ ‡
          const imageIcon = document.querySelector('#imageBtn .bi-image');
          if (imageIcon) {
            const computedStyle = window.getComputedStyle(imageIcon, '::before');
            console.log('å›¾ç‰‡å›¾æ ‡å†…å®¹:', computedStyle.content);
          }
          
          // æµ‹è¯•å‘é€å›¾æ ‡
          const sendIcon = document.querySelector('#sendBtn .bi-send');
          if (sendIcon) {
            const computedStyle = window.getComputedStyle(sendIcon, '::before');
            console.log('å‘é€å›¾æ ‡å†…å®¹:', computedStyle.content);
          }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæµ‹è¯•å›¾æ ‡
        setTimeout(testIcons, 1000);

        // ç»Ÿä¸€çš„å¤´åƒç”Ÿæˆå‡½æ•°
        function generateAvatarUrl(name, size = 40) {
          if (!name) return `https://ui-avatars.com/api/?name=U&background=007bff&color=fff&size=${size}`;
          return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=007bff&color=fff&size=${size}`;
        }

        // æ·»åŠ å‘é€æ¶ˆæ¯å‡½æ•°
        function sendChatMessage() {
          const messageInput = document.getElementById('messageInput');
          const message = messageInput.value.trim();

          if (!message) return;

          console.log('å‘é€æ¶ˆæ¯:', message);
          
          // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
          ws.send(JSON.stringify({
            type: 'chat',
            content: message
          }));

          // æ¸…ç©ºè¾“å…¥æ¡†
          messageInput.value = '';
        }

        // =================================================================
        // =========== è¡¨æƒ…å’Œå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ (å¼€å§‹) ============================
        // =================================================================

        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPanel = document.getElementById('emojiPanel');
        const emojiGrid = document.getElementById('emojiGrid');
        const closeEmojiPanel = document.getElementById('closeEmojiPanel');

        const imageBtn = document.getElementById('imageBtn');
        const imageUploadArea = document.getElementById('imageUploadArea');
        const closeImageUpload = document.getElementById('closeImageUpload');
        const imageFile = document.getElementById('imageFile');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const cancelUpload = document.getElementById('cancelUpload');
        const confirmUpload = document.getElementById('confirmUpload');
        let selectedFile = null;

        const emojis = ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£', 'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤', 'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ‘', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ”¥', 'ğŸ‰', 'âœ¨', 'â­', 'â¤ï¸', 'ğŸ’¯'];

        function initEmojiPanel() {
            emojiGrid.innerHTML = '';
            emojis.forEach(emoji => {
                const emojiElement = document.createElement('button');
                emojiElement.className = 'btn btn-sm btn-outline-secondary border-0';
                emojiElement.textContent = emoji;
                emojiElement.style.fontSize = '1.2rem';
                emojiElement.onclick = () => {
                    const messageInput = document.getElementById('messageInput');
                    const cursorPos = messageInput.selectionStart;
                    const textBefore = messageInput.value.substring(0, cursorPos);
                    const textAfter = messageInput.value.substring(cursorPos);
                    messageInput.value = textBefore + emoji + textAfter;
                    messageInput.focus();
                    messageInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
                };
                emojiGrid.appendChild(emojiElement);
            });
        }

        function emojiBtnClickHandler(e) {
            console.log("Emoji button clicked!");
            e.stopPropagation();
            const isHidden = emojiPanel.style.display === 'none' || emojiPanel.style.display === '';
            if (isHidden) {
                initEmojiPanel();
                emojiPanel.style.display = 'block';
                imageUploadArea.style.display = 'none'; // å…³é—­å›¾ç‰‡ä¸Šä¼ 
            } else {
                emojiPanel.style.display = 'none';
            }
        }
        function closeEmojiPanelHandler() {
            console.log("Close emoji panel clicked!");
            emojiPanel.style.display = 'none';
        }
        function imageBtnClickHandler(e) {
            console.log("Image button clicked!");
            e.stopPropagation();
            const isHidden = imageUploadArea.style.display === 'none' || imageUploadArea.style.display === '';
            if (isHidden) {
                imageUploadArea.style.display = 'block';
                emojiPanel.style.display = 'none'; // å…³é—­è¡¨æƒ…é¢æ¿
            } else {
                imageUploadArea.style.display = 'none';
            }
        }
        function resetImageUpload() {
            imageUploadArea.style.display = 'none';
            imageFile.value = '';
            imagePreviewContainer.style.display = 'none';
            confirmUpload.disabled = true;
            selectedFile = null;
        }
        function closeImageUploadHandler() { resetImageUpload(); }
        function cancelUploadHandler() { resetImageUpload(); }
        function imageFileChangeHandler() {
            selectedFile = imageFile.files[0];
            if (selectedFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    imagePreviewContainer.style.display = 'block';
                    confirmUpload.disabled = false;
                };
                reader.readAsDataURL(selectedFile);
            } else {
                resetImageUpload();
            }
        }
        async function confirmUploadHandler() {
            if (!selectedFile) return;
            const formData = new FormData();
            formData.append('image', selectedFile);
            formData.append('roomId', roomId);
            try {
                confirmUpload.disabled = true;
                confirmUpload.textContent = 'ä¸Šä¼ ä¸­...';
                const response = await fetch('/api/images/upload', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
                    body: formData,
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Upload failed with status ${response.status}`);
                }
                const result = await response.json();
                ws.send(JSON.stringify({
                    type: 'image',
                    content: result.imageUrl,
                    timestamp: new Date().toISOString()
                }));
                resetImageUpload();
            } catch (error) {
                console.error('Image upload error:', error);
                alert(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`);
            } finally {
                confirmUpload.disabled = false;
                confirmUpload.textContent = 'ä¸Šä¼ ';
            }
        }

        // ---- å…ˆè§£ç»‘å†ç»‘å®šï¼Œç¡®ä¿åªç»‘å®šä¸€æ¬¡ ----
        if (emojiBtn) {
          emojiBtn.removeEventListener('click', emojiBtnClickHandler);
          emojiBtn.addEventListener('click', emojiBtnClickHandler);
        }
        if (closeEmojiPanel) {
          closeEmojiPanel.removeEventListener('click', closeEmojiPanelHandler);
          closeEmojiPanel.addEventListener('click', closeEmojiPanelHandler);
        }
        if (imageBtn) {
          imageBtn.removeEventListener('click', imageBtnClickHandler);
          imageBtn.addEventListener('click', imageBtnClickHandler);
        }
        if (closeImageUpload) {
          closeImageUpload.removeEventListener('click', closeImageUploadHandler);
          closeImageUpload.addEventListener('click', closeImageUploadHandler);
        }
        if (cancelUpload) {
          cancelUpload.removeEventListener('click', cancelUploadHandler);
          cancelUpload.addEventListener('click', cancelUploadHandler);
        }
        if (imageFile) {
          imageFile.removeEventListener('change', imageFileChangeHandler);
          imageFile.addEventListener('change', imageFileChangeHandler);
        }
        if (confirmUpload) {
          confirmUpload.removeEventListener('click', confirmUploadHandler);
          confirmUpload.addEventListener('click', confirmUploadHandler);
        }

        // =================================================================
        // =========== è¡¨æƒ…å’Œå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ (ç»“æŸ) ============================
        // =================================================================

        // æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°ç•Œé¢
        function displayMessage(message, isHistory = false) {
          const chatMessages = document.getElementById("chatMessages");
          // FIX: Compare username, not userId, as that's what's stored from login
          const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
          const currentUsername = currentUser.username;
          
          const senderName = message.fromName || message.username || "æœªçŸ¥ç”¨æˆ·";
          const messageClass = senderName === currentUsername ? "sent" : "received";
          
          const content = message.content || message.text;
          const isImage = message.type === 'image' || (typeof content === 'string' && content.startsWith('/uploads/images/'));
          const isAudio = message.type === 'audio';

          const avatarUrl = generateAvatarUrl(senderName);
          const timestamp = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          
          let processedContent;
          if (isImage) {
            processedContent = content;
          } else if (isAudio) {
            // åˆ›å»ºéŸ³é¢‘æ’­æ”¾æ§ä»¶
            processedContent = `<div class="audio-message"><i class="bi bi-mic-fill me-2"></i><audio controls style="max-width: 200px;"><source src="${content}" type="audio/webm">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾</audio></div>`;
          } else {
            processedContent = DOMPurify.sanitize(content, { USE_PROFILES: { html: true } });
          }

          // æ£€æŸ¥æ˜¯å¦å¤„äºç®€æ´æ¨¡å¼
          const isSimpleMode = chatMessages.classList.contains('simple-mode');
          
          let messageHtml;
          if (isSimpleMode) {
            // ç®€æ´æ¨¡å¼ï¼šæ˜¾ç¤ºå‘é€è€…åç§° + æ¶ˆæ¯å†…å®¹ + æ—¶é—´
            const userInfo = `${senderName} (${message.role || 'æœªçŸ¥è§’è‰²'} | ${message.country || 'æœªçŸ¥å›½å®¶'})`;
            messageHtml = `<div class="chat-message ${messageClass}" data-message-id="${message.id}"><span class="message-sender">${userInfo}:</span><div class="message-bubble"><div class="message-content">${isImage ? `<img src="${processedContent}" alt="Image" class="img-fluid rounded" style="max-height: 80px;">` : processedContent}</div></div><span class="message-time">${timestamp}</span></div>`;
          } else {
            // æ°”æ³¡æ¨¡å¼ï¼šåŸæœ‰çš„æ°”æ³¡æ ·å¼
            messageHtml = `<div class="chat-message ${messageClass}" data-message-id="${message.id}"><div class="message-meta"><img src="${avatarUrl}" alt="${senderName}" class="avatar"><span class="message-sender">${senderName}</span></div><div class="message-bubble"><div class="message-content">${isImage ? `<img src="${processedContent}" alt="Image" class="img-fluid rounded">` : processedContent}<span class="message-time">${timestamp}</span></div></div></div>`;
          }
          
          const messageElement = document.createElement('div');
          messageElement.innerHTML = messageHtml.trim();
          const finalElement = messageElement.firstElementChild;

          if (isHistory) {
            finalElement.style.animation = 'none';
            finalElement.style.opacity = '1';
            chatMessages.appendChild(finalElement);
          } else {
            chatMessages.appendChild(finalElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        }
        
        // æ›´æ–°ç³»ç»Ÿæ¶ˆæ¯æ ·å¼
        function displaySystemMessage(message) {
          const chatMessages = document.getElementById('chatMessages');
          if (!chatMessages) return;
          const systemMsg = document.createElement('div');
          systemMsg.className = 'system-message';
          systemMsg.innerHTML = `<span>${DOMPurify.sanitize(message)}</span>`;
          chatMessages.appendChild(systemMsg);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
        function updateUserList(users) {
          const userList = document.getElementById('userList');
          if (!userList) return;
          userList.innerHTML = '';
          for (const user of users) {
            const userItem = document.createElement('li');
            userItem.className = 'list-group-item d-flex align-items-center p-2';
            userItem.style.minWidth = '280px';
            userItem.style.marginRight = '0.5rem';
            userItem.style.marginBottom = '0.5rem';
            userItem.style.borderRadius = '0.5rem';
            
            // ç”¨æˆ·å¤´åƒ
            const userAvatar = document.createElement('div');
            userAvatar.className = 'me-2';
            userAvatar.innerHTML = `
              <img src="${generateAvatarUrl(user.name)}" alt="${user.name}" class="rounded-circle" style="width:32px; height:32px;">
            `;
            
            // ç”¨æˆ·çŠ¶æ€æŒ‡ç¤ºå™¨
            const statusIndicator = document.createElement('span');
            statusIndicator.className = 'user-status-indicator user-status-online me-2';
            statusIndicator.style.width = '8px';
            statusIndicator.style.height = '8px';
            statusIndicator.style.borderRadius = '50%';
            statusIndicator.style.backgroundColor = '#28a745';
            
            // ç”¨æˆ·ä¿¡æ¯
            const userInfo = document.createElement('div');
            userInfo.className = 'flex-grow-1';
            
            const userName = document.createElement('div');
            userName.className = 'fw-bold';
            userName.textContent = user.name;
            userName.style.fontSize = '0.9rem';
            
            const userDetails = document.createElement('div');
            userDetails.className = 'text-muted';
            userDetails.style.fontSize = '0.75rem';
            userDetails.textContent = `${user.role} | ${user.country || 'æœªçŸ¥'}`;
            
            userInfo.appendChild(userName);
            userInfo.appendChild(userDetails);
            
            // çŠ¶æ€å›¾æ ‡å®¹å™¨
            const statusIcons = document.createElement('div');
            statusIcons.className = 'd-flex align-items-center gap-1';
            
            // ä¸¾æ‰‹çŠ¶æ€ - ä½¿ç”¨æ›´å¥½çš„å›¾æ ‡
            if (user.isRaisingHand) {
              const raiseHandIcon = document.createElement('i');
              raiseHandIcon.className = 'bi bi-hand-index text-warning';
              raiseHandIcon.style.fontSize = '1.1rem';
              raiseHandIcon.title = 'æ­£åœ¨ä¸¾æ‰‹';
              statusIcons.appendChild(raiseHandIcon);
            }
            
            // å‘è¨€çŠ¶æ€
            if (user.isSpeaking) {
              const speakingIcon = document.createElement('i');
              speakingIcon.className = 'bi bi-mic text-primary';
              speakingIcon.style.fontSize = '1.1rem';
              speakingIcon.title = 'æ­£åœ¨å‘è¨€';
              statusIcons.appendChild(speakingIcon);
            }
            
            // é™éŸ³çŠ¶æ€
            if (user.isMuted) {
              const mutedIcon = document.createElement('i');
              mutedIcon.className = 'bi bi-mic-mute text-danger';
              mutedIcon.style.fontSize = '1.1rem';
              mutedIcon.title = 'å·²é™éŸ³';
              statusIcons.appendChild(mutedIcon);
            }
            
            // åœ¨çº¿çŠ¶æ€
            if (user.isOnline) {
              const onlineIcon = document.createElement('i');
              onlineIcon.className = 'bi bi-circle text-success';
              onlineIcon.style.fontSize = '0.8rem';
              onlineIcon.title = 'åœ¨çº¿';
              statusIcons.appendChild(onlineIcon);
            }
            
            userItem.appendChild(userAvatar);
            userItem.appendChild(statusIndicator);
            userItem.appendChild(userInfo);
            userItem.appendChild(statusIcons);
            userList.appendChild(userItem);
          }
        }

        // å€’è®¡æ—¶åŠŸèƒ½
        let timerInterval = null;
        let timerRunning = false;
        let remainingTime = 0;

        // æ›´æ–°å€’è®¡æ—¶æŒ‰é’®æ˜¾ç¤º
        function updateTimerButtons() {
      const startBtn = document.getElementById('startTimerBtn');
      const pauseBtn = document.getElementById('pauseTimerBtn');
      const resumeBtn = document.getElementById('resumeTimerBtn');
      const resetBtn = document.getElementById('resetTimerBtn');
          const timeInputGroup = document.getElementById('timeInputGroup');
          
          if (timerRunning) {
            // è®¡æ—¶å™¨è¿è¡Œä¸­
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'inline-block';
            resumeBtn.style.display = 'none';
            timeInputGroup.style.display = 'none';
          } else if (remainingTime > 0) {
            // è®¡æ—¶å™¨æš‚åœ
            startBtn.style.display = 'none';
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'inline-block';
            timeInputGroup.style.display = 'none';
          } else {
            // è®¡æ—¶å™¨æœªå¼€å§‹
            startBtn.style.display = 'inline-block';
            pauseBtn.style.display = 'none';
            resumeBtn.style.display = 'none';
            timeInputGroup.style.display = 'flex';
          }
        }

        // å¼€å§‹å€’è®¡æ—¶
        document.getElementById('startTimerBtn').addEventListener('click', () => {
          const hours = parseInt(document.getElementById('timerHours').value) || 0;
          const minutes = parseInt(document.getElementById('timerMinutes').value) || 0;
          const seconds = parseInt(document.getElementById('timerSeconds').value) || 0;
          
          const totalSeconds = hours * 3600 + minutes * 60 + seconds;
          if (totalSeconds <= 0) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é—´');
          return;
        }
        
          remainingTime = totalSeconds;
          timerRunning = true;
          updateTimerDisplay(remainingTime);
          updateTimerButtons();
          
          timerInterval = setInterval(() => {
            remainingTime--;
            updateTimerDisplay(remainingTime);
            
            if (remainingTime <= 0) {
              clearInterval(timerInterval);
              timerRunning = false;
              updateTimerButtons();
              alert('æ—¶é—´åˆ°ï¼');
            }
          }, 1000);
          
          // å‘é€åˆ°æœåŠ¡å™¨
          ws.send(JSON.stringify({ type: 'timer', action: 'start', time: totalSeconds }));
        });

        // æš‚åœå€’è®¡æ—¶
        document.getElementById('pauseTimerBtn').addEventListener('click', () => {
          if (timerRunning) {
            clearInterval(timerInterval);
            timerRunning = false;
            updateTimerButtons();
            ws.send(JSON.stringify({ type: 'timer', action: 'pause' }));
          }
        });

        // ç»§ç»­å€’è®¡æ—¶
        document.getElementById('resumeTimerBtn').addEventListener('click', () => {
          if (!timerRunning && remainingTime > 0) {
            timerRunning = true;
            updateTimerButtons();
            timerInterval = setInterval(() => {
              remainingTime--;
              updateTimerDisplay(remainingTime);
              
              if (remainingTime <= 0) {
                clearInterval(timerInterval);
                timerRunning = false;
                updateTimerButtons();
                alert('æ—¶é—´åˆ°ï¼');
              }
            }, 1000);
            ws.send(JSON.stringify({ type: 'timer', action: 'resume' }));
          }
        });

        // é‡ç½®å€’è®¡æ—¶
        document.getElementById('resetTimerBtn').addEventListener('click', () => {
          clearInterval(timerInterval);
          timerRunning = false;
          remainingTime = 0;
          updateTimerDisplay(0);
          updateTimerButtons();
          ws.send(JSON.stringify({ type: 'timer', action: 'reset' }));
        });

        // åˆå§‹åŒ–æŒ‰é’®æ˜¾ç¤º
        updateTimerButtons();

        // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
        function updateTimerDisplay(seconds) {
          const hours = Math.floor(seconds / 3600);
          const minutes = Math.floor((seconds % 3600) / 60);
          const secs = seconds % 60;
          
          const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
          document.getElementById('timerDisplay').textContent = display;
        }

        // éŸ³é¢‘å¤„ç†å‡½æ•°
        function handleAudioData(audioData) {
          // å¤„ç†éŸ³é¢‘æ•°æ®çš„é€»è¾‘
          console.log('æ”¶åˆ°éŸ³é¢‘æ•°æ®:', audioData.byteLength, 'bytes');
          
          // åˆ›å»ºéŸ³é¢‘å…ƒç´ å¹¶æ’­æ”¾
          const audioBlob = new Blob([audioData], { type: 'audio/wav' });
          const audioUrl = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioUrl);
          
          audio.onloadedmetadata = () => {
            console.log('éŸ³é¢‘æ—¶é•¿:', audio.duration, 'ç§’');
          };
          
          audio.onerror = (error) => {
            console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', error);
          };
          
          audio.play().catch(error => {
            console.error('æ— æ³•æ’­æ”¾éŸ³é¢‘:', error);
          });
          
          // æ¸…ç†URLå¯¹è±¡
          audio.onended = () => {
            URL.revokeObjectURL(audioUrl);
          };
        }

        // å¤„ç†éŸ³é¢‘æ¶ˆæ¯
        function handleAudioMessage(message) {
          console.log('æ”¶åˆ°éŸ³é¢‘æ¶ˆæ¯:', message);
          
          // æ˜¾ç¤ºéŸ³é¢‘æ¶ˆæ¯åœ¨èŠå¤©ä¸­
          const audioMessage = {
            id: message.id || Date.now(),
            type: 'audio',
            content: message.audioUrl || message.content,
            fromName: message.fromName || message.userName || 'æœªçŸ¥ç”¨æˆ·',
            timestamp: message.timestamp || new Date().toISOString(),
            role: message.role,
            country: message.country
          };
          
          displayMessage(audioMessage);
        }

        // è¯­éŸ³èŠå¤©åŠŸèƒ½
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        document.getElementById('startAudioBtn').addEventListener('click', async () => {
          if (isRecording) return;
          
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
              audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
              } 
            });
            
            mediaRecorder = new MediaRecorder(stream, {
              mimeType: 'audio/webm;codecs=opus'
            });
            
            mediaRecorder.ondataavailable = (event) => {
              if (event.data.size > 0) {
                audioChunks.push(event.data);
              }
            };
            
            mediaRecorder.onstop = async () => {
              try {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                console.log('å½•éŸ³å®Œæˆï¼Œå¤§å°:', audioBlob.size, 'bytes');
                
                // å‘é€éŸ³é¢‘æ•°æ®åˆ°æœåŠ¡å™¨
                ws.send(audioBlob);
                
                // åŒæ—¶å‘é€éŸ³é¢‘æ¶ˆæ¯é€šçŸ¥
                ws.send(JSON.stringify({
                  type: 'audio_notification',
                  timestamp: new Date().toISOString(),
                  size: audioBlob.size
                }));
                
                audioChunks = [];
                isRecording = false;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('startAudioBtn').style.display = 'inline-block';
                document.getElementById('stopAudioBtn').style.display = 'none';
                
              } catch (error) {
                console.error('å¤„ç†å½•éŸ³æ•°æ®æ—¶å‡ºé”™:', error);
                alert('å½•éŸ³å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
              }
            };
            
            mediaRecorder.onerror = (event) => {
              console.error('å½•éŸ³é”™è¯¯:', event.error);
              alert('å½•éŸ³å‡ºé”™: ' + event.error.message);
              isRecording = false;
            };
            
            // å¼€å§‹å½•éŸ³
            mediaRecorder.start(1000); // æ¯ç§’æ”¶é›†ä¸€æ¬¡æ•°æ®
            isRecording = true;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('startAudioBtn').style.display = 'none';
            document.getElementById('stopAudioBtn').style.display = 'inline-block';
            
            console.log('å¼€å§‹å½•éŸ³...');
            
          } catch (error) {
            console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
            if (error.name === 'NotAllowedError') {
              alert('è¯·å…è®¸è®¿é—®éº¦å…‹é£ä»¥ä½¿ç”¨è¯­éŸ³èŠå¤©åŠŸèƒ½');
            } else if (error.name === 'NotFoundError') {
              alert('æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥');
            } else {
              alert('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
            }
          }
        });

        document.getElementById('stopAudioBtn').addEventListener('click', () => {
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            console.log('åœæ­¢å½•éŸ³...');
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
          }
        });

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ 
        function updateUserInfoBar() {
          const currentUserName = document.getElementById('currentUserName');
          const currentUserInfo = document.getElementById('currentUserInfo');
          const userStatusBadge = document.getElementById('userStatusBadge');
          const currentUserAvatar = document.getElementById('currentUserAvatar');
          
          if (currentUserName) {
            currentUserName.textContent = user.username;
          }
          if (currentUserInfo) {
            currentUserInfo.textContent = `${roleMap[user.role] || user.role} | ${user.country || 'æœªçŸ¥'}`;
          }
          if (userStatusBadge) {
            userStatusBadge.textContent = 'åœ¨çº¿';
            userStatusBadge.className = 'badge bg-success';
          }
          if (currentUserAvatar) {
            currentUserAvatar.src = generateAvatarUrl(user.username, 40);
          }
        }
        
        // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯æ 
        updateUserInfoBar();

        // æˆ¿é—´ç®¡ç†åŠŸèƒ½
        document.getElementById('roomManagementBtn').addEventListener('click', async function() {
          try {
            const response = await fetch(`/api/rooms/${encodeURIComponent(roomId)}`, {
              headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
              }
            });
            
            if (response.ok) {
              const roomData = await response.json();
              
              // åˆ›å»ºç®¡ç†é€‰é¡¹å¯¹è¯æ¡†
              const managementOptions = [
                `æˆ¿é—´åç§°ï¼š${roomData.name}`,
                `æˆ¿é—´IDï¼š${roomData.id}`,
                `å‚ä¸è€…æ•°é‡ï¼š${roomData.participants.length}äºº`,
                '',
                'ç®¡ç†é€‰é¡¹ï¼š',
                '1. æŸ¥çœ‹å‚ä¸è€…åˆ—è¡¨',
                '2. ä¿®æ”¹æˆ¿é—´è®¾ç½®',
                '3. å¯¼å‡ºèŠå¤©è®°å½•',
                '4. æ¸…ç©ºèŠå¤©è®°å½•'
              ].join('\n');
              
              const choice = prompt(managementOptions + '\n\nè¯·è¾“å…¥é€‰é¡¹ç¼–å·ï¼ˆ1-4ï¼‰ï¼š');
              
              switch(choice) {
                case '1':
                  const participantsList = roomData.participants.map(p => 
                    `${p.name} (${p.role} | ${p.country || 'æœªçŸ¥'})`
                  ).join('\n');
                  alert('å‚ä¸è€…åˆ—è¡¨ï¼š\n' + participantsList);
                  break;
                case '2':
                  alert('æˆ¿é—´è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...');
                  break;
                case '3':
                  alert('å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...');
                  break;
                case '4':
                  if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    // è¿™é‡Œå¯ä»¥æ·»åŠ æ¸…ç©ºèŠå¤©è®°å½•çš„APIè°ƒç”¨
                    alert('æ¸…ç©ºåŠŸèƒ½å¼€å‘ä¸­...');
                  }
                  break;
                default:
                  alert('æ— æ•ˆé€‰é¡¹');
              }
            } else {
              alert('è·å–æˆ¿é—´ä¿¡æ¯å¤±è´¥');
            }
          } catch (error) {
            console.error('æˆ¿é—´ç®¡ç†é”™è¯¯:', error);
            alert('æˆ¿é—´ç®¡ç†åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨');
          }
        });

        // åˆ é™¤æˆ¿é—´åŠŸèƒ½
        document.getElementById('deleteRoomBtn').addEventListener('click', async function() {
          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç ”è®¨å®¤å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
            return;
          }
          
          try {
            const response = await fetch(`/api/rooms/${encodeURIComponent(roomId)}`, {
              method: 'DELETE',
              headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
              }
            });
            
            if (response.ok) {
              alert('ç ”è®¨å®¤å·²åˆ é™¤');
              window.location.href = '/rooms';
            } else {
              alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™');
            }
          } catch (error) {
            console.error('åˆ é™¤æˆ¿é—´é”™è¯¯:', error);
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
          }
        });

        // æ›´æ–°å‘è¨€çŠ¶æ€åŠŸèƒ½
        function updateSpeakingStatus(userId, isSpeaking) {
          // æ›´æ–°ç”¨æˆ·åˆ—è¡¨ä¸­çš„å‘è¨€çŠ¶æ€
          const userItems = document.querySelectorAll('#userList .list-group-item');
          userItems.forEach(item => {
            const userName = item.querySelector('.fw-bold').textContent;
            // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…æ•°æ®ç»“æ„æ¥åŒ¹é…ç”¨æˆ·
            // æš‚æ—¶ç®€åŒ–å¤„ç†
          });
        }

        // =================================================================
        // =========== æ‰€æœ‰åŠŸèƒ½åˆå§‹åŒ–å…¥å£ =================================
        // =================================================================
        initializeRoomFeatures(roomId, user, ws);
        // =================================================================

      } catch (error) {
        console.error('åˆå§‹åŒ–é”™è¯¯:', error);
        alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
      }
    })();

    /**
     * åˆå§‹åŒ–æˆ¿é—´çš„æ‰€æœ‰äº¤äº’åŠŸèƒ½
     * @param {string} roomId å½“å‰æˆ¿é—´ID
     * @param {object} user å½“å‰ç”¨æˆ·ä¿¡æ¯
     * @param {WebSocket} ws WebSocketå®ä¾‹
     */
    function initializeRoomFeatures(roomId, user, ws) {
      console.log("Initializing all room features...");

      // ------------------ å‘é€æ¶ˆæ¯é€»è¾‘ ------------------
      document.getElementById('sendBtn').addEventListener('click', sendChatMessage);
      document.getElementById('messageInput').addEventListener('keydown', e => {
        const sendMode = document.querySelector('input[name="sendMode"]:checked').value;
        if ((sendMode === 'enter' && e.key === 'Enter' && !e.shiftKey) ||
            (sendMode === 'ctrlEnter' && e.key === 'Enter' && e.ctrlKey)) {
          e.preventDefault();
          sendChatMessage();
        }
      });
      function sendChatMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        if (!message) return;
        ws.send(JSON.stringify({ type: 'chat', content: message }));
        messageInput.value = '';
      }

      // ------------------ è§†å›¾åˆ‡æ¢ ------------------
      const viewSwitch = document.getElementById('viewSwitch');
      const chatMessages = document.getElementById('chatMessages');
      const isSimpleMode = localStorage.getItem('simpleMode') === 'true';
      viewSwitch.checked = isSimpleMode;
      function toggleView() {
        chatMessages.classList.toggle('simple-mode', viewSwitch.checked);
        localStorage.setItem('simpleMode', String(viewSwitch.checked));
      }
      toggleView();
      viewSwitch.addEventListener('change', toggleView);

      // ------------------ è¡¨æƒ…åŠŸèƒ½ ------------------
      const emojiBtn = document.getElementById('emojiBtn');
      const emojiPanel = document.getElementById('emojiPanel');
      const emojiGrid = document.getElementById('emojiGrid');
      const closeEmojiPanel = document.getElementById('closeEmojiPanel');
      const emojis = ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£', 'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬', 'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—', 'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¯', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤', 'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ‘', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ”¥', 'ğŸ‰', 'âœ¨', 'â­', 'â¤ï¸', 'ğŸ’¯'];
      
      function initEmojiPanel() {
        emojiGrid.innerHTML = '';
        emojis.forEach(emoji => {
          const btn = document.createElement('button');
          btn.className = 'btn btn-sm btn-outline-secondary border-0';
          btn.textContent = emoji;
          btn.style.fontSize = '1.2rem';
          btn.onclick = () => {
            const input = document.getElementById('messageInput');
            const cursorPos = input.selectionStart;
            input.value = input.value.substring(0, cursorPos) + emoji + input.value.substring(cursorPos);
            input.focus();
            input.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
          };
          emojiGrid.appendChild(btn);
        });
      }

      emojiBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log("Emoji button clicked!");
        const isHidden = emojiPanel.style.display === 'none' || !emojiPanel.style.display;
        if (isHidden) {
          initEmojiPanel();
          emojiPanel.style.display = 'block';
          document.getElementById('imageUploadArea').style.display = 'none';
        } else {
          emojiPanel.style.display = 'none';
        }
      });
      closeEmojiPanel.addEventListener('click', () => emojiPanel.style.display = 'none');

      // ------------------ å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ ------------------
      const imageBtn = document.getElementById('imageBtn');
      const imageUploadArea = document.getElementById('imageUploadArea');
      const closeImageUpload = document.getElementById('closeImageUpload');
      const imageFile = document.getElementById('imageFile');
      const imagePreviewContainer = document.getElementById('imagePreviewContainer');
      const imagePreview = document.getElementById('imagePreview');
      const cancelUpload = document.getElementById('cancelUpload');
      const confirmUpload = document.getElementById('confirmUpload');
      let selectedFile = null;

      function resetImageUpload() {
        imageUploadArea.style.display = 'none';
        imageFile.value = '';
        imagePreviewContainer.style.display = 'none';
        confirmUpload.disabled = true;
        selectedFile = null;
      }

      imageBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log("Image button clicked!");
        const isHidden = imageUploadArea.style.display === 'none' || !imageUploadArea.style.display;
        if (isHidden) {
          imageUploadArea.style.display = 'block';
          document.getElementById('emojiPanel').style.display = 'none';
        } else {
          imageUploadArea.style.display = 'none';
        }
      });
      
      closeImageUpload.addEventListener('click', resetImageUpload);
      cancelUpload.addEventListener('click', resetImageUpload);

      imageFile.addEventListener('change', () => {
        selectedFile = imageFile.files[0];
        if (selectedFile) {
          const reader = new FileReader();
          reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreviewContainer.style.display = 'block';
            confirmUpload.disabled = false;
          };
          reader.readAsDataURL(selectedFile);
        }
      });

      confirmUpload.addEventListener('click', async () => {
        if (!selectedFile) return;
        const formData = new FormData();
        formData.append('image', selectedFile);
        formData.append('roomId', roomId);
        try {
          confirmUpload.disabled = true;
          confirmUpload.textContent = 'ä¸Šä¼ ä¸­...';
          const res = await fetch('/api/images/upload', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
            body: formData,
          });
          if (!res.ok) throw new Error((await res.json()).error || 'Upload failed');
          const result = await res.json();
          ws.send(JSON.stringify({
            type: 'image',
            content: result.imageUrl,
            timestamp: new Date().toISOString()
          }));
          resetImageUpload();
        } catch (error) {
          console.error('Image upload error:', error);
          alert(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`);
        } finally {
          confirmUpload.disabled = false;
          confirmUpload.textContent = 'ä¸Šä¼ ';
        }
      });

      // ------------------ ä¸¾æ‰‹åŠŸèƒ½ ------------------
      const raiseHandBtn = document.getElementById('raiseHandBtn');
      let isRaisingHand = false;
      raiseHandBtn.addEventListener('click', () => {
        isRaisingHand = !isRaisingHand;
        raiseHandBtn.textContent = isRaisingHand ? 'æ”¾ä¸‹æ‰‹' : 'ä¸¾æ‰‹';
        raiseHandBtn.classList.toggle('btn-success', isRaisingHand);
        raiseHandBtn.classList.toggle('btn-warning', !isRaisingHand);
        ws.send(JSON.stringify({ type: 'raiseHand', isRaising: isRaisingHand }));
        console.log(`ä¸¾æ‰‹çŠ¶æ€å‘é€: ${isRaisingHand}`);
      });
      
      // ... (æ­¤å¤„å¯ä»¥æ·»åŠ å…¶ä»–åŠŸèƒ½çš„åˆå§‹åŒ–ä»£ç , å¦‚æˆ¿é—´ç®¡ç†ã€åˆ é™¤ç­‰)

      // ------------------ ç‚¹å‡»å¤–éƒ¨å…³é—­é¢æ¿ ------------------
      document.addEventListener('click', (e) => {
        if (emojiPanel && !emojiPanel.contains(e.target) && !emojiBtn.contains(e.target)) {
          emojiPanel.style.display = 'none';
        }
        if (imageUploadArea && !imageUploadArea.contains(e.target) && !imageBtn.contains(e.target)) {
          imageUploadArea.style.display = 'none';
        }
      });

      console.log("All room features initialized.");
    }
  </script>
</body>
</html> 